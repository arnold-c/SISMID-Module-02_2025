<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Callum Arnold">
<meta name="author" content="Matthew Ferrari">
<title>8&nbsp; R Session 03 – SISMID Module 1 Materials (2025)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./L08_stochastic-models.html" rel="next">
<link href="./L06_parameter-estimation.html" rel="prev">
<link href="././images/sismid2025-logo-blue.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-71f524eee1dc5ed9e55699206ad9d6f5.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-4c0fb4a9f49e9c425cadb25d7a35c2be.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-71f524eee1dc5ed9e55699206ad9d6f5.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "?",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "[s|?] Search Contents",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EVYBCCRZHE"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-EVYBCCRZHE', { 'anonymize_ip': true});
</script><script type="module" src="site_libs/quarto-ojs/quarto-ojs-runtime.js"></script><link href="site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">
<script type="ojs-define">
{"contents":[{"name":"niamey_data","value":{"Biweek":[1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7,8,8,8,9,9,9,10,10,10,11,11,11,12,12,12,13,13,13,14,14,14,15,15,15,16,16,16],"site":["Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3","Site 1","Site 2","Site 3"],"Number of Individuals":[22,1,0,27,2,0,64,7,0,84,4,2,116,20,0,172,38,4,173,125,3,651,290,20,786,519,49,1041,874,81,842,810,116,903,702,164,745,636,159,211,213,33,83,71,16,11,34,5]}}]}
</script><script>
  window.MathJax = {
    loader: {
      load: ['[tex]/physics']
    },
    tex: {
      packages: {'[+]': ['physics']}
    }
  };
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./L05_age-structure.html">Day 2</a></li><li class="breadcrumb-item"><a href="./r-session-03.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">R Session 03</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="././images/sismid2025-logo-blue.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none"></a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">SISMID Module 1 Materials (2025)</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/arnold-c/SISMID-Module-02_2025" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Welcome</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./schedule.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Workshop Schedule</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Pre-Requisites</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exercise-requirements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exercise Requirements</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./install-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install and Setup R &amp; RStudio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./just-enough-rstudio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Just Enough RStudio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./just-enough-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Just Enough R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./project-management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Organizing A Project</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Day 1</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L01_intro-to-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Intro to Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L02_sir-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basics of SIR Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-session-01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R Session 01</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L03_hit-and-vaccinations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Herd Immunity &amp; Vaccination</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Day 2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L05_age-structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Heterogeneity and Age Structure</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-session-02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R Session 02</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L06_parameter-estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Parameter Estimation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-session-03.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">R Session 03</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Day 3</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L08_stochastic-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Stochastic Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-session-04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">R Session 04</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>References</strong></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Page Items</h2>
   
  <ul>
<li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup"><span class="header-section-number">8.1</span> Setup</a></li>
  <li><a href="#estimating-r_0-problem-background" id="toc-estimating-r_0-problem-background" class="nav-link" data-scroll-target="#estimating-r_0-problem-background"><span class="header-section-number">8.2</span> Estimating <span class="math inline">\(R_0\)</span> Problem Background</a></li>
  <li>
<a href="#estimating-r_0-from-the-final-outbreak-size" id="toc-estimating-r_0-from-the-final-outbreak-size" class="nav-link" data-scroll-target="#estimating-r_0-from-the-final-outbreak-size"><span class="header-section-number">8.3</span> Estimating <span class="math inline">\(R_0\)</span> From The Final Outbreak Size</a>
  <ul class="collapse">
<li><a href="#exercise-1" id="toc-exercise-1" class="nav-link" data-scroll-target="#exercise-1"><span class="header-section-number">8.3.1</span> Exercise 1</a></li>
  </ul>
</li>
  <li>
<a href="#linear-approximation" id="toc-linear-approximation" class="nav-link" data-scroll-target="#linear-approximation"><span class="header-section-number">8.4</span> Linear Approximation</a>
  <ul class="collapse">
<li><a href="#exercise-2" id="toc-exercise-2" class="nav-link" data-scroll-target="#exercise-2"><span class="header-section-number">8.4.1</span> Exercise 2</a></li>
  <li><a href="#exercise-3" id="toc-exercise-3" class="nav-link" data-scroll-target="#exercise-3"><span class="header-section-number">8.4.2</span> Exercise 3</a></li>
  <li><a href="#exercise-4" id="toc-exercise-4" class="nav-link" data-scroll-target="#exercise-4"><span class="header-section-number">8.4.3</span> Exercise 4</a></li>
  </ul>
</li>
  <li><a href="#estimating-dynamical-parameters-with-least-squares" id="toc-estimating-dynamical-parameters-with-least-squares" class="nav-link" data-scroll-target="#estimating-dynamical-parameters-with-least-squares"><span class="header-section-number">8.5</span> Estimating dynamical parameters with least squares</a></li>
  <li><a href="#dynamical-model" id="toc-dynamical-model" class="nav-link" data-scroll-target="#dynamical-model"><span class="header-section-number">8.6</span> Dynamical Model</a></li>
  <li><a href="#interactive-optimization" id="toc-interactive-optimization" class="nav-link" data-scroll-target="#interactive-optimization"><span class="header-section-number">8.7</span> Interactive Optimization</a></li>
  <li><a href="#objective-function" id="toc-objective-function" class="nav-link" data-scroll-target="#objective-function"><span class="header-section-number">8.8</span> Objective Function</a></li>
  <li>
<a href="#optimization" id="toc-optimization" class="nav-link" data-scroll-target="#optimization"><span class="header-section-number">8.9</span> Optimization</a>
  <ul class="collapse">
<li><a href="#exercise-5" id="toc-exercise-5" class="nav-link" data-scroll-target="#exercise-5"><span class="header-section-number">8.9.1</span> Exercise 5</a></li>
  <li><a href="#exercise-6" id="toc-exercise-6" class="nav-link" data-scroll-target="#exercise-6"><span class="header-section-number">8.9.2</span> Exercise 6</a></li>
  </ul>
</li>
  <li>
<a href="#solutions" id="toc-solutions" class="nav-link" data-scroll-target="#solutions"><span class="header-section-number">8.10</span> Solutions</a>
  <ul class="collapse">
<li><a href="#exercise-1-1" id="toc-exercise-1-1" class="nav-link" data-scroll-target="#exercise-1-1"><span class="header-section-number">8.10.1</span> Exercise 1</a></li>
  <li><a href="#exercise-2-1" id="toc-exercise-2-1" class="nav-link" data-scroll-target="#exercise-2-1"><span class="header-section-number">8.10.2</span> Exercise 2</a></li>
  <li><a href="#exercise-3-1" id="toc-exercise-3-1" class="nav-link" data-scroll-target="#exercise-3-1"><span class="header-section-number">8.10.3</span> Exercise 3</a></li>
  <li><a href="#exercise-4-1" id="toc-exercise-4-1" class="nav-link" data-scroll-target="#exercise-4-1"><span class="header-section-number">8.10.4</span> Exercise 4</a></li>
  <li><a href="#exercise-5-1" id="toc-exercise-5-1" class="nav-link" data-scroll-target="#exercise-5-1"><span class="header-section-number">8.10.5</span> Exercise 5</a></li>
  <li><a href="#exercise-6-1" id="toc-exercise-6-1" class="nav-link" data-scroll-target="#exercise-6-1"><span class="header-section-number">8.10.6</span> Exercise 6</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/arnold-c/SISMID-Module-02_2025/edit/main/r-session-03.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./L05_age-structure.html">Day 2</a></li><li class="breadcrumb-item"><a href="./r-session-03.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">R Session 03</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">8</span>&nbsp; <span class="chapter-title">R Session 03</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Estimation</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://callumarnold.com">Callum Arnold</a> <a href="https://orcid.org/0000-0002-3245-6956" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Pennsylvania State University
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="http://theferrarilab.com">Matthew Ferrari</a> <a href="https://orcid.org/0000-0001-5251-8168" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            The Pennsylvania State University
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title"></div>
    <p><em>Materials adapted from John Drake and Pej Rohani <span class="citation" data-cites="drakeEstimation2019">(<a href="references.html#ref-drakeEstimation2019" role="doc-biblioref">Drake and Rohani 2019</a>)</span></em></p>
  </div>
</div>


</header><section id="setup" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="setup">
<span class="header-section-number">8.1</span> Setup</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(rio)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(deSolve)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">library</span>(ggtext)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">library</span>(gt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb2" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Loads the datasets: flu, measles, niamey, plauge</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>flu <span class="ot">&lt;-</span> rio<span class="sc">::</span><span class="fu">import</span>(</span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="st">"https://raw.githubusercontent.com/arnold-c/SISMID-Module-02_2025/main/data/flu.csv"</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>)</span>
<span id="cb3-5"><a href="#cb3-5"></a>niamey <span class="ot">&lt;-</span> rio<span class="sc">::</span><span class="fu">import</span>(</span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="st">"https://raw.githubusercontent.com/arnold-c/SISMID-Module-02_2025/main/data/niamey.csv"</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>)</span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co"># flu &lt;- rio::import(here::here("data", "flu.csv"))</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co"># niamey &lt;- rio::import(here::here("data", "niamey.csv"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="estimating-r_0-problem-background" class="level2 page-columns page-full" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="estimating-r_0-problem-background">
<span class="header-section-number">8.2</span> Estimating <span class="math inline">\(R_0\)</span> Problem Background</h2>
<p>So far in this class we have focused on the <strong>theory</strong> of infectious disease. Often, however, we will want to apply this theory to particular situations. One of the key applied problems in epidemic modeling is the estimation of <span class="math inline">\(R_0\)</span> from outbreak data. In this session, we study two methods for estimating <span class="math inline">\(R_0\)</span> from an epidemic curve. As a running example, we will use the data on influenza in a British boarding school.</p>
<div class="cell page-columns page-full">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb4" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">ggplot</span>(flu, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> flu)) <span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"slategray4"</span>) <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">21</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">fill =</span> <span class="st">"slategray4"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Active Influenza Cases"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="r-session-03_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img column-body" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="estimating-r_0-from-the-final-outbreak-size" class="level2" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="estimating-r_0-from-the-final-outbreak-size">
<span class="header-section-number">8.3</span> Estimating <span class="math inline">\(R_0\)</span> From The Final Outbreak Size</h2>
<p>Our first approach is to estimate <span class="math inline">\(R_0\)</span> from the final outbreak size. Although unhelpful at the early stages of an epidemic (before the final epidemic size is observed), this method is nonetheless a useful tool for <em>post hoc</em> analysis. The method is general and can be motivated by the argument listed in <span class="citation" data-cites="keelingIntroductionSimpleEpidemic2008">(<a href="references.html#ref-keelingIntroductionSimpleEpidemic2008" role="doc-biblioref">Keeling and Rohani 2008</a>)</span>:</p>
<p>First, we assume that the epidemic is started by a single infectious individual in a completely susceptible population. On average, this individual infects <span class="math inline">\(R_0\)</span> others. The probability a particular individual escaped infection is therefore <span class="math inline">\(e^{-R_0 / N}\)</span>.</p>
<p>If <span class="math inline">\(Z\)</span> individuals have been infected, the probability of an individual escaping infection from all potential sources is <span class="math inline">\(e^{-Z R_0 / N}\)</span>. It follows that at the end of the epidemic a proportion <span class="math inline">\(R(\infty) = Z / N\)</span> have been infected and the fraction remaining susceptible is <span class="math inline">\(S(\infty) = e^{-R(\infty) R_0}\)</span>, which is equal to <span class="math inline">\(1 - R(\infty)\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><span class="math inline">\(S(\infty) = e^{-R(\infty) R_0}\)</span> can be calculated by acknowledging that at equilibrium (<span class="math inline">\(t = \infty\)</span>), <span class="math inline">\(S(\infty) = 1 - R(\infty) = Z / N\)</span>, so substituting <span class="math inline">\(R(\infty)\)</span> into <span class="math inline">\(1 - e^{-Z R_0 / N}\)</span> gives the desired result.</p>
<p>It could also be calculated by dividing <span class="math inline">\(\frac{\dd{S}}{\dd{t}}\)</span> by <span class="math inline">\(\frac{\dd{R}}{\dd{t}}\)</span>:</p>
<span class="math display">\[\begin{aligned}
\frac{\dd{S}}{\dd{R}} &amp;= - \frac{\beta S}{\gamma} \\
&amp;= - R_0 S
\end{aligned}\]</span>
<p>which is a <a href="https://tutorial.math.lamar.edu/classes/de/separable.aspx">separable differential equation</a>, so can be integrated as follows:</p>
<span class="math display">\[\begin{aligned}
- \int_{0}^{t} \frac{1}{R_0 S} \dd{S} &amp;= \int_{0}^{t} \dd{R} \\
- \frac{1}{R_0} \left(\ln{S(t)} - \ln{S(0)} \right) &amp;= R(t) - \cancelto{0}{R(0)} \\
\ln{S(t)} &amp;= \ln{S(0)} - R_0 R(t) \\
S(t) &amp;= S(0) e^{-R_0 R(t)}

\end{aligned}\]</span>
</div>
</div>
</div>
<p>Putting this together, we get:</p>
<p><span class="math display">\[
1 - R(\infty) - e^{-R(\infty) R_0} = 0
\]</span></p>
<p>Rearranging, we have the estimator</p>
<p><span class="math display">\[
  \hat{R_0} = \frac{\ln(1 - Z / N)}{-Z / N},
\]</span></p>
<p>which, in this case, evaluates to <span class="math inline">\(\frac{\ln(1 - 512 / 764)}{-512 / 764} = 1.655\)</span>.</p>
<section id="exercise-1" class="level3 exercise" data-number="8.3.1"><h3 data-number="8.3.1" class="anchored" data-anchor-id="exercise-1">
<span class="header-section-number">8.3.1</span> Exercise 1</h3>
</section><p>This equation shows the important one-to-one relationship between <span class="math inline">\(R_0\)</span> and the final epidemic size. Plot the relationship between the total epidemic size and <span class="math inline">\(R_0\)</span> for the complete range of values between 0 and 1.</p>
</section><section id="linear-approximation" class="level2" data-number="8.4"><h2 data-number="8.4" class="anchored" data-anchor-id="linear-approximation">
<span class="header-section-number">8.4</span> Linear Approximation</h2>
<p>The next method we introduce takes advantage of the fact that during the early stages of an outbreak, the number of infected individuals is given approximately as <span class="math inline">\(I(t) \approx I_0 e^{((R_0 - 1)(\gamma + \mu)t)}\)</span>. Taking logarithms of both sides, we have <span class="math inline">\(\ln(I(t)) \approx \ln(I_0) + (R_0 - 1)(\gamma + \mu)t\)</span>, showing that the log of the number of infected individuals is approximately linear in time with a slope that reflects both <span class="math inline">\(R_0\)</span> and the recovery rate.</p>
<p>This suggests that a simple linear regression fit to the first several data points on a log-scale, corrected to account for <span class="math inline">\(\gamma\)</span> and <span class="math inline">\(\mu\)</span>, provides a rough and ready estimate of <span class="math inline">\(R_0\)</span>. For flu, we can assume <span class="math inline">\(\mu =0\)</span> because the epidemic occurred over a time period during which natural mortality is negligible. Further, assuming an infectious period of about 2.5 days, we use <span class="math inline">\(\gamma = (2.5)^{-1} = 0.4\)</span> for the correction. Fitting to the first four data points, we obtain the slope as follows.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Fit a linear model</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>linear_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(flu[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">~</span> day[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="at">data =</span> flu)</span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co"># Summary statistics for fit model</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="fu">summary</span>(linear_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>
Call:
lm(formula = log(flu[1:4]) ~ day[1:4], data = flu)

Residuals:
       1        2        3        4 
 0.03073 -0.08335  0.07450 -0.02188 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept) -0.02703    0.10218  -0.265  0.81611   
day[1:4]     1.09491    0.03731  29.346  0.00116 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.08343 on 2 degrees of freedom
Multiple R-squared:  0.9977,    Adjusted R-squared:  0.9965 
F-statistic: 861.2 on 1 and 2 DF,  p-value: 0.001159</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Extract slope parameter</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">coef</span>(linear_model)[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>day[1:4] 
1.094913 </code></pre>
</div>
</div>
<p>Rearranging the linear equation above and denoting the slope coefficient by <span class="math inline">\(\hat \beta_1\)</span> we have the estimator <span class="math inline">\(\hat R_0 = \hat \beta_1 / \gamma + 1\)</span> giving <span class="math inline">\(\hat R_0 = 1.094913 / 0.4 + 1 \approx 3.7\)</span>.</p>
<section id="exercise-2" class="level3 exercise" data-number="8.4.1"><h3 data-number="8.4.1" class="anchored" data-anchor-id="exercise-2">
<span class="header-section-number">8.4.1</span> Exercise 2</h3>
</section><p>Our estimate assumes that boys remained infectious during the natural course of infection. The original report on this epidemic indicates that boys found to have symptoms were immediately confined to bed in the infirmary. The report also indicates that only 1 out of 130 adults at the school exhibited any symptoms. It is reasonable, then, to suppose that transmission in each case ceased once he had been admitted to the infirmary. Supposing admission happened within 24 hours of the onset of symptoms. How does this affect our estimate of <span class="math inline">\(R_0\)</span>? Twelve hours?</p>
<section id="exercise-3" class="level3 exercise" data-number="8.4.2"><h3 data-number="8.4.2" class="anchored" data-anchor-id="exercise-3">
<span class="header-section-number">8.4.2</span> Exercise 3</h3>
</section><p>Biweekly data for outbreaks of measles in three communities in Niamey, Niger are provided in the dataframe <code>niamey</code>. Use this method to obtain estimates of <span class="math inline">\(R_0\)</span> for measles from the first community assuming that the infectious period is approximately two weeks or <span class="math inline">\(\frac{14}{365} \approx 0.0384\)</span> years.</p>
<section id="exercise-4" class="level3 exercise" data-number="8.4.3"><h3 data-number="8.4.3" class="anchored" data-anchor-id="exercise-4">
<span class="header-section-number">8.4.3</span> Exercise 4</h3>
</section><p>A defect with this method is that it uses only a small fraction of the information that might be available, i.e., the first few data points. Indeed, there is nothing in the method that tells one how many data points to use–this is a matter of judgment. Further, there is a tradeoff in that as more and more data points are used the precision of the estimate increases, but this comes at a cost of additional bias. Plot the estimate of <span class="math inline">\(R_0\)</span> obtained from <span class="math inline">\(n=3, 4, 5, ...\)</span> data points against the standard error of the slope from the regression analysis to show this tradeoff.</p>
</section><section id="estimating-dynamical-parameters-with-least-squares" class="level2 page-columns page-full" data-number="8.5"><h2 data-number="8.5" class="anchored" data-anchor-id="estimating-dynamical-parameters-with-least-squares">
<span class="header-section-number">8.5</span> Estimating dynamical parameters with least squares</h2>
<p>The objective of the previous exercise was to estimate <span class="math inline">\(R_0\)</span>. Knowing <span class="math inline">\(R_0\)</span> is critical to understanding the dynamics of any epidemic system. It is, however, a composite quantity and is not sufficient to completely describe the epidemic trajectory. For this, we require estimates for all parameters of the model. In this exercise, we introduce a simple approach to model estimation called <strong>least squares fitting</strong>, sometimes called <strong>trajectory matching</strong>. The basic idea is that we find the values of the model parameters that minimize the squared differences between model predictions and the observed data. To demonstrate least squares fitting, we consider an outbreak of measles in Niamey, Niger, reported on by <span class="citation" data-cites="graisEstimatingTransmissionIntensity2006">(<a href="references.html#ref-graisEstimatingTransmissionIntensity2006" role="doc-biblioref">Grais et al. 2006</a>)</span>.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># Replace an "NA"</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>niamey[<span class="dv">5</span>, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a>niamey_df <span class="ot">&lt;-</span> niamey <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="co"># Rename columns to remove automatic "V1" etc columns names</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="fu">rename_with</span>(., <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Site_"</span>, <span class="fu">str_remove</span>(.x, <span class="st">"V"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="co"># Add a column for the biweekly time period</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="fu">mutate</span>(<span class="at">biweek =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>  <span class="co"># Convert to long format for plotting</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb9-11"><a href="#cb9-11"></a>    <span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"Site"</span>),</span>
<span id="cb9-12"><a href="#cb9-12"></a>    <span class="at">names_to =</span> <span class="st">"site"</span>,</span>
<span id="cb9-13"><a href="#cb9-13"></a>    <span class="at">values_to =</span> <span class="st">"cases"</span></span>
<span id="cb9-14"><a href="#cb9-14"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># Create a vector of colors for each site in the Niamey dataset</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>niamey_site_colors <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>, <span class="st">"Dark2"</span>)</span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co"># Assign names to the colors</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="fu">names</span>(niamey_site_colors) <span class="ot">&lt;-</span> <span class="fu">unique</span>(niamey_df<span class="sc">$</span>site)</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co"># Create a vector of labels for each site for nicer plotting legends</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>niamey_site_labels <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">names</span>(niamey_site_colors), <span class="st">"_"</span>, <span class="st">" "</span>)</span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="fu">names</span>(niamey_site_labels) <span class="ot">&lt;-</span> <span class="fu">names</span>(niamey_site_colors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb11" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb11-2"><a href="#cb11-2"></a>  niamey_df,</span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="fu">aes</span>(<span class="at">x =</span> biweek, <span class="at">y =</span> cases, <span class="at">color =</span> site, <span class="at">fill =</span> site, <span class="at">group =</span> site)</span>
<span id="cb11-4"><a href="#cb11-4"></a>) <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">21</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb11-8"><a href="#cb11-8"></a>    <span class="at">values =</span> niamey_site_colors,</span>
<span id="cb11-9"><a href="#cb11-9"></a>    <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">"color"</span>, <span class="st">"fill"</span>),</span>
<span id="cb11-10"><a href="#cb11-10"></a>    <span class="at">labels =</span> niamey_site_labels</span>
<span id="cb11-11"><a href="#cb11-11"></a>  ) <span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Biweek"</span>, <span class="at">y =</span> <span class="st">"Number of Cases"</span>, <span class="at">fill =</span> <span class="st">"Site Number"</span>) <span class="sc">+</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="r-session-03_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img column-body" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="dynamical-model" class="level2" data-number="8.6"><h2 data-number="8.6" class="anchored" data-anchor-id="dynamical-model">
<span class="header-section-number">8.6</span> Dynamical Model</h2>
<p>First, we write a specialized function for simulating the SIR model in a case where the removal rate is <em>“hard-wired”</em> and with no demography.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb12" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">#' Basic SIR model</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="co">#'</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="co">#' A basic SIR model with no demographic structure to be used in deSolve</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="co">#'</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="co">#' @param time deSolve passes the time parameter to the function.</span></span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="co">#' @param state A vector of states.</span></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="co">#' @param params The beta parameter</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="co">#' @param ... Other arguments passed by deSolve.</span></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="co">#'</span></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="co">#' @return A deSolve matrix of states at each time step.</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="co">#' @examples</span></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="co">#' sir_params &lt;- 0.0005</span></span>
<span id="cb12-13"><a href="#cb12-13"></a><span class="co">#' sir_init_states &lt;- c(S = 5000, I = 1, R = 0)</span></span>
<span id="cb12-14"><a href="#cb12-14"></a><span class="co">#' sim_times &lt;- seq(0, 16 / 365, by = 0.1 / 365)</span></span>
<span id="cb12-15"><a href="#cb12-15"></a><span class="co">#'</span></span>
<span id="cb12-16"><a href="#cb12-16"></a><span class="co">#' sir_sol &lt;- deSolve::ode(</span></span>
<span id="cb12-17"><a href="#cb12-17"></a><span class="co">#'    y = sir_init_states,</span></span>
<span id="cb12-18"><a href="#cb12-18"></a><span class="co">#'    times = sim_times,</span></span>
<span id="cb12-19"><a href="#cb12-19"></a><span class="co">#'    func = closed_sir_model,</span></span>
<span id="cb12-20"><a href="#cb12-20"></a><span class="co">#'    parms = sir_params</span></span>
<span id="cb12-21"><a href="#cb12-21"></a><span class="co">#' ))</span></span>
<span id="cb12-22"><a href="#cb12-22"></a>closed_sir_model <span class="ot">&lt;-</span> <span class="cf">function</span>(time, state, params, ...) {</span>
<span id="cb12-23"><a href="#cb12-23"></a>  <span class="co"># Unpack states</span></span>
<span id="cb12-24"><a href="#cb12-24"></a>  S <span class="ot">&lt;-</span> state[<span class="st">"S"</span>]</span>
<span id="cb12-25"><a href="#cb12-25"></a>  I <span class="ot">&lt;-</span> state[<span class="st">"I"</span>]</span>
<span id="cb12-26"><a href="#cb12-26"></a></span>
<span id="cb12-27"><a href="#cb12-27"></a>  <span class="co"># Unpack parameters</span></span>
<span id="cb12-28"><a href="#cb12-28"></a>  beta <span class="ot">&lt;-</span> params</span>
<span id="cb12-29"><a href="#cb12-29"></a>  dur_inf <span class="ot">&lt;-</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb12-30"><a href="#cb12-30"></a>  gamma <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> dur_inf</span>
<span id="cb12-31"><a href="#cb12-31"></a></span>
<span id="cb12-32"><a href="#cb12-32"></a>  new_inf <span class="ot">&lt;-</span> beta <span class="sc">*</span> S <span class="sc">*</span> I</span>
<span id="cb12-33"><a href="#cb12-33"></a></span>
<span id="cb12-34"><a href="#cb12-34"></a>  <span class="co"># Calculate the ODEs</span></span>
<span id="cb12-35"><a href="#cb12-35"></a>  dSdt <span class="ot">&lt;-</span> <span class="sc">-</span>new_inf</span>
<span id="cb12-36"><a href="#cb12-36"></a>  dIdt <span class="ot">&lt;-</span> new_inf <span class="sc">-</span> (gamma <span class="sc">*</span> I)</span>
<span id="cb12-37"><a href="#cb12-37"></a></span>
<span id="cb12-38"><a href="#cb12-38"></a>  <span class="co"># Return the ODEs</span></span>
<span id="cb12-39"><a href="#cb12-39"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="fu">c</span>(dSdt, dIdt, new_inf)))</span>
<span id="cb12-40"><a href="#cb12-40"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="interactive-optimization" class="level2" data-number="8.7"><h2 data-number="8.7" class="anchored" data-anchor-id="interactive-optimization">
<span class="header-section-number">8.7</span> Interactive Optimization</h2>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb13" data-startfrom="291" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 290;"><span id="cb13-291"><a href="#cb13-291"></a>filtered_niamey_data <span class="op">=</span> aq<span class="op">.</span><span class="fu">table</span>(niamey_data)</span>
<span id="cb13-292"><a href="#cb13-292"></a>    <span class="op">.</span><span class="fu">filter</span>(aq<span class="op">.</span><span class="fu">escape</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">site</span> <span class="op">==</span> site_select))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div id="ojs-cell-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb14" data-startfrom="298" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 297;"><span id="cb14-298"><a href="#cb14-298"></a>reset_S <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb14-299"><a href="#cb14-299"></a>reset_I <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb14-300"><a href="#cb14-300"></a>reset_beta <span class="op">=</span> <span class="fl">5.00</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-3" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb15" data-startfrom="304" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 303;"><span id="cb15-304"><a href="#cb15-304"></a><span class="kw">function</span> <span class="fu">set</span>(input<span class="op">,</span> value) {</span>
<span id="cb15-305"><a href="#cb15-305"></a>  input<span class="op">.</span><span class="at">value</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb15-306"><a href="#cb15-306"></a>  input<span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">Event</span>(<span class="st">"input"</span><span class="op">,</span> {<span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span>}))<span class="op">;</span></span>
<span id="cb15-307"><a href="#cb15-307"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div id="ojs-cell-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb16" data-startfrom="312" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 311;"><span id="cb16-312"><a href="#cb16-312"></a><span class="kw">function</span> <span class="fu">sse</span>(obs<span class="op">,</span> preds) {</span>
<span id="cb16-313"><a href="#cb16-313"></a></span>
<span id="cb16-314"><a href="#cb16-314"></a>    <span class="cf">if</span>(obs<span class="op">.</span><span class="at">length</span> <span class="op">==</span> preds<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb16-315"><a href="#cb16-315"></a>        <span class="kw">var</span> squared_errs <span class="op">=</span> obs<span class="op">.</span><span class="fu">map</span>((e<span class="op">,</span> i) <span class="kw">=&gt;</span> (e <span class="op">-</span> preds[i])<span class="op">**</span><span class="dv">2</span> )</span>
<span id="cb16-316"><a href="#cb16-316"></a>        <span class="cf">return</span> squared_errs<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb16-317"><a href="#cb16-317"></a>    } <span class="cf">else</span> {</span>
<span id="cb16-318"><a href="#cb16-318"></a>        <span class="cf">return</span>(<span class="st">"lengths are not the same"</span>)</span>
<span id="cb16-319"><a href="#cb16-319"></a>    }</span>
<span id="cb16-320"><a href="#cb16-320"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div id="ojs-cell-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="panel-grid layout-sidebar ms-md-0 layout-sidebar-left">
<div class="cell panel-sidebar card bg-light p-2 g-col-24 g-col-lg-7">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb17" data-startfrom="327" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 326;"><span id="cb17-327"><a href="#cb17-327"></a>viewof reset <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">button</span>([</span>
<span id="cb17-328"><a href="#cb17-328"></a>  [<span class="st">"Reset all sliders"</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb17-329"><a href="#cb17-329"></a>    <span class="kw">set</span>(viewof S0<span class="op">,</span> reset_S)</span>
<span id="cb17-330"><a href="#cb17-330"></a>    <span class="kw">set</span>(viewof I0<span class="op">,</span> reset_I)</span>
<span id="cb17-331"><a href="#cb17-331"></a>    <span class="kw">set</span>(viewof beta_input<span class="op">,</span> reset_beta)</span>
<span id="cb17-332"><a href="#cb17-332"></a>  }]</span>
<span id="cb17-333"><a href="#cb17-333"></a>])</span>
<span id="cb17-334"><a href="#cb17-334"></a>viewof S0 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb17-335"><a href="#cb17-335"></a>    [<span class="dv">500</span><span class="op">,</span> <span class="dv">15000</span>]<span class="op">,</span></span>
<span id="cb17-336"><a href="#cb17-336"></a>    {<span class="dt">value</span><span class="op">:</span> reset_S<span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">md</span><span class="vs">`</span><span class="sc">${</span><span class="fu">tex</span><span class="vs">`S(0)`</span><span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb17-337"><a href="#cb17-337"></a>)</span>
<span id="cb17-338"><a href="#cb17-338"></a></span>
<span id="cb17-339"><a href="#cb17-339"></a>viewof I0 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb17-340"><a href="#cb17-340"></a>    [<span class="fl">0.001</span><span class="op">,</span> <span class="dv">50</span>]<span class="op">,</span></span>
<span id="cb17-341"><a href="#cb17-341"></a>    {<span class="dt">value</span><span class="op">:</span> reset_I<span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.001</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">md</span><span class="vs">`</span><span class="sc">${</span><span class="fu">tex</span><span class="vs">`I(0)`</span><span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb17-342"><a href="#cb17-342"></a>)</span>
<span id="cb17-343"><a href="#cb17-343"></a></span>
<span id="cb17-344"><a href="#cb17-344"></a>viewof beta_input <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb17-345"><a href="#cb17-345"></a>    [<span class="dv">1</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span></span>
<span id="cb17-346"><a href="#cb17-346"></a>    {<span class="dt">value</span><span class="op">:</span> reset_beta<span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.001</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">md</span><span class="vs">`</span><span class="sc">${</span><span class="fu">tex</span><span class="vs">`</span><span class="sc">\b</span><span class="vs">eta (</span><span class="sc">\t</span><span class="vs">imes 10^{-3})`</span><span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb17-347"><a href="#cb17-347"></a>)</span>
<span id="cb17-348"><a href="#cb17-348"></a></span>
<span id="cb17-349"><a href="#cb17-349"></a>viewof site_select <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(</span>
<span id="cb17-350"><a href="#cb17-350"></a>    [<span class="st">"Site 1"</span><span class="op">,</span> <span class="st">"Site 2"</span><span class="op">,</span> <span class="st">"Site 3"</span>]<span class="op">,</span></span>
<span id="cb17-351"><a href="#cb17-351"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">"Select a site:"</span>}</span>
<span id="cb17-352"><a href="#cb17-352"></a>)</span>
<span id="cb17-353"><a href="#cb17-353"></a></span>
<span id="cb17-354"><a href="#cb17-354"></a><span class="co">// convert to daily time scale as easier to manipulate</span></span>
<span id="cb17-355"><a href="#cb17-355"></a>beta <span class="op">=</span> (beta_input <span class="op">/</span> <span class="dv">365</span>) <span class="op">*</span> (<span class="dv">10</span> <span class="op">**</span> (<span class="op">-</span><span class="dv">3</span>))</span>
<span id="cb17-356"><a href="#cb17-356"></a></span>
<span id="cb17-357"><a href="#cb17-357"></a><span class="fu">md</span><span class="vs">`</span><span class="sc">${</span><span class="fu">tex</span><span class="vs">`R_0 = </span><span class="sc">${</span>R0_str<span class="sc">}</span><span class="vs">`</span><span class="sc">}</span><span class="vs">`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-5-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-5-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-5-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-5-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-5-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-5-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-5-7" data-nodetype="expression">

</div>
</div>
</div>
</div>
<div class="panel-fill g-col-24 g-col-lg-17 pt-3 pt-lg-0">
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb18" data-startfrom="362" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 361;"><span id="cb18-362"><a href="#cb18-362"></a>dur_inf <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb18-363"><a href="#cb18-363"></a>gamma <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> dur_inf</span>
<span id="cb18-364"><a href="#cb18-364"></a>R0 <span class="op">=</span> beta <span class="op">*</span> (S0 <span class="op">+</span> I0)<span class="op">/</span> gamma</span>
<span id="cb18-365"><a href="#cb18-365"></a></span>
<span id="cb18-366"><a href="#cb18-366"></a>R0_str <span class="op">=</span> R0<span class="op">.</span><span class="fu">toPrecision</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">toLocaleString</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-6-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-6-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-6-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-6-4" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb19" data-startfrom="371" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 370;"><span id="cb19-371"><a href="#cb19-371"></a>dt <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb19-372"><a href="#cb19-372"></a>tmax <span class="op">=</span> <span class="dv">16</span> <span class="op">*</span> <span class="dv">14</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-7-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-7-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb20" data-startfrom="377" data-source-offset="-0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 376;"><span id="cb20-377"><a href="#cb20-377"></a><span class="im">import</span> {odeRK4} <span class="im">from</span> <span class="st">'@rreusser/integration@3064'</span></span>
<span id="cb20-378"><a href="#cb20-378"></a><span class="im">import</span> { aq<span class="op">,</span> op } <span class="im">from</span> <span class="st">'@uwdata/arquero'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-8-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-8-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb21" data-startfrom="382" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 381;"><span id="cb21-382"><a href="#cb21-382"></a><span class="kw">function</span> <span class="fu">sir</span>(dydt<span class="op">,</span> y<span class="op">,</span> t) {</span>
<span id="cb21-383"><a href="#cb21-383"></a>    dydt[<span class="dv">3</span>] <span class="op">=</span> beta <span class="op">*</span> y[<span class="dv">0</span>] <span class="op">*</span> y[<span class="dv">1</span>]</span>
<span id="cb21-384"><a href="#cb21-384"></a></span>
<span id="cb21-385"><a href="#cb21-385"></a>    dydt[<span class="dv">0</span>] <span class="op">=</span> <span class="op">-</span> dydt[<span class="dv">3</span>]</span>
<span id="cb21-386"><a href="#cb21-386"></a>    dydt[<span class="dv">1</span>] <span class="op">=</span> dydt[<span class="dv">3</span>] <span class="op">-</span> gamma <span class="op">*</span> y[<span class="dv">1</span>]</span>
<span id="cb21-387"><a href="#cb21-387"></a>    dydt[<span class="dv">2</span>] <span class="op">=</span> gamma <span class="op">*</span> y[<span class="dv">1</span>]</span>
<span id="cb21-388"><a href="#cb21-388"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div id="ojs-cell-9" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb22" data-startfrom="393" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 392;"><span id="cb22-393"><a href="#cb22-393"></a><span class="kw">function</span> <span class="fu">simulate</span>(f<span class="op">,</span> t0<span class="op">,</span> y0<span class="op">,</span> dt<span class="op">,</span> tmax) {</span>
<span id="cb22-394"><a href="#cb22-394"></a>    <span class="kw">var</span> t <span class="op">=</span> t0</span>
<span id="cb22-395"><a href="#cb22-395"></a>    <span class="kw">var</span> y <span class="op">=</span> y0</span>
<span id="cb22-396"><a href="#cb22-396"></a>    <span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-397"><a href="#cb22-397"></a></span>
<span id="cb22-398"><a href="#cb22-398"></a>    <span class="kw">var</span> ysim <span class="op">=</span> [y0]</span>
<span id="cb22-399"><a href="#cb22-399"></a></span>
<span id="cb22-400"><a href="#cb22-400"></a>    <span class="cf">for</span> (t <span class="op">=</span> t0 <span class="op">+</span> dt<span class="op">;</span> t <span class="op">&lt;=</span> tmax<span class="op">;</span> t <span class="op">+=</span> dt) {</span>
<span id="cb22-401"><a href="#cb22-401"></a>        ysim<span class="op">.</span><span class="fu">push</span>(<span class="fu">odeRK4</span>([]<span class="op">,</span> ysim[i]<span class="op">,</span> f<span class="op">,</span> dt))</span>
<span id="cb22-402"><a href="#cb22-402"></a>        i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb22-403"><a href="#cb22-403"></a>    }</span>
<span id="cb22-404"><a href="#cb22-404"></a></span>
<span id="cb22-405"><a href="#cb22-405"></a>    <span class="co">// return cumulative infections</span></span>
<span id="cb22-406"><a href="#cb22-406"></a>    <span class="cf">return</span> ysim<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d[<span class="dv">3</span>])</span>
<span id="cb22-407"><a href="#cb22-407"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div id="ojs-cell-10" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb23" data-startfrom="412" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 411;"><span id="cb23-412"><a href="#cb23-412"></a>sir_sol <span class="op">=</span> <span class="fu">simulate</span>(sir<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> [S0<span class="op">,</span> I0<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span>]<span class="op">,</span> dt<span class="op">,</span> tmax)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div id="ojs-cell-11" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb24" data-startfrom="417" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 416;"><span id="cb24-417"><a href="#cb24-417"></a>siteColors <span class="op">=</span> [<span class="st">"#1b9e77"</span><span class="op">,</span> <span class="st">"#d95f02"</span><span class="op">,</span> <span class="st">"#7570b3"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div id="ojs-cell-12" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb25" data-startfrom="425" data-source-offset="-116" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 424;"><span id="cb25-425"><a href="#cb25-425"></a>times <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>({<span class="dt">length</span><span class="op">:</span> <span class="dv">17</span>}<span class="op">,</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> i <span class="op">*</span> <span class="dv">14</span>)<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb25-426"><a href="#cb25-426"></a>tindex <span class="op">=</span> times<span class="op">.</span><span class="fu">map</span>((e<span class="op">,</span> i) <span class="kw">=&gt;</span> e <span class="op">*</span> (<span class="dv">1</span> <span class="op">/</span> dt))</span>
<span id="cb25-427"><a href="#cb25-427"></a></span>
<span id="cb25-428"><a href="#cb25-428"></a>cum_inc <span class="op">=</span> tindex<span class="op">.</span><span class="fu">map</span>((i) <span class="kw">=&gt;</span> sir_sol[i])</span>
<span id="cb25-429"><a href="#cb25-429"></a></span>
<span id="cb25-430"><a href="#cb25-430"></a>preds <span class="op">=</span> [cum_inc[<span class="dv">0</span>] <span class="op">+</span> I0<span class="op">,</span> <span class="op">...</span>cum_inc<span class="op">.</span><span class="fu">map</span>((e<span class="op">,</span> i) <span class="kw">=&gt;</span> cum_inc[i] <span class="op">-</span> cum_inc[i<span class="op">-</span><span class="dv">1</span>])<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)]</span>
<span id="cb25-431"><a href="#cb25-431"></a></span>
<span id="cb25-432"><a href="#cb25-432"></a>sir_tbl <span class="op">=</span> aq<span class="op">.</span><span class="fu">table</span>({</span>
<span id="cb25-433"><a href="#cb25-433"></a>    <span class="dt">Biweek</span><span class="op">:</span> times<span class="op">.</span><span class="fu">map</span>(t <span class="kw">=&gt;</span> t <span class="op">/</span> <span class="dv">14</span>)<span class="op">,</span></span>
<span id="cb25-434"><a href="#cb25-434"></a>    <span class="st">"Cumulative Incidence"</span><span class="op">:</span> cum_inc<span class="op">,</span></span>
<span id="cb25-435"><a href="#cb25-435"></a>    <span class="st">"Number of Individuals"</span><span class="op">:</span> preds</span>
<span id="cb25-436"><a href="#cb25-436"></a>})</span>
<span id="cb25-437"><a href="#cb25-437"></a></span>
<span id="cb25-438"><a href="#cb25-438"></a>sim_sse <span class="op">=</span> [({</span>
<span id="cb25-439"><a href="#cb25-439"></a>    <span class="dt">sse</span><span class="op">:</span> <span class="fu">sse</span>(</span>
<span id="cb25-440"><a href="#cb25-440"></a>            filtered_niamey_data<span class="op">.</span><span class="fu">array</span>(<span class="st">"Number of Individuals"</span>)<span class="op">,</span></span>
<span id="cb25-441"><a href="#cb25-441"></a>            preds</span>
<span id="cb25-442"><a href="#cb25-442"></a>        )<span class="op">.</span><span class="fu">toPrecision</span>(<span class="dv">4</span>)<span class="op">,</span></span>
<span id="cb25-443"><a href="#cb25-443"></a>    <span class="dt">Biweek</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb25-444"><a href="#cb25-444"></a>    <span class="st">"Number of Individuals"</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(</span>
<span id="cb25-445"><a href="#cb25-445"></a>        <span class="op">...</span>sir_tbl<span class="op">.</span><span class="fu">array</span>(<span class="st">"Number of Individuals"</span>)<span class="op">,</span></span>
<span id="cb25-446"><a href="#cb25-446"></a>        <span class="op">...</span>filtered_niamey_data<span class="op">.</span><span class="fu">array</span>(<span class="st">"Number of Individuals"</span>)</span>
<span id="cb25-447"><a href="#cb25-447"></a>    ) <span class="op">*</span> <span class="fl">0.9</span></span>
<span id="cb25-448"><a href="#cb25-448"></a>})]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-13-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-13-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-13-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-13-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-13-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-13-6" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="panel-fill panel-grid">
<div class="g-col-24">
<div class="cell panel-fill">
<details class="code-fold hidden"><summary>Code</summary><div class="sourceCode cell-code hidden" id="cb26" data-startfrom="453" data-source-offset="0" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 452;"><span id="cb26-453"><a href="#cb26-453"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb26-454"><a href="#cb26-454"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb26-455"><a href="#cb26-455"></a>        <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb26-456"><a href="#cb26-456"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Site 1"</span><span class="op">,</span> <span class="st">"Site 2"</span><span class="op">,</span> <span class="st">"Site 3"</span>]<span class="op">,</span></span>
<span id="cb26-457"><a href="#cb26-457"></a>        <span class="dt">range</span><span class="op">:</span> siteColors<span class="op">,</span></span>
<span id="cb26-458"><a href="#cb26-458"></a>    }<span class="op">,</span></span>
<span id="cb26-459"><a href="#cb26-459"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontSize</span><span class="op">:</span> <span class="st">"20px"</span>}<span class="op">,</span></span>
<span id="cb26-460"><a href="#cb26-460"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">75</span><span class="op">,</span></span>
<span id="cb26-461"><a href="#cb26-461"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb26-462"><a href="#cb26-462"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">55</span><span class="op">,</span></span>
<span id="cb26-463"><a href="#cb26-463"></a>    <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb26-464"><a href="#cb26-464"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb26-465"><a href="#cb26-465"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">670</span><span class="op">,</span></span>
<span id="cb26-466"><a href="#cb26-466"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb26-467"><a href="#cb26-467"></a>        Plot<span class="op">.</span><span class="fu">lineY</span>(</span>
<span id="cb26-468"><a href="#cb26-468"></a>            sir_tbl<span class="op">,</span></span>
<span id="cb26-469"><a href="#cb26-469"></a>            {<span class="dt">x</span><span class="op">:</span> <span class="st">"Biweek"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"Number of Individuals"</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"#4d4d4dff"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">strokeOpacity</span><span class="op">:</span> <span class="fl">0.8</span>}</span>
<span id="cb26-470"><a href="#cb26-470"></a>        )<span class="op">,</span></span>
<span id="cb26-471"><a href="#cb26-471"></a>        Plot<span class="op">.</span><span class="fu">dot</span>(</span>
<span id="cb26-472"><a href="#cb26-472"></a>            filtered_niamey_data<span class="op">,</span></span>
<span id="cb26-473"><a href="#cb26-473"></a>            {<span class="dt">x</span><span class="op">:</span> <span class="st">"Biweek"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"Number of Individuals"</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"site"</span><span class="op">,</span> <span class="dt">fill</span><span class="op">:</span> <span class="st">"site"</span><span class="op">,</span> <span class="dt">fillOpacity</span><span class="op">:</span> <span class="fl">0.6</span><span class="op">,</span> <span class="dt">r</span><span class="op">:</span> <span class="dv">12</span>}</span>
<span id="cb26-474"><a href="#cb26-474"></a>        )<span class="op">,</span></span>
<span id="cb26-475"><a href="#cb26-475"></a>        Plot<span class="op">.</span><span class="fu">lineY</span>(</span>
<span id="cb26-476"><a href="#cb26-476"></a>            filtered_niamey_data<span class="op">,</span></span>
<span id="cb26-477"><a href="#cb26-477"></a>            {<span class="dt">x</span><span class="op">:</span> <span class="st">"Biweek"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"Number of Individuals"</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"site"</span>}</span>
<span id="cb26-478"><a href="#cb26-478"></a>        )<span class="op">,</span></span>
<span id="cb26-479"><a href="#cb26-479"></a>        Plot<span class="op">.</span><span class="fu">text</span>(</span>
<span id="cb26-480"><a href="#cb26-480"></a>            sim_sse<span class="op">,</span></span>
<span id="cb26-481"><a href="#cb26-481"></a>            {<span class="dt">x</span><span class="op">:</span> <span class="st">"Biweek"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"Number of Individuals"</span><span class="op">,</span> <span class="dt">text</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> <span class="vs">`SSE = </span><span class="sc">${</span>d<span class="op">.</span><span class="at">sse</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="dt">dx</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">dy</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span>}</span>
<span id="cb26-482"><a href="#cb26-482"></a>        )</span>
<span id="cb26-483"><a href="#cb26-483"></a>    ]</span>
<span id="cb26-484"><a href="#cb26-484"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-display">
<div id="ojs-cell-14" data-nodetype="expression">

</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section><section id="objective-function" class="level2" data-number="8.8"><h2 data-number="8.8" class="anchored" data-anchor-id="objective-function">
<span class="header-section-number">8.8</span> Objective Function</h2>
<p>Now we set up a function that will calculate the sum of the squared differences between the observations and the model at any parameterization (more commonly known as <em>“sum of squared errors”</em>). In general, this is called the <strong>objective function</strong> because it is the quantity that optimization seeks to minimize.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb27" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co">#' Calculate the Sum of Squared Errors</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="co">#'</span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="co">#' A function to take in biweekly incidence data, and SIR parameters, and</span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co">#' calculate the SSE</span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="co">#'</span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="co">#' @param params A vector of parameter values</span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="co">#' @param data A dataframe containing biweekly incidence data in the case column</span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="co">#'</span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="co">#' @return The SSE of type double</span></span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="co">#' @examples</span></span>
<span id="cb27-11"><a href="#cb27-11"></a>sse_sir <span class="ot">&lt;-</span> <span class="cf">function</span>(params, data) {</span>
<span id="cb27-12"><a href="#cb27-12"></a>  <span class="co"># Convert biweekly time series into annual time scale</span></span>
<span id="cb27-13"><a href="#cb27-13"></a>  <span class="co"># Daily time scale has requires beta values to be too small - doesn't</span></span>
<span id="cb27-14"><a href="#cb27-14"></a>  <span class="co"># optimize well</span></span>
<span id="cb27-15"><a href="#cb27-15"></a>  dt <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb27-16"><a href="#cb27-16"></a>  max_biweek <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>biweek)</span>
<span id="cb27-17"><a href="#cb27-17"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_biweek <span class="sc">*</span> <span class="dv">14</span>, dt) <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb27-18"><a href="#cb27-18"></a></span>
<span id="cb27-19"><a href="#cb27-19"></a>  <span class="co"># Extract the number of observed incidence</span></span>
<span id="cb27-20"><a href="#cb27-20"></a>  obs_inc <span class="ot">&lt;-</span> data<span class="sc">$</span>cases</span>
<span id="cb27-21"><a href="#cb27-21"></a></span>
<span id="cb27-22"><a href="#cb27-22"></a>  <span class="co"># Note the parameters are updated throughout the optimization process by</span></span>
<span id="cb27-23"><a href="#cb27-23"></a>  <span class="co"># the optim() function</span></span>
<span id="cb27-24"><a href="#cb27-24"></a>  <span class="co"># Unpack the transmission parameter and exponentiate to fit on ln scale</span></span>
<span id="cb27-25"><a href="#cb27-25"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"beta"</span>]])</span>
<span id="cb27-26"><a href="#cb27-26"></a></span>
<span id="cb27-27"><a href="#cb27-27"></a>  <span class="co"># Unpack the initial states and exponentiate to fit on normal scale</span></span>
<span id="cb27-28"><a href="#cb27-28"></a>  S_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"S_init"</span>]])</span>
<span id="cb27-29"><a href="#cb27-29"></a>  I_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"I_init"</span>]])</span>
<span id="cb27-30"><a href="#cb27-30"></a></span>
<span id="cb27-31"><a href="#cb27-31"></a>  <span class="co"># Fit SIR model to the parameters</span></span>
<span id="cb27-32"><a href="#cb27-32"></a>  sol <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb27-33"><a href="#cb27-33"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> S_init, <span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb27-34"><a href="#cb27-34"></a>    <span class="at">times =</span> t,</span>
<span id="cb27-35"><a href="#cb27-35"></a>    <span class="at">func =</span> closed_sir_model,</span>
<span id="cb27-36"><a href="#cb27-36"></a>    <span class="at">parms =</span> beta,</span>
<span id="cb27-37"><a href="#cb27-37"></a>    <span class="co"># Use rk4 as fixed time steps, which is important for indexing</span></span>
<span id="cb27-38"><a href="#cb27-38"></a>    <span class="at">method =</span> <span class="st">"rk4"</span></span>
<span id="cb27-39"><a href="#cb27-39"></a>  )</span>
<span id="cb27-40"><a href="#cb27-40"></a></span>
<span id="cb27-41"><a href="#cb27-41"></a>  <span class="co"># Extract the cumulative incidence</span></span>
<span id="cb27-42"><a href="#cb27-42"></a>  cum_inc <span class="ot">&lt;-</span> sol[, <span class="st">"new_inf"</span>]</span>
<span id="cb27-43"><a href="#cb27-43"></a></span>
<span id="cb27-44"><a href="#cb27-44"></a>  <span class="co"># Find the indices of the cumulative incidence to extract</span></span>
<span id="cb27-45"><a href="#cb27-45"></a>  biweek_index <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, max_biweek) <span class="sc">*</span> (<span class="dv">14</span> <span class="sc">/</span> dt) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb27-46"><a href="#cb27-46"></a></span>
<span id="cb27-47"><a href="#cb27-47"></a>  <span class="co"># Index cumulative incidence to get the values at the end of the biweeks</span></span>
<span id="cb27-48"><a href="#cb27-48"></a>  biweek_cum_inc <span class="ot">&lt;-</span> cum_inc[biweek_index]</span>
<span id="cb27-49"><a href="#cb27-49"></a></span>
<span id="cb27-50"><a href="#cb27-50"></a>  <span class="co"># Calculate the biweekly incidence by using the difference between</span></span>
<span id="cb27-51"><a href="#cb27-51"></a>  <span class="co"># consecutive biweeks. Need to manually prepend first week's incidence</span></span>
<span id="cb27-52"><a href="#cb27-52"></a>  <span class="co"># and add in the initial number of infectious individuals, as ODE model</span></span>
<span id="cb27-53"><a href="#cb27-53"></a>  <span class="co"># only returns the cumulative differences, which is 0 at the start.</span></span>
<span id="cb27-54"><a href="#cb27-54"></a>  biweek_inc <span class="ot">&lt;-</span> <span class="fu">c</span>(biweek_cum_inc[<span class="dv">1</span>] <span class="sc">+</span> I_init, <span class="fu">diff</span>(biweek_cum_inc, <span class="at">lag =</span> <span class="dv">1</span>))</span>
<span id="cb27-55"><a href="#cb27-55"></a></span>
<span id="cb27-56"><a href="#cb27-56"></a>  <span class="co"># return SSE of predicted vs observed incidence</span></span>
<span id="cb27-57"><a href="#cb27-57"></a>  <span class="fu">return</span>(<span class="fu">sum</span>((biweek_inc <span class="sc">-</span> obs_inc)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb27-58"><a href="#cb27-58"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Notice that the code for <code>sse_sir()</code> makes use of the following modeling trick. We know that <span class="math inline">\(\beta\)</span>, <span class="math inline">\(S_0\)</span>, and <span class="math inline">\(I_0\)</span> must be positive, but our search to optimize these parameters will be over the entire number line. We could constrain the search using a more sophisticated algorithm, but this might introduce other problems (i.e., stability at the boundaries). Instead, we parameterize our objective function (<code>sse_sir</code>) in terms of some alternative variables <span class="math inline">\(\ln(\beta)\)</span>, <span class="math inline">\(\ln(S_0)\)</span>, and <span class="math inline">\(\ln(I_0)\)</span>. While these numbers range from <span class="math inline">\(-\infty\)</span> to <span class="math inline">\(\infty\)</span> (the range of our search) they map to our model parameters on a range from <span class="math inline">\(0\)</span> to <span class="math inline">\(\infty\)</span> (the range that is biologically meaningful).</p>
</section><section id="optimization" class="level2 page-columns page-full" data-number="8.9"><h2 data-number="8.9" class="anchored" data-anchor-id="optimization">
<span class="header-section-number">8.9</span> Optimization</h2>
<p>Our final step is to use the function <code>optim</code> to find the values of <span class="math inline">\(\beta\)</span>, <span class="math inline">\(S_0\)</span>, and <span class="math inline">\(I_0\)</span> that minimize the sum of squared errors as calculated using our function.</p>
<p>Finally, we plot these fits against the data.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb28" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># Initial guess</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>sse_optim_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> <span class="fu">log</span>(<span class="fl">0.055</span>), <span class="at">S_init =</span> <span class="fu">log</span>(<span class="dv">5000</span>), <span class="at">I_init =</span> <span class="fu">log</span>(<span class="dv">1</span>))</span>
<span id="cb28-3"><a href="#cb28-3"></a></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="co"># Create a dataframe of optimized parameters</span></span>
<span id="cb28-5"><a href="#cb28-5"></a>niamey_optims <span class="ot">&lt;-</span> niamey_df <span class="sc">%&gt;%</span></span>
<span id="cb28-6"><a href="#cb28-6"></a>  <span class="co"># Create a nested dataframe i.e. one row for each site, and the data column</span></span>
<span id="cb28-7"><a href="#cb28-7"></a>  <span class="co"># now is a list column that contains a separate dataframe of times and</span></span>
<span id="cb28-8"><a href="#cb28-8"></a>  <span class="co"># cases for each site</span></span>
<span id="cb28-9"><a href="#cb28-9"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>site) <span class="sc">%&gt;%</span></span>
<span id="cb28-10"><a href="#cb28-10"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-11"><a href="#cb28-11"></a>    <span class="co"># Map the optim() function call to each of the separate dataframes</span></span>
<span id="cb28-12"><a href="#cb28-12"></a>    <span class="co"># stored in the nested data column we just created</span></span>
<span id="cb28-13"><a href="#cb28-13"></a>    <span class="at">fit =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">optim</span>(sse_optim_params, sse_sir, <span class="at">data =</span> .x)),</span>
<span id="cb28-14"><a href="#cb28-14"></a>    <span class="co"># Map the exp() function to each of the model fits just created, and</span></span>
<span id="cb28-15"><a href="#cb28-15"></a>    <span class="co"># output to a dataframe instead of a list (like in map()), for easier</span></span>
<span id="cb28-16"><a href="#cb28-16"></a>    <span class="co"># use in the plottinge predictions later</span></span>
<span id="cb28-17"><a href="#cb28-17"></a>    <span class="fu">map_dfr</span>(fit, <span class="sc">~</span> <span class="fu">exp</span>(.x<span class="sc">$</span>par))</span>
<span id="cb28-18"><a href="#cb28-18"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb29" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>niamey_optims <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(data, fit)) <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="fu">mutate</span>(<span class="at">site =</span> <span class="fu">str_replace_all</span>(site, <span class="st">"_"</span>, <span class="st">" "</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span>site, <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6"></a>  <span class="fu">fmt_scientific</span>(<span class="at">columns =</span> beta, <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="#cb29-7"></a>  <span class="co"># Relabel the column headers</span></span>
<span id="cb29-8"><a href="#cb29-8"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb29-9"><a href="#cb29-9"></a>    <span class="at">site =</span> <span class="fu">md</span>(<span class="st">"**Site**"</span>),</span>
<span id="cb29-10"><a href="#cb29-10"></a>    <span class="at">beta =</span> <span class="fu">md</span>(<span class="st">"**Beta**"</span>),</span>
<span id="cb29-11"><a href="#cb29-11"></a>    <span class="at">S_init =</span> <span class="fu">md</span>(<span class="st">"**Initial S**"</span>),</span>
<span id="cb29-12"><a href="#cb29-12"></a>    <span class="at">I_init =</span> <span class="fu">md</span>(<span class="st">"**Initial I**"</span>)</span>
<span id="cb29-13"><a href="#cb29-13"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-14"><a href="#cb29-14"></a>  <span class="co"># Apply style to the table with gray alternating rows</span></span>
<span id="cb29-15"><a href="#cb29-15"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">'gray'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-16"><a href="#cb29-16"></a>  <span class="co"># Increate space between columns</span></span>
<span id="cb29-17"><a href="#cb29-17"></a>  <span class="fu">opt_horizontal_padding</span>(<span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-18"><a href="#cb29-18"></a>  <span class="fu">cols_align</span>(<span class="st">"center"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="snbqwijgxk" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#snbqwijgxk table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#snbqwijgxk thead, #snbqwijgxk tbody, #snbqwijgxk tfoot, #snbqwijgxk tr, #snbqwijgxk td, #snbqwijgxk th {
  border-style: none;
}

#snbqwijgxk p {
  margin: 0;
  padding: 0;
}

#snbqwijgxk .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #000000;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#snbqwijgxk .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#snbqwijgxk .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#snbqwijgxk .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#snbqwijgxk .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#snbqwijgxk .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
}

#snbqwijgxk .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #5F5F5F;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#snbqwijgxk .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#snbqwijgxk .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#snbqwijgxk .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#snbqwijgxk .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#snbqwijgxk .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#snbqwijgxk .gt_spanner_row {
  border-bottom-style: hidden;
}

#snbqwijgxk .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #5F5F5F;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#snbqwijgxk .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #5F5F5F;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
  vertical-align: middle;
}

#snbqwijgxk .gt_from_md > :first-child {
  margin-top: 0;
}

#snbqwijgxk .gt_from_md > :last-child {
  margin-bottom: 0;
}

#snbqwijgxk .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: none;
  border-top-width: 1px;
  border-top-color: #D5D5D5;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D5D5D5;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D5D5D5;
  vertical-align: middle;
  overflow-x: hidden;
}

#snbqwijgxk .gt_stub {
  color: #FFFFFF;
  background-color: #5F5F5F;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #5F5F5F;
  padding-left: 15px;
  padding-right: 15px;
}

#snbqwijgxk .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#snbqwijgxk .gt_row_group_first td {
  border-top-width: 2px;
}

#snbqwijgxk .gt_row_group_first th {
  border-top-width: 2px;
}

#snbqwijgxk .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#snbqwijgxk .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #5F5F5F;
}

#snbqwijgxk .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#snbqwijgxk .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
}

#snbqwijgxk .gt_grand_summary_row {
  color: #333333;
  background-color: #D5D5D5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#snbqwijgxk .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #5F5F5F;
}

#snbqwijgxk .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #5F5F5F;
}

#snbqwijgxk .gt_striped {
  background-color: #F4F4F4;
}

#snbqwijgxk .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #5F5F5F;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
}

#snbqwijgxk .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#snbqwijgxk .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#snbqwijgxk .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#snbqwijgxk .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#snbqwijgxk .gt_left {
  text-align: left;
}

#snbqwijgxk .gt_center {
  text-align: center;
}

#snbqwijgxk .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#snbqwijgxk .gt_font_normal {
  font-weight: normal;
}

#snbqwijgxk .gt_font_bold {
  font-weight: bold;
}

#snbqwijgxk .gt_font_italic {
  font-style: italic;
}

#snbqwijgxk .gt_super {
  font-size: 65%;
}

#snbqwijgxk .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#snbqwijgxk .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#snbqwijgxk .gt_indent_1 {
  text-indent: 5px;
}

#snbqwijgxk .gt_indent_2 {
  text-indent: 10px;
}

#snbqwijgxk .gt_indent_3 {
  text-indent: 15px;
}

#snbqwijgxk .gt_indent_4 {
  text-indent: 20px;
}

#snbqwijgxk .gt_indent_5 {
  text-indent: 25px;
}

#snbqwijgxk .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#snbqwijgxk div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>
<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="gt_col_headings header">
<th id="site" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>Site</strong></th>
<th id="beta" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>Beta</strong></th>
<th id="S_init" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>Initial S</strong></th>
<th id="I_init" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>Initial I</strong></th>
</tr></thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_center" headers="site">Site 1</td>
<td class="gt_row gt_center" headers="beta">5.370&nbsp;×&nbsp;10<sup>−3</sup>
</td>
<td class="gt_row gt_center" headers="S_init">8,566.648</td>
<td class="gt_row gt_center" headers="I_init">1.349</td>
</tr>
<tr class="even">
<td class="gt_row gt_center gt_striped" headers="site">Site 2</td>
<td class="gt_row gt_center gt_striped" headers="beta">8.317&nbsp;×&nbsp;10<sup>−3</sup>
</td>
<td class="gt_row gt_center gt_striped" headers="S_init">5,961.388</td>
<td class="gt_row gt_center gt_striped" headers="I_init">0.201</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="site">Site 3</td>
<td class="gt_row gt_center" headers="beta">7.134&nbsp;×&nbsp;10<sup>−2</sup>
</td>
<td class="gt_row gt_center" headers="S_init">792.990</td>
<td class="gt_row gt_center" headers="I_init">0.001</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may have noticed that you can achieve slightly different results for the optimal parameter values using the interactive plot than are being presented here (though they are very similar). This is because while the optimization code is running in <code>R</code>, the interactive plot and the calculation of the SSE is implemented using JavaScript. Therefore, despite using the same underlying model structure, the answers will vary slightly, because the ODE solvers are different, resulting in different model simulations. The difference is not enough to be concerned with here, but it is a point that’s worth being aware of when you build your own models - you may want to perform sensitivity to confirm that your model implementation is not driving the magnitude of the results you see, and the inferences you make.</p>
</div>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb30" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>niamey_predictions <span class="ot">&lt;-</span> niamey_optims <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-3"><a href="#cb30-3"></a>    <span class="co"># For each of the different site's nested dataframes, fit the SIR model</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="co"># with the optimal parameters to get best fit predictions</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>    <span class="at">predictions =</span> <span class="fu">pmap</span>(</span>
<span id="cb30-6"><a href="#cb30-6"></a>      <span class="at">.l =</span> <span class="fu">list</span>(</span>
<span id="cb30-7"><a href="#cb30-7"></a>        <span class="at">S_init =</span> S_init,</span>
<span id="cb30-8"><a href="#cb30-8"></a>        <span class="at">I_init =</span> I_init,</span>
<span id="cb30-9"><a href="#cb30-9"></a>        <span class="at">beta =</span> beta,</span>
<span id="cb30-10"><a href="#cb30-10"></a>        <span class="at">time_data =</span> data</span>
<span id="cb30-11"><a href="#cb30-11"></a>      ),</span>
<span id="cb30-12"><a href="#cb30-12"></a>      <span class="at">.f =</span> <span class="cf">function</span>(S_init, I_init, beta, time_data) {</span>
<span id="cb30-13"><a href="#cb30-13"></a>        site_times <span class="ot">&lt;-</span> time_data<span class="sc">$</span>biweek <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb30-14"><a href="#cb30-14"></a></span>
<span id="cb30-15"><a href="#cb30-15"></a>        <span class="co"># Return a dataframe of model solutions</span></span>
<span id="cb30-16"><a href="#cb30-16"></a>        <span class="fu">as_tibble</span>(<span class="fu">ode</span>(</span>
<span id="cb30-17"><a href="#cb30-17"></a>          <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> S_init, <span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb30-18"><a href="#cb30-18"></a>          <span class="at">times =</span> site_times,</span>
<span id="cb30-19"><a href="#cb30-19"></a>          <span class="at">func =</span> closed_sir_model,</span>
<span id="cb30-20"><a href="#cb30-20"></a>          <span class="at">parms =</span> beta,</span>
<span id="cb30-21"><a href="#cb30-21"></a>          <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb30-22"><a href="#cb30-22"></a>        )) <span class="sc">%&gt;%</span></span>
<span id="cb30-23"><a href="#cb30-23"></a>          <span class="co"># Make sure all values are numeric for plotting purposes</span></span>
<span id="cb30-24"><a href="#cb30-24"></a>          <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), as.numeric)) <span class="sc">%&gt;%</span></span>
<span id="cb30-25"><a href="#cb30-25"></a>          <span class="fu">mutate</span>(</span>
<span id="cb30-26"><a href="#cb30-26"></a>            <span class="at">incidence =</span> <span class="fu">ifelse</span>(</span>
<span id="cb30-27"><a href="#cb30-27"></a>              <span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb30-28"><a href="#cb30-28"></a>              new_inf[<span class="dv">1</span>],</span>
<span id="cb30-29"><a href="#cb30-29"></a>              <span class="fu">diff</span>(new_inf, <span class="at">lag =</span> <span class="dv">1</span>)</span>
<span id="cb30-30"><a href="#cb30-30"></a>            )</span>
<span id="cb30-31"><a href="#cb30-31"></a>          )</span>
<span id="cb30-32"><a href="#cb30-32"></a>      }</span>
<span id="cb30-33"><a href="#cb30-33"></a>    )</span>
<span id="cb30-34"><a href="#cb30-34"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-35"><a href="#cb30-35"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(data, predictions))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>An important point to note is that our data is biweekly <strong>incidence</strong> (new cases in time period), whereas out SIR model produces <strong>prevalence</strong> (total cases at any time point). To account for this, our SIR model returns the cumulative incidence (line 32 of the model code), and our objective function extracts the biweekly incidence (lines 41-54), to ensure we are fitting the same data! This is a common source of error in interpretation when people fit models to data.</p>
</div>
</div>
<div class="cell page-columns page-full">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb31" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="co"># Create a dataframe to store the positions of the text labels</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>niamey_preds_labels <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb31-3"><a href="#cb31-3"></a>  <span class="at">site =</span> <span class="fu">c</span>(<span class="st">"Site_1"</span>, <span class="st">"Site_2"</span>),</span>
<span id="cb31-4"><a href="#cb31-4"></a>  <span class="at">x_label =</span> <span class="fu">c</span>(<span class="fl">6.5</span>, <span class="fl">6.5</span>),</span>
<span id="cb31-5"><a href="#cb31-5"></a>  <span class="at">x_arrow_just =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>),</span>
<span id="cb31-6"><a href="#cb31-6"></a>  <span class="at">x_arrow_end =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="fl">7.75</span>),</span>
<span id="cb31-7"><a href="#cb31-7"></a>  <span class="at">y_label =</span> <span class="fu">c</span>(<span class="dv">900</span>, <span class="dv">600</span>),</span>
<span id="cb31-8"><a href="#cb31-8"></a>  <span class="at">y_arrow_just =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">80</span>, <span class="sc">-</span><span class="dv">70</span>),</span>
<span id="cb31-9"><a href="#cb31-9"></a>  <span class="at">y_arrow_end =</span> <span class="fu">c</span>(<span class="dv">350</span>, <span class="dv">290</span>),</span>
<span id="cb31-10"><a href="#cb31-10"></a>  <span class="at">commentary =</span> <span class="fu">c</span>(<span class="st">"**Predicted"</span>, <span class="st">"**Observed"</span>),</span>
<span id="cb31-11"><a href="#cb31-11"></a>  <span class="at">color =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, niamey_site_colors[<span class="st">"Site_2"</span>])</span>
<span id="cb31-12"><a href="#cb31-12"></a>)</span>
<span id="cb31-13"><a href="#cb31-13"></a></span>
<span id="cb31-14"><a href="#cb31-14"></a><span class="fu">ggplot</span>(niamey_predictions, <span class="fu">aes</span>(<span class="at">x =</span> biweek, <span class="at">group =</span> site)) <span class="sc">+</span></span>
<span id="cb31-15"><a href="#cb31-15"></a>  <span class="co"># Plot the actual data in color</span></span>
<span id="cb31-16"><a href="#cb31-16"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> cases, <span class="at">color =</span> site)) <span class="sc">+</span></span>
<span id="cb31-17"><a href="#cb31-17"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> cases, <span class="at">color =</span> site), <span class="at">size =</span> <span class="dv">4</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb31-18"><a href="#cb31-18"></a>  <span class="co"># Plot the best-fit model predictions in black</span></span>
<span id="cb31-19"><a href="#cb31-19"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> incidence), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb31-20"><a href="#cb31-20"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb31-21"><a href="#cb31-21"></a>    <span class="at">values =</span> niamey_site_colors,</span>
<span id="cb31-22"><a href="#cb31-22"></a>    <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">"color"</span>, <span class="st">"fill"</span>)</span>
<span id="cb31-23"><a href="#cb31-23"></a>  ) <span class="sc">+</span></span>
<span id="cb31-24"><a href="#cb31-24"></a>  <span class="co"># Place each site on it's own subplot and change labels</span></span>
<span id="cb31-25"><a href="#cb31-25"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb31-26"><a href="#cb31-26"></a>    <span class="sc">~</span>site,</span>
<span id="cb31-27"><a href="#cb31-27"></a>    <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb31-28"><a href="#cb31-28"></a>    <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb31-29"><a href="#cb31-29"></a>    <span class="at">labeller =</span> <span class="fu">as_labeller</span>(niamey_site_labels)</span>
<span id="cb31-30"><a href="#cb31-30"></a>  ) <span class="sc">+</span></span>
<span id="cb31-31"><a href="#cb31-31"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Biweek"</span>, <span class="at">y =</span> <span class="st">"Number of Case"</span>) <span class="sc">+</span></span>
<span id="cb31-32"><a href="#cb31-32"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-33"><a href="#cb31-33"></a>  ggtext<span class="sc">::</span><span class="fu">geom_textbox</span>(</span>
<span id="cb31-34"><a href="#cb31-34"></a>    <span class="at">data =</span> niamey_preds_labels,</span>
<span id="cb31-35"><a href="#cb31-35"></a>    <span class="fu">aes</span>(</span>
<span id="cb31-36"><a href="#cb31-36"></a>      <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-37"><a href="#cb31-37"></a>        <span class="st">"&lt;span style = </span><span class="sc">\"</span><span class="st">color:"</span>,</span>
<span id="cb31-38"><a href="#cb31-38"></a>        color,</span>
<span id="cb31-39"><a href="#cb31-39"></a>        <span class="st">"</span><span class="sc">\"</span><span class="st">&gt;"</span>,</span>
<span id="cb31-40"><a href="#cb31-40"></a>        commentary,</span>
<span id="cb31-41"><a href="#cb31-41"></a>        <span class="st">" Cases**"</span>,</span>
<span id="cb31-42"><a href="#cb31-42"></a>        <span class="st">"&lt;/span&gt;"</span></span>
<span id="cb31-43"><a href="#cb31-43"></a>      ),</span>
<span id="cb31-44"><a href="#cb31-44"></a>      <span class="at">x =</span> x_label,</span>
<span id="cb31-45"><a href="#cb31-45"></a>      <span class="at">y =</span> y_label</span>
<span id="cb31-46"><a href="#cb31-46"></a>    ),</span>
<span id="cb31-47"><a href="#cb31-47"></a>    <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb31-48"><a href="#cb31-48"></a>    <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb31-49"><a href="#cb31-49"></a>    <span class="at">box.colour =</span> <span class="cn">NA</span></span>
<span id="cb31-50"><a href="#cb31-50"></a>  ) <span class="sc">+</span></span>
<span id="cb31-51"><a href="#cb31-51"></a>  <span class="fu">geom_curve</span>(</span>
<span id="cb31-52"><a href="#cb31-52"></a>    <span class="at">data =</span> niamey_preds_labels,</span>
<span id="cb31-53"><a href="#cb31-53"></a>    <span class="fu">aes</span>(</span>
<span id="cb31-54"><a href="#cb31-54"></a>      <span class="at">x =</span> x_label <span class="sc">+</span> x_arrow_just,</span>
<span id="cb31-55"><a href="#cb31-55"></a>      <span class="at">xend =</span> x_arrow_end,</span>
<span id="cb31-56"><a href="#cb31-56"></a>      <span class="at">y =</span> y_label <span class="sc">+</span> y_arrow_just,</span>
<span id="cb31-57"><a href="#cb31-57"></a>      <span class="at">yend =</span> y_arrow_end</span>
<span id="cb31-58"><a href="#cb31-58"></a>    ),</span>
<span id="cb31-59"><a href="#cb31-59"></a>    <span class="at">linewidth =</span> <span class="fl">0.75</span>,</span>
<span id="cb31-60"><a href="#cb31-60"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>)),</span>
<span id="cb31-61"><a href="#cb31-61"></a>    <span class="at">curvature =</span> <span class="fu">list</span>(<span class="fl">0.25</span>),</span>
<span id="cb31-62"><a href="#cb31-62"></a>    <span class="at">color =</span> <span class="st">"grey20"</span></span>
<span id="cb31-63"><a href="#cb31-63"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="r-session-03_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img column-body" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<section id="exercise-5" class="level3 exercise" data-number="8.9.1"><h3 data-number="8.9.1" class="anchored" data-anchor-id="exercise-5">
<span class="header-section-number">8.9.1</span> Exercise 5</h3>
</section><p>To make things easier, we have assumed the infectious period is known to be 14 days. In terms of years, <span class="math inline">\(\text{D} = \frac{14}{365} \approx 0.0384\)</span>, and the recovery rate is the inverse i.e., <span class="math inline">\(\gamma = \frac{14}{365}\)</span>. Now, modify the code above to estimate <span class="math inline">\(\gamma\)</span> and <span class="math inline">\(\beta\)</span> simultaneously.</p>
<section id="exercise-6" class="level3 exercise" data-number="8.9.2"><h3 data-number="8.9.2" class="anchored" data-anchor-id="exercise-6">
<span class="header-section-number">8.9.2</span> Exercise 6</h3>
</section><p>What happens if one or both of the other unknowns (<span class="math inline">\(S_0\)</span> and <span class="math inline">\(I_0\)</span>) is fixed instead of <span class="math inline">\(\gamma\)</span>?</p>
</section><section id="solutions" class="level2" data-number="8.10"><h2 data-number="8.10" class="anchored" data-anchor-id="solutions">
<span class="header-section-number">8.10</span> Solutions</h2>
<section id="exercise-1-1" class="level3" data-number="8.10.1"><h3 data-number="8.10.1" class="anchored" data-anchor-id="exercise-1-1">
<span class="header-section-number">8.10.1</span> Exercise 1</h3>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb32" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>p_infec <span class="ot">&lt;-</span> (<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.001</span>))</span>
<span id="cb32-2"><a href="#cb32-2"></a>r0_p <span class="ot">&lt;-</span> (<span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> p_infec)) <span class="sc">/</span> (<span class="sc">-</span>p_infec)</span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="fu">plot</span>(</span>
<span id="cb32-4"><a href="#cb32-4"></a>  <span class="at">x =</span> p_infec,</span>
<span id="cb32-5"><a href="#cb32-5"></a>  <span class="at">y =</span> r0_p,</span>
<span id="cb32-6"><a href="#cb32-6"></a>  <span class="at">main =</span> <span class="st">"Relationship between final proportion infected and R0"</span>,</span>
<span id="cb32-7"><a href="#cb32-7"></a>  <span class="at">xlab =</span> <span class="st">"Final proportion infected"</span>,</span>
<span id="cb32-8"><a href="#cb32-8"></a>  <span class="at">ylab =</span> <span class="st">"R0"</span></span>
<span id="cb32-9"><a href="#cb32-9"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="r-session-03_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="exercise-2-1" class="level3" data-number="8.10.2"><h3 data-number="8.10.2" class="anchored" data-anchor-id="exercise-2-1">
<span class="header-section-number">8.10.2</span> Exercise 2</h3>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb33" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="co">#A: If the cases were isolated after 24 hours, then gamma would be 1/1 = 1, and if the cases were isolated after 12 hours, gamma would be 1/0.5 = 2. R0 would be calculated as the beta coefficient over gamma, below:</span></span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a>r0_g1 <span class="ot">&lt;-</span> <span class="fl">1.094913</span> <span class="sc">/</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>r0_g1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] 2.094913</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb35" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>r0_g2 <span class="ot">&lt;-</span> <span class="fl">1.094913</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>r0_g2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] 1.547457</code></pre>
</div>
</div>
</section><section id="exercise-3-1" class="level3" data-number="8.10.3"><h3 data-number="8.10.3" class="anchored" data-anchor-id="exercise-3-1">
<span class="header-section-number">8.10.3</span> Exercise 3</h3>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb37" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>niamey[<span class="dv">5</span>, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#replace a "NA"</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="co">#the command below organizes the data so it can be plotted and analyzed</span></span>
<span id="cb37-3"><a href="#cb37-3"></a>niamey <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-4"><a href="#cb37-4"></a>  <span class="at">biweek =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">16</span>), <span class="dv">3</span>),</span>
<span id="cb37-5"><a href="#cb37-5"></a>  <span class="at">site =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">16</span>), <span class="fu">rep</span>(<span class="dv">2</span>, <span class="dv">16</span>), <span class="fu">rep</span>(<span class="dv">3</span>, <span class="dv">16</span>)),</span>
<span id="cb37-6"><a href="#cb37-6"></a>  <span class="at">cases =</span> <span class="fu">c</span>(niamey[, <span class="dv">1</span>], niamey[, <span class="dv">2</span>], niamey[, <span class="dv">3</span>])</span>
<span id="cb37-7"><a href="#cb37-7"></a>) <span class="co">#define "biweeks"</span></span>
<span id="cb37-8"><a href="#cb37-8"></a></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="co"># As the data are reported every two weeks, this corresponds to the 10th observation. Let’s fit a linear model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb38" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># First let's see what the outbreak looks like for the first community on a linear scale</span></span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="fu">plot</span>(</span>
<span id="cb38-3"><a href="#cb38-3"></a>  niamey<span class="sc">$</span>biweek[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb38-4"><a href="#cb38-4"></a>  niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb38-5"><a href="#cb38-5"></a>  <span class="at">type =</span> <span class="st">'p'</span>,</span>
<span id="cb38-6"><a href="#cb38-6"></a>  <span class="at">col =</span> niamey<span class="sc">$</span>site,</span>
<span id="cb38-7"><a href="#cb38-7"></a>  <span class="at">xlab =</span> <span class="st">'Biweek'</span>,</span>
<span id="cb38-8"><a href="#cb38-8"></a>  <span class="at">ylab =</span> <span class="st">'Cases'</span></span>
<span id="cb38-9"><a href="#cb38-9"></a>)</span>
<span id="cb38-10"><a href="#cb38-10"></a><span class="fu">lines</span>(niamey<span class="sc">$</span>biweek[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="r-session-03_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb39" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># Now let’s try it on a log scale to see until when the outbreak is roughly linear</span></span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="fu">plot</span>(</span>
<span id="cb39-3"><a href="#cb39-3"></a>  niamey<span class="sc">$</span>biweek[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb39-4"><a href="#cb39-4"></a>  niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb39-5"><a href="#cb39-5"></a>  <span class="at">type =</span> <span class="st">'p'</span>,</span>
<span id="cb39-6"><a href="#cb39-6"></a>  <span class="at">col =</span> niamey<span class="sc">$</span>site,</span>
<span id="cb39-7"><a href="#cb39-7"></a>  <span class="at">xlab =</span> <span class="st">'Biweek'</span>,</span>
<span id="cb39-8"><a href="#cb39-8"></a>  <span class="at">ylab =</span> <span class="st">'Cases'</span>,</span>
<span id="cb39-9"><a href="#cb39-9"></a>  <span class="at">log =</span> <span class="st">'y'</span></span>
<span id="cb39-10"><a href="#cb39-10"></a>)</span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="fu">lines</span>(niamey<span class="sc">$</span>biweek[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="r-session-03_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb40" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># here we create a "week" variable to run the analysis on a weekly</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>niamey<span class="sc">$</span>week <span class="ot">&lt;-</span> niamey<span class="sc">$</span>biweek <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="co"># we use the `head` command to take the first N values of a vector. In this case, we're taking the first 10 values of our outcome (cases) and predictor (time) variables.</span></span>
<span id="cb40-4"><a href="#cb40-4"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb40-5"><a href="#cb40-5"></a>  <span class="fu">log</span>(<span class="fu">head</span>(niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], <span class="dv">10</span>)) <span class="sc">~</span></span>
<span id="cb40-6"><a href="#cb40-6"></a>    (<span class="fu">head</span>(niamey<span class="sc">$</span>week[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], <span class="dv">10</span>))</span>
<span id="cb40-7"><a href="#cb40-7"></a>)</span>
<span id="cb40-8"><a href="#cb40-8"></a><span class="fu">summary</span>(model) <span class="co">#summary statistics for fit model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>
Call:
lm(formula = log(head(niamey$cases[niamey$site == 1], 10)) ~ 
    (head(niamey$week[niamey$site == 1], 10)))

Residuals:
     Min       1Q   Median       3Q      Max 
-0.51796 -0.07364  0.00790  0.10727  0.36805 

Coefficients:
                                        Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)                              2.59679    0.17563   14.79 4.31e-07
head(niamey$week[niamey$site == 1], 10)  0.21960    0.01415   15.52 2.96e-07
                                           
(Intercept)                             ***
head(niamey$week[niamey$site == 1], 10) ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.2571 on 8 degrees of freedom
Multiple R-squared:  0.9678,    Adjusted R-squared:  0.9638 
F-statistic: 240.8 on 1 and 8 DF,  p-value: 2.963e-07</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb42" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="co"># Now let's get the slope and display it</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>slope <span class="ot">&lt;-</span> <span class="fu">coef</span>(model)[<span class="dv">2</span>] <span class="co">#extract slope parameter</span></span>
<span id="cb42-3"><a href="#cb42-3"></a>slope <span class="co">#print to screen</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>head(niamey$week[niamey$site == 1], 10) 
                              0.2196041 </code></pre>
</div>
</div>
<p>As we ran the model by weeks, the <span class="math inline">\(\gamma\)</span> value is <span class="math inline">\(2^{-1}\)</span> and <span class="math inline">\(\hat R_0 = \hat \beta_1 / \gamma +1\)</span> giving <span class="math inline">\(\hat R_0=0.2196041/0.5+1 \approx 1.44\)</span>.</p>
</section><section id="exercise-4-1" class="level3" data-number="8.10.4"><h3 data-number="8.10.4" class="anchored" data-anchor-id="exercise-4-1">
<span class="header-section-number">8.10.4</span> Exercise 4</h3>
<p>Here, we can use a loop and repeat the regression procedure we used above for varying numbers of initial data points in our model.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb44" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>slope <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>se <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">18</span>) {</span>
<span id="cb44-4"><a href="#cb44-4"></a>  model <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb44-5"><a href="#cb44-5"></a>    <span class="fu">log</span>(<span class="fu">head</span>(niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], i)) <span class="sc">~</span></span>
<span id="cb44-6"><a href="#cb44-6"></a>      (<span class="fu">head</span>(niamey<span class="sc">$</span>week[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], i))</span>
<span id="cb44-7"><a href="#cb44-7"></a>  )</span>
<span id="cb44-8"><a href="#cb44-8"></a>  slope <span class="ot">&lt;-</span> <span class="fu">c</span>(slope, <span class="fu">as.numeric</span>(<span class="fu">coef</span>(model)[<span class="dv">2</span>]))</span>
<span id="cb44-9"><a href="#cb44-9"></a>  se <span class="ot">&lt;-</span> <span class="fu">c</span>(se, <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients[<span class="dv">4</span>])</span>
<span id="cb44-10"><a href="#cb44-10"></a>}</span>
<span id="cb44-11"><a href="#cb44-11"></a>R0 <span class="ot">&lt;-</span> slope <span class="sc">/</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb44-12"><a href="#cb44-12"></a><span class="fu">plot</span>(R0, se, <span class="at">ylab =</span> <span class="st">'Standard error'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="r-session-03_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="exercise-5-1" class="level3" data-number="8.10.5"><h3 data-number="8.10.5" class="anchored" data-anchor-id="exercise-5-1">
<span class="header-section-number">8.10.5</span> Exercise 5</h3>
<p>First, let’s add in <span class="math inline">\(\gamma\)</span> estimation into the <code>sse.sir</code> function and create a new <code>sse.sir</code> function called <code>sse.sir.g</code></p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb45" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co">#' Basic SIR model</span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="co">#'</span></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="co">#' A basic SIR model with no demographic structure to be used in deSolve</span></span>
<span id="cb45-4"><a href="#cb45-4"></a><span class="co">#'</span></span>
<span id="cb45-5"><a href="#cb45-5"></a><span class="co">#' @param time deSolve passes the time parameter to the function.</span></span>
<span id="cb45-6"><a href="#cb45-6"></a><span class="co">#' @param state A vector of states.</span></span>
<span id="cb45-7"><a href="#cb45-7"></a><span class="co">#' @param params The beta parameter</span></span>
<span id="cb45-8"><a href="#cb45-8"></a><span class="co">#' @param ... Other arguments passed by deSolve.</span></span>
<span id="cb45-9"><a href="#cb45-9"></a><span class="co">#'</span></span>
<span id="cb45-10"><a href="#cb45-10"></a><span class="co">#' @return A deSolve matrix of states at each time step.</span></span>
<span id="cb45-11"><a href="#cb45-11"></a><span class="co">#' @examples</span></span>
<span id="cb45-12"><a href="#cb45-12"></a><span class="co">#' sir_params &lt;- 0.0005</span></span>
<span id="cb45-13"><a href="#cb45-13"></a><span class="co">#' sir_init_states &lt;- c(S = 5000, I = 1, R = 0)</span></span>
<span id="cb45-14"><a href="#cb45-14"></a><span class="co">#' sim_times &lt;- seq(0, 16 / 365, by = 0.1 / 365)</span></span>
<span id="cb45-15"><a href="#cb45-15"></a><span class="co">#'</span></span>
<span id="cb45-16"><a href="#cb45-16"></a><span class="co">#' sir_sol &lt;- deSolve::ode(</span></span>
<span id="cb45-17"><a href="#cb45-17"></a><span class="co">#'    y = sir_init_states,</span></span>
<span id="cb45-18"><a href="#cb45-18"></a><span class="co">#'    times = sim_times,</span></span>
<span id="cb45-19"><a href="#cb45-19"></a><span class="co">#'    func = closed_sir_model,</span></span>
<span id="cb45-20"><a href="#cb45-20"></a><span class="co">#'    parms = sir_params</span></span>
<span id="cb45-21"><a href="#cb45-21"></a><span class="co">#' )</span></span>
<span id="cb45-22"><a href="#cb45-22"></a></span>
<span id="cb45-23"><a href="#cb45-23"></a><span class="co"># Create a new SIR model to include gamma</span></span>
<span id="cb45-24"><a href="#cb45-24"></a>closed_sir_model_g <span class="ot">&lt;-</span> <span class="cf">function</span>(time, state, params, ...) {</span>
<span id="cb45-25"><a href="#cb45-25"></a>  <span class="co"># Unpack states</span></span>
<span id="cb45-26"><a href="#cb45-26"></a>  S <span class="ot">&lt;-</span> state[<span class="st">"S"</span>]</span>
<span id="cb45-27"><a href="#cb45-27"></a>  I <span class="ot">&lt;-</span> state[<span class="st">"I"</span>]</span>
<span id="cb45-28"><a href="#cb45-28"></a></span>
<span id="cb45-29"><a href="#cb45-29"></a>  <span class="co"># Unpack parameters</span></span>
<span id="cb45-30"><a href="#cb45-30"></a>  beta <span class="ot">&lt;-</span> params[[<span class="st">"beta"</span>]]</span>
<span id="cb45-31"><a href="#cb45-31"></a>  dur_inf <span class="ot">&lt;-</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb45-32"><a href="#cb45-32"></a>  gamma <span class="ot">&lt;-</span> params[[<span class="st">"gamma"</span>]]</span>
<span id="cb45-33"><a href="#cb45-33"></a></span>
<span id="cb45-34"><a href="#cb45-34"></a>  new_inf <span class="ot">&lt;-</span> beta <span class="sc">*</span> S <span class="sc">*</span> I</span>
<span id="cb45-35"><a href="#cb45-35"></a></span>
<span id="cb45-36"><a href="#cb45-36"></a>  <span class="co"># Calculate the ODEs</span></span>
<span id="cb45-37"><a href="#cb45-37"></a>  dSdt <span class="ot">&lt;-</span> <span class="sc">-</span>new_inf</span>
<span id="cb45-38"><a href="#cb45-38"></a>  dIdt <span class="ot">&lt;-</span> new_inf <span class="sc">-</span> (gamma <span class="sc">*</span> I)</span>
<span id="cb45-39"><a href="#cb45-39"></a></span>
<span id="cb45-40"><a href="#cb45-40"></a>  <span class="co"># Return the ODEs</span></span>
<span id="cb45-41"><a href="#cb45-41"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="fu">c</span>(dSdt, dIdt, new_inf)))</span>
<span id="cb45-42"><a href="#cb45-42"></a>}</span>
<span id="cb45-43"><a href="#cb45-43"></a></span>
<span id="cb45-44"><a href="#cb45-44"></a></span>
<span id="cb45-45"><a href="#cb45-45"></a><span class="co">#' Calculate the Sum of Squared Errors</span></span>
<span id="cb45-46"><a href="#cb45-46"></a><span class="co">#'</span></span>
<span id="cb45-47"><a href="#cb45-47"></a><span class="co">#' A function to take in biweekly incidence data, and SIR parameters, and</span></span>
<span id="cb45-48"><a href="#cb45-48"></a><span class="co">#' calculate the SSE</span></span>
<span id="cb45-49"><a href="#cb45-49"></a><span class="co">#'</span></span>
<span id="cb45-50"><a href="#cb45-50"></a><span class="co">#' @param params A vector of parameter values</span></span>
<span id="cb45-51"><a href="#cb45-51"></a><span class="co">#' @param data A dataframe containing biweekly incidence data in the case column</span></span>
<span id="cb45-52"><a href="#cb45-52"></a><span class="co">#'</span></span>
<span id="cb45-53"><a href="#cb45-53"></a><span class="co">#' @return The SSE of type double</span></span>
<span id="cb45-54"><a href="#cb45-54"></a><span class="co">#' @examples</span></span>
<span id="cb45-55"><a href="#cb45-55"></a>sse_sir_g <span class="ot">&lt;-</span> <span class="cf">function</span>(params, data) {</span>
<span id="cb45-56"><a href="#cb45-56"></a>  <span class="co"># Convert biweekly time series into annual time scale</span></span>
<span id="cb45-57"><a href="#cb45-57"></a>  <span class="co"># Daily time scale has requires beta values to be too small - doesn't</span></span>
<span id="cb45-58"><a href="#cb45-58"></a>  <span class="co"># optimize well</span></span>
<span id="cb45-59"><a href="#cb45-59"></a>  dt <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb45-60"><a href="#cb45-60"></a>  max_biweek <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>biweek)</span>
<span id="cb45-61"><a href="#cb45-61"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_biweek <span class="sc">*</span> <span class="dv">14</span>, dt) <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb45-62"><a href="#cb45-62"></a></span>
<span id="cb45-63"><a href="#cb45-63"></a>  <span class="co"># Extract the number of observed incidence</span></span>
<span id="cb45-64"><a href="#cb45-64"></a>  obs_inc <span class="ot">&lt;-</span> data<span class="sc">$</span>cases</span>
<span id="cb45-65"><a href="#cb45-65"></a></span>
<span id="cb45-66"><a href="#cb45-66"></a>  <span class="co"># Note the parameters are updated throughout the optimization process by</span></span>
<span id="cb45-67"><a href="#cb45-67"></a>  <span class="co"># the optim() function</span></span>
<span id="cb45-68"><a href="#cb45-68"></a>  <span class="co"># Unpack the transmission parameter and exponentiate to fit on ln scale</span></span>
<span id="cb45-69"><a href="#cb45-69"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"beta"</span>]])</span>
<span id="cb45-70"><a href="#cb45-70"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"gamma"</span>]])</span>
<span id="cb45-71"><a href="#cb45-71"></a></span>
<span id="cb45-72"><a href="#cb45-72"></a>  in_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"beta"</span> <span class="ot">=</span> beta, <span class="st">"gamma"</span> <span class="ot">=</span> gamma)</span>
<span id="cb45-73"><a href="#cb45-73"></a>  <span class="co"># Unpack the initial states and exponentiate to fit on normal scale</span></span>
<span id="cb45-74"><a href="#cb45-74"></a>  S_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"S_init"</span>]])</span>
<span id="cb45-75"><a href="#cb45-75"></a>  I_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"I_init"</span>]])</span>
<span id="cb45-76"><a href="#cb45-76"></a></span>
<span id="cb45-77"><a href="#cb45-77"></a>  <span class="co"># Fit SIR model to the parameters</span></span>
<span id="cb45-78"><a href="#cb45-78"></a>  sol <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb45-79"><a href="#cb45-79"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> S_init, <span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb45-80"><a href="#cb45-80"></a>    <span class="at">times =</span> t,</span>
<span id="cb45-81"><a href="#cb45-81"></a>    <span class="at">func =</span> closed_sir_model_g,</span>
<span id="cb45-82"><a href="#cb45-82"></a>    <span class="at">parms =</span> in_parms,</span>
<span id="cb45-83"><a href="#cb45-83"></a>    <span class="co"># Use rk4 as fixed time steps, which is important for indexing</span></span>
<span id="cb45-84"><a href="#cb45-84"></a>    <span class="at">method =</span> <span class="st">"rk4"</span></span>
<span id="cb45-85"><a href="#cb45-85"></a>  )</span>
<span id="cb45-86"><a href="#cb45-86"></a></span>
<span id="cb45-87"><a href="#cb45-87"></a>  <span class="co"># Extract the cumulative incidence</span></span>
<span id="cb45-88"><a href="#cb45-88"></a>  cum_inc <span class="ot">&lt;-</span> sol[, <span class="st">"new_inf"</span>]</span>
<span id="cb45-89"><a href="#cb45-89"></a></span>
<span id="cb45-90"><a href="#cb45-90"></a>  <span class="co"># Find the indices of the cumulative incidence to extract</span></span>
<span id="cb45-91"><a href="#cb45-91"></a>  biweek_index <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, max_biweek) <span class="sc">*</span> (<span class="dv">14</span> <span class="sc">/</span> dt) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb45-92"><a href="#cb45-92"></a></span>
<span id="cb45-93"><a href="#cb45-93"></a>  <span class="co"># Index cumulative incidence to get the values at the end of the biweeks</span></span>
<span id="cb45-94"><a href="#cb45-94"></a>  biweek_cum_inc <span class="ot">&lt;-</span> cum_inc[biweek_index]</span>
<span id="cb45-95"><a href="#cb45-95"></a></span>
<span id="cb45-96"><a href="#cb45-96"></a>  <span class="co"># Calculate the biweekly incidence by using the difference between</span></span>
<span id="cb45-97"><a href="#cb45-97"></a>  <span class="co"># consecutive biweeks. Need to manually prepend first week's incidence</span></span>
<span id="cb45-98"><a href="#cb45-98"></a>  <span class="co"># and add in the initial number of infectious individuals, as ODE model</span></span>
<span id="cb45-99"><a href="#cb45-99"></a>  <span class="co"># only returns the cumulative differences, which is 0 at the start.</span></span>
<span id="cb45-100"><a href="#cb45-100"></a>  biweek_inc <span class="ot">&lt;-</span> <span class="fu">c</span>(biweek_cum_inc[<span class="dv">1</span>] <span class="sc">+</span> I_init, <span class="fu">diff</span>(biweek_cum_inc, <span class="at">lag =</span> <span class="dv">1</span>))</span>
<span id="cb45-101"><a href="#cb45-101"></a></span>
<span id="cb45-102"><a href="#cb45-102"></a>  <span class="co"># return SSE of predicted vs observed incidence</span></span>
<span id="cb45-103"><a href="#cb45-103"></a>  <span class="fu">return</span>(<span class="fu">sum</span>((biweek_inc <span class="sc">-</span> obs_inc)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb45-104"><a href="#cb45-104"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can run the code to optimize, beta, gamma, I0, and S0</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb46" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>sse_optim_params_g <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb46-2"><a href="#cb46-2"></a>  <span class="at">beta =</span> <span class="fu">log</span>(<span class="fl">0.055</span>),</span>
<span id="cb46-3"><a href="#cb46-3"></a>  <span class="at">gamma =</span> <span class="fu">log</span>(<span class="dv">365</span> <span class="sc">/</span> <span class="dv">14</span>),</span>
<span id="cb46-4"><a href="#cb46-4"></a>  <span class="at">S_init =</span> <span class="fu">log</span>(<span class="dv">5000</span>),</span>
<span id="cb46-5"><a href="#cb46-5"></a>  <span class="at">I_init =</span> <span class="fu">log</span>(<span class="dv">1</span>)</span>
<span id="cb46-6"><a href="#cb46-6"></a>)</span>
<span id="cb46-7"><a href="#cb46-7"></a></span>
<span id="cb46-8"><a href="#cb46-8"></a><span class="co"># Create a dataframe of optimized parameters</span></span>
<span id="cb46-9"><a href="#cb46-9"></a>niamey_optims_g <span class="ot">&lt;-</span> niamey_df <span class="sc">%&gt;%</span></span>
<span id="cb46-10"><a href="#cb46-10"></a>  <span class="co"># Create a nested dataframe i.e. one row for each site, and the data column</span></span>
<span id="cb46-11"><a href="#cb46-11"></a>  <span class="co"># now is a list column that contains a separate dataframe of times and</span></span>
<span id="cb46-12"><a href="#cb46-12"></a>  <span class="co"># cases for each site</span></span>
<span id="cb46-13"><a href="#cb46-13"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>site) <span class="sc">%&gt;%</span></span>
<span id="cb46-14"><a href="#cb46-14"></a>  <span class="fu">mutate</span>(</span>
<span id="cb46-15"><a href="#cb46-15"></a>    <span class="co"># Map the optim() function call to each of the separate dataframes</span></span>
<span id="cb46-16"><a href="#cb46-16"></a>    <span class="co"># stored in the nested data column we just created</span></span>
<span id="cb46-17"><a href="#cb46-17"></a>    <span class="at">fit =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">optim</span>(sse_optim_params_g, sse_sir_g, <span class="at">data =</span> .x)),</span>
<span id="cb46-18"><a href="#cb46-18"></a>    <span class="co"># Map the exp() function to each of the model fits just created, and</span></span>
<span id="cb46-19"><a href="#cb46-19"></a>    <span class="co"># output to a dataframe instead of a list (like in map()), for easier</span></span>
<span id="cb46-20"><a href="#cb46-20"></a>    <span class="co"># use in the plottinge predictions later</span></span>
<span id="cb46-21"><a href="#cb46-21"></a>    <span class="fu">map_dfr</span>(fit, <span class="sc">~</span> <span class="fu">exp</span>(.x<span class="sc">$</span>par))</span>
<span id="cb46-22"><a href="#cb46-22"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can get our optimized parameters</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb47" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>niamey_optims_g <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(data, fit)) <span class="sc">%&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3"></a>  <span class="fu">mutate</span>(<span class="at">site =</span> <span class="fu">str_replace_all</span>(site, <span class="st">"_"</span>, <span class="st">" "</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb47-4"><a href="#cb47-4"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-5"><a href="#cb47-5"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span>site, <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb47-6"><a href="#cb47-6"></a>  <span class="fu">fmt_scientific</span>(<span class="at">columns =</span> beta, <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb47-7"><a href="#cb47-7"></a>  <span class="co"># Relabel the column headers</span></span>
<span id="cb47-8"><a href="#cb47-8"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb47-9"><a href="#cb47-9"></a>    <span class="at">site =</span> <span class="fu">md</span>(<span class="st">"**Site**"</span>),</span>
<span id="cb47-10"><a href="#cb47-10"></a>    <span class="at">beta =</span> <span class="fu">md</span>(<span class="st">"**Beta**"</span>),</span>
<span id="cb47-11"><a href="#cb47-11"></a>    <span class="at">gamma =</span> <span class="fu">md</span>(<span class="st">"**Gamma**"</span>),</span>
<span id="cb47-12"><a href="#cb47-12"></a>    <span class="at">S_init =</span> <span class="fu">md</span>(<span class="st">"**Initial S**"</span>),</span>
<span id="cb47-13"><a href="#cb47-13"></a>    <span class="at">I_init =</span> <span class="fu">md</span>(<span class="st">"**Initial I**"</span>)</span>
<span id="cb47-14"><a href="#cb47-14"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb47-15"><a href="#cb47-15"></a>  <span class="co"># Apply style to the table with gray alternating rows</span></span>
<span id="cb47-16"><a href="#cb47-16"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">'gray'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb47-17"><a href="#cb47-17"></a>  <span class="co"># Increate space between columns</span></span>
<span id="cb47-18"><a href="#cb47-18"></a>  <span class="fu">opt_horizontal_padding</span>(<span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb47-19"><a href="#cb47-19"></a>  <span class="fu">cols_align</span>(<span class="st">"center"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="hbexotakij" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#hbexotakij table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#hbexotakij thead, #hbexotakij tbody, #hbexotakij tfoot, #hbexotakij tr, #hbexotakij td, #hbexotakij th {
  border-style: none;
}

#hbexotakij p {
  margin: 0;
  padding: 0;
}

#hbexotakij .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #000000;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#hbexotakij .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#hbexotakij .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#hbexotakij .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#hbexotakij .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hbexotakij .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
}

#hbexotakij .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #5F5F5F;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hbexotakij .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#hbexotakij .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#hbexotakij .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#hbexotakij .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#hbexotakij .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#hbexotakij .gt_spanner_row {
  border-bottom-style: hidden;
}

#hbexotakij .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #5F5F5F;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#hbexotakij .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #5F5F5F;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
  vertical-align: middle;
}

#hbexotakij .gt_from_md > :first-child {
  margin-top: 0;
}

#hbexotakij .gt_from_md > :last-child {
  margin-bottom: 0;
}

#hbexotakij .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: none;
  border-top-width: 1px;
  border-top-color: #D5D5D5;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D5D5D5;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D5D5D5;
  vertical-align: middle;
  overflow-x: hidden;
}

#hbexotakij .gt_stub {
  color: #FFFFFF;
  background-color: #5F5F5F;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #5F5F5F;
  padding-left: 15px;
  padding-right: 15px;
}

#hbexotakij .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#hbexotakij .gt_row_group_first td {
  border-top-width: 2px;
}

#hbexotakij .gt_row_group_first th {
  border-top-width: 2px;
}

#hbexotakij .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#hbexotakij .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #5F5F5F;
}

#hbexotakij .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#hbexotakij .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
}

#hbexotakij .gt_grand_summary_row {
  color: #333333;
  background-color: #D5D5D5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#hbexotakij .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #5F5F5F;
}

#hbexotakij .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #5F5F5F;
}

#hbexotakij .gt_striped {
  background-color: #F4F4F4;
}

#hbexotakij .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #5F5F5F;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #5F5F5F;
}

#hbexotakij .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hbexotakij .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#hbexotakij .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hbexotakij .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#hbexotakij .gt_left {
  text-align: left;
}

#hbexotakij .gt_center {
  text-align: center;
}

#hbexotakij .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#hbexotakij .gt_font_normal {
  font-weight: normal;
}

#hbexotakij .gt_font_bold {
  font-weight: bold;
}

#hbexotakij .gt_font_italic {
  font-style: italic;
}

#hbexotakij .gt_super {
  font-size: 65%;
}

#hbexotakij .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#hbexotakij .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#hbexotakij .gt_indent_1 {
  text-indent: 5px;
}

#hbexotakij .gt_indent_2 {
  text-indent: 10px;
}

#hbexotakij .gt_indent_3 {
  text-indent: 15px;
}

#hbexotakij .gt_indent_4 {
  text-indent: 20px;
}

#hbexotakij .gt_indent_5 {
  text-indent: 25px;
}

#hbexotakij .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#hbexotakij div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>
<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="gt_col_headings header">
<th id="site" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>Site</strong></th>
<th id="beta" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>Beta</strong></th>
<th id="gamma" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>Gamma</strong></th>
<th id="S_init" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>Initial S</strong></th>
<th id="I_init" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>Initial I</strong></th>
</tr></thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_center" headers="site">Site 1</td>
<td class="gt_row gt_center" headers="beta">5.854&nbsp;×&nbsp;10<sup>−3</sup>
</td>
<td class="gt_row gt_center" headers="gamma">81.150</td>
<td class="gt_row gt_center" headers="S_init">17,113.450</td>
<td class="gt_row gt_center" headers="I_init">0.786</td>
</tr>
<tr class="even">
<td class="gt_row gt_center gt_striped" headers="site">Site 2</td>
<td class="gt_row gt_center gt_striped" headers="beta">9.066&nbsp;×&nbsp;10<sup>−3</sup>
</td>
<td class="gt_row gt_center gt_striped" headers="gamma">77.613</td>
<td class="gt_row gt_center gt_striped" headers="S_init">11,030.375</td>
<td class="gt_row gt_center gt_striped" headers="I_init">0.142</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="site">Site 3</td>
<td class="gt_row gt_center" headers="beta">8.517&nbsp;×&nbsp;10<sup>−2</sup>
</td>
<td class="gt_row gt_center" headers="gamma">351.697</td>
<td class="gt_row gt_center" headers="S_init">4,462.286</td>
<td class="gt_row gt_center" headers="I_init">0.000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Getting new predictions from the optimized parameters and a new model run for each site.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb48" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>niamey_predictions_g <span class="ot">&lt;-</span> niamey_optims_g <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-3"><a href="#cb48-3"></a>    <span class="co"># For each of the different site's nested dataframes, fit the SIR model</span></span>
<span id="cb48-4"><a href="#cb48-4"></a>    <span class="co"># with the optimal parameters to get best fit predictions</span></span>
<span id="cb48-5"><a href="#cb48-5"></a>    <span class="at">predictions =</span> <span class="fu">pmap</span>(</span>
<span id="cb48-6"><a href="#cb48-6"></a>      <span class="at">.l =</span> <span class="fu">list</span>(</span>
<span id="cb48-7"><a href="#cb48-7"></a>        <span class="at">S_init =</span> S_init,</span>
<span id="cb48-8"><a href="#cb48-8"></a>        <span class="at">I_init =</span> I_init,</span>
<span id="cb48-9"><a href="#cb48-9"></a>        <span class="at">beta =</span> beta,</span>
<span id="cb48-10"><a href="#cb48-10"></a>        <span class="at">gamma =</span> gamma,</span>
<span id="cb48-11"><a href="#cb48-11"></a>        <span class="at">time_data =</span> data</span>
<span id="cb48-12"><a href="#cb48-12"></a>      ),</span>
<span id="cb48-13"><a href="#cb48-13"></a>      <span class="at">.f =</span> <span class="cf">function</span>(S_init, I_init, beta, gamma, time_data) {</span>
<span id="cb48-14"><a href="#cb48-14"></a>        site_times <span class="ot">&lt;-</span> time_data<span class="sc">$</span>biweek <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb48-15"><a href="#cb48-15"></a></span>
<span id="cb48-16"><a href="#cb48-16"></a>        in_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"beta"</span> <span class="ot">=</span> beta, <span class="st">"gamma"</span> <span class="ot">=</span> gamma)</span>
<span id="cb48-17"><a href="#cb48-17"></a>        <span class="co"># Return a dataframe of model solutions</span></span>
<span id="cb48-18"><a href="#cb48-18"></a>        <span class="fu">as_tibble</span>(<span class="fu">ode</span>(</span>
<span id="cb48-19"><a href="#cb48-19"></a>          <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> S_init, <span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb48-20"><a href="#cb48-20"></a>          <span class="at">times =</span> site_times,</span>
<span id="cb48-21"><a href="#cb48-21"></a>          <span class="at">func =</span> closed_sir_model_g,</span>
<span id="cb48-22"><a href="#cb48-22"></a>          <span class="at">parms =</span> in_parms,</span>
<span id="cb48-23"><a href="#cb48-23"></a>          <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb48-24"><a href="#cb48-24"></a>        )) <span class="sc">%&gt;%</span></span>
<span id="cb48-25"><a href="#cb48-25"></a>          <span class="co"># Make sure all values are numeric for plotting purposes</span></span>
<span id="cb48-26"><a href="#cb48-26"></a>          <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), as.numeric)) <span class="sc">%&gt;%</span></span>
<span id="cb48-27"><a href="#cb48-27"></a>          <span class="fu">mutate</span>(</span>
<span id="cb48-28"><a href="#cb48-28"></a>            <span class="at">incidence =</span> <span class="fu">ifelse</span>(</span>
<span id="cb48-29"><a href="#cb48-29"></a>              <span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb48-30"><a href="#cb48-30"></a>              new_inf[<span class="dv">1</span>],</span>
<span id="cb48-31"><a href="#cb48-31"></a>              <span class="fu">diff</span>(new_inf, <span class="at">lag =</span> <span class="dv">1</span>)</span>
<span id="cb48-32"><a href="#cb48-32"></a>            )</span>
<span id="cb48-33"><a href="#cb48-33"></a>          )</span>
<span id="cb48-34"><a href="#cb48-34"></a>      }</span>
<span id="cb48-35"><a href="#cb48-35"></a>    )</span>
<span id="cb48-36"><a href="#cb48-36"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-37"><a href="#cb48-37"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(data, predictions))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally we can plot:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb49" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="co"># Create a dataframe to store the positions of the text labels</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>niamey_preds_labels <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb49-3"><a href="#cb49-3"></a>  <span class="at">site =</span> <span class="fu">c</span>(<span class="st">"Site_1"</span>, <span class="st">"Site_2"</span>),</span>
<span id="cb49-4"><a href="#cb49-4"></a>  <span class="at">x_label =</span> <span class="fu">c</span>(<span class="fl">6.5</span>, <span class="fl">6.5</span>),</span>
<span id="cb49-5"><a href="#cb49-5"></a>  <span class="at">x_arrow_just =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>),</span>
<span id="cb49-6"><a href="#cb49-6"></a>  <span class="at">x_arrow_end =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="fl">7.75</span>),</span>
<span id="cb49-7"><a href="#cb49-7"></a>  <span class="at">y_label =</span> <span class="fu">c</span>(<span class="dv">900</span>, <span class="dv">600</span>),</span>
<span id="cb49-8"><a href="#cb49-8"></a>  <span class="at">y_arrow_just =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">80</span>, <span class="sc">-</span><span class="dv">70</span>),</span>
<span id="cb49-9"><a href="#cb49-9"></a>  <span class="at">y_arrow_end =</span> <span class="fu">c</span>(<span class="dv">350</span>, <span class="dv">290</span>),</span>
<span id="cb49-10"><a href="#cb49-10"></a>  <span class="at">commentary =</span> <span class="fu">c</span>(<span class="st">"**Predicted"</span>, <span class="st">"**Observed"</span>),</span>
<span id="cb49-11"><a href="#cb49-11"></a>  <span class="at">color =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, niamey_site_colors[<span class="st">"Site_2"</span>])</span>
<span id="cb49-12"><a href="#cb49-12"></a>)</span>
<span id="cb49-13"><a href="#cb49-13"></a></span>
<span id="cb49-14"><a href="#cb49-14"></a><span class="fu">ggplot</span>(niamey_predictions_g, <span class="fu">aes</span>(<span class="at">x =</span> biweek, <span class="at">group =</span> site)) <span class="sc">+</span></span>
<span id="cb49-15"><a href="#cb49-15"></a>  <span class="co"># Plot the actual data in color</span></span>
<span id="cb49-16"><a href="#cb49-16"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> cases, <span class="at">color =</span> site)) <span class="sc">+</span></span>
<span id="cb49-17"><a href="#cb49-17"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> cases, <span class="at">color =</span> site), <span class="at">size =</span> <span class="dv">4</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb49-18"><a href="#cb49-18"></a>  <span class="co"># Plot the best-fit model predictions in black</span></span>
<span id="cb49-19"><a href="#cb49-19"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> incidence), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb49-20"><a href="#cb49-20"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb49-21"><a href="#cb49-21"></a>    <span class="at">values =</span> niamey_site_colors,</span>
<span id="cb49-22"><a href="#cb49-22"></a>    <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">"color"</span>, <span class="st">"fill"</span>)</span>
<span id="cb49-23"><a href="#cb49-23"></a>  ) <span class="sc">+</span></span>
<span id="cb49-24"><a href="#cb49-24"></a>  <span class="co"># Place each site on it's own subplot and change labels</span></span>
<span id="cb49-25"><a href="#cb49-25"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb49-26"><a href="#cb49-26"></a>    <span class="sc">~</span>site,</span>
<span id="cb49-27"><a href="#cb49-27"></a>    <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb49-28"><a href="#cb49-28"></a>    <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb49-29"><a href="#cb49-29"></a>    <span class="at">labeller =</span> <span class="fu">as_labeller</span>(niamey_site_labels)</span>
<span id="cb49-30"><a href="#cb49-30"></a>  ) <span class="sc">+</span></span>
<span id="cb49-31"><a href="#cb49-31"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Biweek"</span>, <span class="at">y =</span> <span class="st">"Number of Case"</span>) <span class="sc">+</span></span>
<span id="cb49-32"><a href="#cb49-32"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb49-33"><a href="#cb49-33"></a>  ggtext<span class="sc">::</span><span class="fu">geom_textbox</span>(</span>
<span id="cb49-34"><a href="#cb49-34"></a>    <span class="at">data =</span> niamey_preds_labels,</span>
<span id="cb49-35"><a href="#cb49-35"></a>    <span class="fu">aes</span>(</span>
<span id="cb49-36"><a href="#cb49-36"></a>      <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb49-37"><a href="#cb49-37"></a>        <span class="st">"&lt;span style = </span><span class="sc">\"</span><span class="st">color:"</span>,</span>
<span id="cb49-38"><a href="#cb49-38"></a>        color,</span>
<span id="cb49-39"><a href="#cb49-39"></a>        <span class="st">"</span><span class="sc">\"</span><span class="st">&gt;"</span>,</span>
<span id="cb49-40"><a href="#cb49-40"></a>        commentary,</span>
<span id="cb49-41"><a href="#cb49-41"></a>        <span class="st">" Cases**"</span>,</span>
<span id="cb49-42"><a href="#cb49-42"></a>        <span class="st">"&lt;/span&gt;"</span></span>
<span id="cb49-43"><a href="#cb49-43"></a>      ),</span>
<span id="cb49-44"><a href="#cb49-44"></a>      <span class="at">x =</span> x_label,</span>
<span id="cb49-45"><a href="#cb49-45"></a>      <span class="at">y =</span> y_label</span>
<span id="cb49-46"><a href="#cb49-46"></a>    ),</span>
<span id="cb49-47"><a href="#cb49-47"></a>    <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb49-48"><a href="#cb49-48"></a>    <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb49-49"><a href="#cb49-49"></a>    <span class="at">box.colour =</span> <span class="cn">NA</span></span>
<span id="cb49-50"><a href="#cb49-50"></a>  ) <span class="sc">+</span></span>
<span id="cb49-51"><a href="#cb49-51"></a>  <span class="fu">geom_curve</span>(</span>
<span id="cb49-52"><a href="#cb49-52"></a>    <span class="at">data =</span> niamey_preds_labels,</span>
<span id="cb49-53"><a href="#cb49-53"></a>    <span class="fu">aes</span>(</span>
<span id="cb49-54"><a href="#cb49-54"></a>      <span class="at">x =</span> x_label <span class="sc">+</span> x_arrow_just,</span>
<span id="cb49-55"><a href="#cb49-55"></a>      <span class="at">xend =</span> x_arrow_end,</span>
<span id="cb49-56"><a href="#cb49-56"></a>      <span class="at">y =</span> y_label <span class="sc">+</span> y_arrow_just,</span>
<span id="cb49-57"><a href="#cb49-57"></a>      <span class="at">yend =</span> y_arrow_end</span>
<span id="cb49-58"><a href="#cb49-58"></a>    ),</span>
<span id="cb49-59"><a href="#cb49-59"></a>    <span class="at">linewidth =</span> <span class="fl">0.75</span>,</span>
<span id="cb49-60"><a href="#cb49-60"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>)),</span>
<span id="cb49-61"><a href="#cb49-61"></a>    <span class="at">curvature =</span> <span class="fu">list</span>(<span class="fl">0.25</span>),</span>
<span id="cb49-62"><a href="#cb49-62"></a>    <span class="at">color =</span> <span class="st">"grey20"</span></span>
<span id="cb49-63"><a href="#cb49-63"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="r-session-03_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="exercise-6-1" class="level3" data-number="8.10.6"><h3 data-number="8.10.6" class="anchored" data-anchor-id="exercise-6-1">
<span class="header-section-number">8.10.6</span> Exercise 6</h3>
<p>What happens if one or both of the other unknowns (<span class="math inline">\(X_0\)</span> and <span class="math inline">\(Y_0\)</span>) is fixed instead of <span class="math inline">\(\gamma\)</span>?</p>
<section id="solutions-coming-soon" class="level4" data-number="8.10.6.1"><h4 data-number="8.10.6.1" class="anchored" data-anchor-id="solutions-coming-soon">
<span class="header-section-number">8.10.6.1</span> Solutions coming soon!</h4>
<p>First we modify the <code>sse_sir_g</code> function again to fix <span class="math inline">\(X_0\)</span> and <span class="math inline">\(Y_0\)</span> (or both)</p>
<p>Now we can run the optim algorithm and find the best parameters for the SIR model for each of the scenario.</p>
<p>First, for S0 fixed:</p>
<p>Second, for I0 fixed:</p>
<p>Third, for fixing both S0 and I0:</p>
<p>Now let’s pass these models through <code>optim</code> and fit the models:</p>
<!-- -->



<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-drakeEstimation2019" class="csl-entry" role="listitem">
Drake, John M, and Pejman Rohani. 2019. <span>“Estimation.”</span> In. <span>Seattle, Washington</span>. <a href="http://daphnia.ecology.uga.edu/drakelab/wp-content/uploads/2019/07/estimation.pdf">http://daphnia.ecology.uga.edu/drakelab/wp-content/uploads/2019/07/estimation.pdf</a>.
</div>
<div id="ref-graisEstimatingTransmissionIntensity2006" class="csl-entry" role="listitem">
Grais, R. F., M. J. Ferrari, C. Dubray, O. N. Bjørnstad, B. T. Grenfell, A. Djibo, F. Fermon, and P. J. Guerin. 2006. <span>“Estimating Transmission Intensity for a Measles Epidemic in <span>Niamey</span>, <span>Niger</span>: Lessons for Intervention.”</span> <em>Transactions of The Royal Society of Tropical Medicine and Hygiene</em> 100 (9): 867–73. <a href="https://doi.org/10.1016/j.trstmh.2005.10.014">https://doi.org/10.1016/j.trstmh.2005.10.014</a>.
</div>
<div id="ref-keelingIntroductionSimpleEpidemic2008" class="csl-entry" role="listitem">
Keeling, Matthew James, and Pejman Rohani. 2008. <span>“Introduction to Simple Epidemic Models.”</span> In <em>Modeling Infectious Diseases in Humans and Animals</em>, 21–22. <span>Princeton</span>: <span>Princeton University Press</span>.
</div>
</div>
</section></section></section></main><!-- /main --><script type="ojs-module-contents">
eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImZpbHRlcmVkX25pYW1leV9kYXRhID0gYXEudGFibGUobmlhbWV5X2RhdGEpXG4gICAgLmZpbHRlcihhcS5lc2NhcGUoZCA9PiBkLnNpdGUgPT0gc2l0ZV9zZWxlY3QpKVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0yIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoicmVzZXRfUyA9IDEwMDAwXG5yZXNldF9JID0gMjBcbnJlc2V0X2JldGEgPSA1LjAwXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTMiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJmdW5jdGlvbiBzZXQoaW5wdXQsIHZhbHVlKSB7XG4gIGlucHV0LnZhbHVlID0gdmFsdWU7XG4gIGlucHV0LmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KFwiaW5wdXRcIiwge2J1YmJsZXM6IHRydWV9KSk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTQiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJmdW5jdGlvbiBzc2Uob2JzLCBwcmVkcykge1xuXG4gICAgaWYob2JzLmxlbmd0aCA9PSBwcmVkcy5sZW5ndGgpIHtcbiAgICAgICAgdmFyIHNxdWFyZWRfZXJycyA9IG9icy5tYXAoKGUsIGkpID0+IChlIC0gcHJlZHNbaV0pKioyIClcbiAgICAgICAgcmV0dXJuIHNxdWFyZWRfZXJycy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKVxuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybihcImxlbmd0aHMgYXJlIG5vdCB0aGUgc2FtZVwiKVxuICAgIH1cbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InZpZXdvZiByZXNldCA9IElucHV0cy5idXR0b24oW1xuICBbXCJSZXNldCBhbGwgc2xpZGVyc1wiLCAoKSA9PiB7XG4gICAgc2V0KHZpZXdvZiBTMCwgcmVzZXRfUylcbiAgICBzZXQodmlld29mIEkwLCByZXNldF9JKVxuICAgIHNldCh2aWV3b2YgYmV0YV9pbnB1dCwgcmVzZXRfYmV0YSlcbiAgfV1cbl0pXG52aWV3b2YgUzAgPSBJbnB1dHMucmFuZ2UoXG4gICAgWzUwMCwgMTUwMDBdLFxuICAgIHt2YWx1ZTogcmVzZXRfUywgc3RlcDogMSwgbGFiZWw6IG1kYCR7dGV4YFMoMClgfWB9XG4pXG5cbnZpZXdvZiBJMCA9IElucHV0cy5yYW5nZShcbiAgICBbMC4wMDEsIDUwXSxcbiAgICB7dmFsdWU6IHJlc2V0X0ksIHN0ZXA6IDAuMDAxLCBsYWJlbDogbWRgJHt0ZXhgSSgwKWB9YH1cbilcblxudmlld29mIGJldGFfaW5wdXQgPSBJbnB1dHMucmFuZ2UoXG4gICAgWzEsIDEwMF0sXG4gICAge3ZhbHVlOiByZXNldF9iZXRhLCBzdGVwOiAwLjAwMSwgbGFiZWw6IG1kYCR7dGV4YFxcYmV0YSAoXFx0aW1lcyAxMF57LTN9KWB9YH1cbilcblxudmlld29mIHNpdGVfc2VsZWN0ID0gSW5wdXRzLnNlbGVjdChcbiAgICBbXCJTaXRlIDFcIiwgXCJTaXRlIDJcIiwgXCJTaXRlIDNcIl0sXG4gICAge2xhYmVsOiBcIlNlbGVjdCBhIHNpdGU6XCJ9XG4pXG5cbi8vIGNvbnZlcnQgdG8gZGFpbHkgdGltZSBzY2FsZSBhcyBlYXNpZXIgdG8gbWFuaXB1bGF0ZVxuYmV0YSA9IChiZXRhX2lucHV0IC8gMzY1KSAqICgxMCAqKiAoLTMpKVxuXG5tZGAke3RleGBSXzAgPSAke1IwX3N0cn1gfWBcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImR1cl9pbmYgPSAxNFxuZ2FtbWEgPSAxIC8gZHVyX2luZlxuUjAgPSBiZXRhICogKFMwICsgSTApLyBnYW1tYVxuXG5SMF9zdHIgPSBSMC50b1ByZWNpc2lvbigyKS50b0xvY2FsZVN0cmluZygpXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJkdCA9IDAuMDFcbnRtYXggPSAxNiAqIDE0XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTgiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJpbXBvcnQge29kZVJLNH0gZnJvbSAnQHJyZXVzc2VyL2ludGVncmF0aW9uQDMwNjQnXG5pbXBvcnQgeyBhcSwgb3AgfSBmcm9tICdAdXdkYXRhL2FycXVlcm8nXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTkiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJmdW5jdGlvbiBzaXIoZHlkdCwgeSwgdCkge1xuICAgIGR5ZHRbM10gPSBiZXRhICogeVswXSAqIHlbMV1cblxuICAgIGR5ZHRbMF0gPSAtIGR5ZHRbM11cbiAgICBkeWR0WzFdID0gZHlkdFszXSAtIGdhbW1hICogeVsxXVxuICAgIGR5ZHRbMl0gPSBnYW1tYSAqIHlbMV1cbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTAiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJmdW5jdGlvbiBzaW11bGF0ZShmLCB0MCwgeTAsIGR0LCB0bWF4KSB7XG4gICAgdmFyIHQgPSB0MFxuICAgIHZhciB5ID0geTBcbiAgICB2YXIgaSA9IDBcblxuICAgIHZhciB5c2ltID0gW3kwXVxuXG4gICAgZm9yICh0ID0gdDAgKyBkdDsgdCA8PSB0bWF4OyB0ICs9IGR0KSB7XG4gICAgICAgIHlzaW0ucHVzaChvZGVSSzQoW10sIHlzaW1baV0sIGYsIGR0KSlcbiAgICAgICAgaSArPSAxXG4gICAgfVxuXG4gICAgLy8gcmV0dXJuIGN1bXVsYXRpdmUgaW5mZWN0aW9uc1xuICAgIHJldHVybiB5c2ltLm1hcChkID0+IGRbM10pXG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTExIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoic2lyX3NvbCA9IHNpbXVsYXRlKHNpciwgMCwgW1MwLCBJMCwgMC4wLCAwLjBdLCBkdCwgdG1heClcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTIiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJzaXRlQ29sb3JzID0gW1wiIzFiOWU3N1wiLCBcIiNkOTVmMDJcIiwgXCIjNzU3MGIzXCJdXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTEzIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gQ3JlYXRlIGFuIGFycmF5IG9mIHRpbWUgaW5kaWNlcywgZHJvcHBpbmcgZmlyc3QgYXMgZnJvbSByZXR1cm5zIGluZGV4IDAsIHdoaWNoXG4vLyBkb2Vzbid0IGV4aXN0IGluIHRoZSByZWFsIGRhdGFcbnRpbWVzID0gQXJyYXkuZnJvbSh7bGVuZ3RoOiAxN30sIChfLCBpKSA9PiBpICogMTQpLnNsaWNlKDEpXG50aW5kZXggPSB0aW1lcy5tYXAoKGUsIGkpID0+IGUgKiAoMSAvIGR0KSlcblxuY3VtX2luYyA9IHRpbmRleC5tYXAoKGkpID0+IHNpcl9zb2xbaV0pXG5cbnByZWRzID0gW2N1bV9pbmNbMF0gKyBJMCwgLi4uY3VtX2luYy5tYXAoKGUsIGkpID0+IGN1bV9pbmNbaV0gLSBjdW1faW5jW2ktMV0pLnNsaWNlKDEpXVxuXG5zaXJfdGJsID0gYXEudGFibGUoe1xuICAgIEJpd2VlazogdGltZXMubWFwKHQgPT4gdCAvIDE0KSxcbiAgICBcIkN1bXVsYXRpdmUgSW5jaWRlbmNlXCI6IGN1bV9pbmMsXG4gICAgXCJOdW1iZXIgb2YgSW5kaXZpZHVhbHNcIjogcHJlZHNcbn0pXG5cbnNpbV9zc2UgPSBbKHtcbiAgICBzc2U6IHNzZShcbiAgICAgICAgICAgIGZpbHRlcmVkX25pYW1leV9kYXRhLmFycmF5KFwiTnVtYmVyIG9mIEluZGl2aWR1YWxzXCIpLFxuICAgICAgICAgICAgcHJlZHNcbiAgICAgICAgKS50b1ByZWNpc2lvbig0KSxcbiAgICBCaXdlZWs6IDMsXG4gICAgXCJOdW1iZXIgb2YgSW5kaXZpZHVhbHNcIjogTWF0aC5tYXgoXG4gICAgICAgIC4uLnNpcl90YmwuYXJyYXkoXCJOdW1iZXIgb2YgSW5kaXZpZHVhbHNcIiksXG4gICAgICAgIC4uLmZpbHRlcmVkX25pYW1leV9kYXRhLmFycmF5KFwiTnVtYmVyIG9mIEluZGl2aWR1YWxzXCIpXG4gICAgKSAqIDAuOVxufSldXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE0IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiUGxvdC5wbG90KHtcbiAgICBjb2xvcjoge1xuICAgICAgICBsZWdlbmQ6IHRydWUsXG4gICAgICAgIGRvbWFpbjogW1wiU2l0ZSAxXCIsIFwiU2l0ZSAyXCIsIFwiU2l0ZSAzXCJdLFxuICAgICAgICByYW5nZTogc2l0ZUNvbG9ycyxcbiAgICB9LFxuICAgIHN0eWxlOiB7Zm9udFNpemU6IFwiMjBweFwifSxcbiAgICBtYXJnaW5MZWZ0OiA3NSxcbiAgICBtYXJnaW5Ub3A6IDQwLFxuICAgIG1hcmdpbkJvdHRvbTogNTUsXG4gICAgZ3JpZDogdHJ1ZSxcbiAgICB3aWR0aDogODAwLFxuICAgIGhlaWdodDogNjcwLFxuICAgIG1hcmtzOiBbXG4gICAgICAgIFBsb3QubGluZVkoXG4gICAgICAgICAgICBzaXJfdGJsLFxuICAgICAgICAgICAge3g6IFwiQml3ZWVrXCIsIHk6IFwiTnVtYmVyIG9mIEluZGl2aWR1YWxzXCIsIHN0cm9rZTogXCIjNGQ0ZDRkZmZcIiwgc3Ryb2tlV2lkdGg6IDYsIHN0cm9rZU9wYWNpdHk6IDAuOH1cbiAgICAgICAgKSxcbiAgICAgICAgUGxvdC5kb3QoXG4gICAgICAgICAgICBmaWx0ZXJlZF9uaWFtZXlfZGF0YSxcbiAgICAgICAgICAgIHt4OiBcIkJpd2Vla1wiLCB5OiBcIk51bWJlciBvZiBJbmRpdmlkdWFsc1wiLCBzdHJva2U6IFwic2l0ZVwiLCBmaWxsOiBcInNpdGVcIiwgZmlsbE9wYWNpdHk6IDAuNiwgcjogMTJ9XG4gICAgICAgICksXG4gICAgICAgIFBsb3QubGluZVkoXG4gICAgICAgICAgICBmaWx0ZXJlZF9uaWFtZXlfZGF0YSxcbiAgICAgICAgICAgIHt4OiBcIkJpd2Vla1wiLCB5OiBcIk51bWJlciBvZiBJbmRpdmlkdWFsc1wiLCBzdHJva2U6IFwic2l0ZVwifVxuICAgICAgICApLFxuICAgICAgICBQbG90LnRleHQoXG4gICAgICAgICAgICBzaW1fc3NlLFxuICAgICAgICAgICAge3g6IFwiQml3ZWVrXCIsIHk6IFwiTnVtYmVyIG9mIEluZGl2aWR1YWxzXCIsIHRleHQ6IChkKSA9PiBgU1NFID0gJHtkLnNzZX1gLCBkeDogMCwgZHk6IDAsIGZvbnRXZWlnaHQ6IFwiYm9sZFwifVxuICAgICAgICApXG4gICAgXVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgncmVzZXQnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnUzAnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnSTAnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnYmV0YV9pbnB1dCcpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdzaXRlX3NlbGVjdCcpIn1dfQ==
</script><script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../..";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./L06_parameter-estimation.html" class="pagination-link" aria-label="Parameter Estimation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Parameter Estimation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./L08_stochastic-models.html" class="pagination-link" aria-label="Stochastic Models">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Stochastic Models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb50" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb50-1"><a href="#cb50-1"></a><span class="co">---</span></span>
<span id="cb50-2"><a href="#cb50-2"></a><span class="an">subtitle:</span><span class="co"> "Estimation"</span></span>
<span id="cb50-3"><a href="#cb50-3"></a><span class="an">abstract-title:</span><span class="co"> ""</span></span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="an">abstract:</span><span class="co"> |</span></span>
<span id="cb50-5"><a href="#cb50-5"></a><span class="co">    *Materials adapted from John Drake and Pej Rohani [@drakeEstimation2019]*</span></span>
<span id="cb50-6"><a href="#cb50-6"></a><span class="an">execute:</span></span>
<span id="cb50-7"><a href="#cb50-7"></a><span class="co">    warning: false</span></span>
<span id="cb50-8"><a href="#cb50-8"></a><span class="an">metadata-files:</span></span>
<span id="cb50-9"><a href="#cb50-9"></a><span class="co">    - metadata/matthewferrari.yml</span></span>
<span id="cb50-10"><a href="#cb50-10"></a><span class="co">    - metadata/mathjax-packages.yml</span></span>
<span id="cb50-11"><a href="#cb50-11"></a><span class="an">editor:</span></span>
<span id="cb50-12"><a href="#cb50-12"></a><span class="co">  markdown:</span></span>
<span id="cb50-13"><a href="#cb50-13"></a><span class="co">    wrap: sentence</span></span>
<span id="cb50-14"><a href="#cb50-14"></a><span class="co">---</span></span>
<span id="cb50-15"><a href="#cb50-15"></a></span>
<span id="cb50-16"><a href="#cb50-16"></a><span class="fu"># R Session 03</span></span>
<span id="cb50-17"><a href="#cb50-17"></a></span>
<span id="cb50-18"><a href="#cb50-18"></a><span class="fu">## Setup</span></span>
<span id="cb50-19"><a href="#cb50-19"></a></span>
<span id="cb50-22"><a href="#cb50-22"></a><span class="in">```{r}</span></span>
<span id="cb50-23"><a href="#cb50-23"></a><span class="fu">library</span>(here)</span>
<span id="cb50-24"><a href="#cb50-24"></a><span class="fu">library</span>(rio)</span>
<span id="cb50-25"><a href="#cb50-25"></a><span class="fu">library</span>(deSolve)</span>
<span id="cb50-26"><a href="#cb50-26"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb50-27"><a href="#cb50-27"></a><span class="fu">library</span>(ggtext)</span>
<span id="cb50-28"><a href="#cb50-28"></a><span class="fu">library</span>(gt)</span>
<span id="cb50-29"><a href="#cb50-29"></a><span class="in">```</span></span>
<span id="cb50-30"><a href="#cb50-30"></a></span>
<span id="cb50-33"><a href="#cb50-33"></a><span class="in">```{r}</span></span>
<span id="cb50-34"><a href="#cb50-34"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb50-35"><a href="#cb50-35"></a><span class="in">```</span></span>
<span id="cb50-36"><a href="#cb50-36"></a></span>
<span id="cb50-39"><a href="#cb50-39"></a><span class="in">```{r}</span></span>
<span id="cb50-40"><a href="#cb50-40"></a><span class="co"># Loads the datasets: flu, measles, niamey, plauge</span></span>
<span id="cb50-41"><a href="#cb50-41"></a>flu <span class="ot">&lt;-</span> rio<span class="sc">::</span><span class="fu">import</span>(</span>
<span id="cb50-42"><a href="#cb50-42"></a>  <span class="st">"https://raw.githubusercontent.com/arnold-c/SISMID-Module-02_2025/main/data/flu.csv"</span></span>
<span id="cb50-43"><a href="#cb50-43"></a>)</span>
<span id="cb50-44"><a href="#cb50-44"></a>niamey <span class="ot">&lt;-</span> rio<span class="sc">::</span><span class="fu">import</span>(</span>
<span id="cb50-45"><a href="#cb50-45"></a>  <span class="st">"https://raw.githubusercontent.com/arnold-c/SISMID-Module-02_2025/main/data/niamey.csv"</span></span>
<span id="cb50-46"><a href="#cb50-46"></a>)</span>
<span id="cb50-47"><a href="#cb50-47"></a><span class="co"># flu &lt;- rio::import(here::here("data", "flu.csv"))</span></span>
<span id="cb50-48"><a href="#cb50-48"></a><span class="co"># niamey &lt;- rio::import(here::here("data", "niamey.csv"))</span></span>
<span id="cb50-49"><a href="#cb50-49"></a><span class="in">```</span></span>
<span id="cb50-50"><a href="#cb50-50"></a></span>
<span id="cb50-51"><a href="#cb50-51"></a><span class="fu">## Estimating $R_0$ Problem Background</span></span>
<span id="cb50-52"><a href="#cb50-52"></a></span>
<span id="cb50-53"><a href="#cb50-53"></a>So far in this class we have focused on the **theory** of infectious disease.</span>
<span id="cb50-54"><a href="#cb50-54"></a>Often, however, we will want to apply this theory to particular situations.</span>
<span id="cb50-55"><a href="#cb50-55"></a>One of the key applied problems in epidemic modeling is the estimation of $R_0$ from outbreak data.</span>
<span id="cb50-56"><a href="#cb50-56"></a>In this session, we study two methods for estimating $R_0$ from an epidemic curve.</span>
<span id="cb50-57"><a href="#cb50-57"></a>As a running example, we will use the data on influenza in a British boarding school.</span>
<span id="cb50-58"><a href="#cb50-58"></a></span>
<span id="cb50-61"><a href="#cb50-61"></a><span class="in">```{r}</span></span>
<span id="cb50-62"><a href="#cb50-62"></a><span class="co">#| column: body</span></span>
<span id="cb50-63"><a href="#cb50-63"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb50-64"><a href="#cb50-64"></a><span class="fu">ggplot</span>(flu, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> flu)) <span class="sc">+</span></span>
<span id="cb50-65"><a href="#cb50-65"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"slategray4"</span>) <span class="sc">+</span></span>
<span id="cb50-66"><a href="#cb50-66"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">21</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">fill =</span> <span class="st">"slategray4"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb50-67"><a href="#cb50-67"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Active Influenza Cases"</span>)</span>
<span id="cb50-68"><a href="#cb50-68"></a><span class="in">```</span></span>
<span id="cb50-69"><a href="#cb50-69"></a></span>
<span id="cb50-70"><a href="#cb50-70"></a><span class="fu">## Estimating $R_0$ From The Final Outbreak Size</span></span>
<span id="cb50-71"><a href="#cb50-71"></a></span>
<span id="cb50-72"><a href="#cb50-72"></a>Our first approach is to estimate $R_0$ from the final outbreak size.</span>
<span id="cb50-73"><a href="#cb50-73"></a>Although unhelpful at the early stages of an epidemic (before the final epidemic size is observed), this method is nonetheless a useful tool for *post hoc* analysis.</span>
<span id="cb50-74"><a href="#cb50-74"></a>The method is general and can be motivated by the argument listed in <span class="co">[</span><span class="ot">@keelingIntroductionSimpleEpidemic2008</span><span class="co">]</span>:</span>
<span id="cb50-75"><a href="#cb50-75"></a></span>
<span id="cb50-76"><a href="#cb50-76"></a>First, we assume that the epidemic is started by a single infectious individual in a completely susceptible population.</span>
<span id="cb50-77"><a href="#cb50-77"></a>On average, this individual infects $R_0$ others.</span>
<span id="cb50-78"><a href="#cb50-78"></a>The probability a particular individual escaped infection is therefore $e^{-R_0 / N}$.</span>
<span id="cb50-79"><a href="#cb50-79"></a></span>
<span id="cb50-80"><a href="#cb50-80"></a>If $Z$ individuals have been infected, the probability of an individual escaping infection from all potential sources is $e^{-Z R_0 / N}$.</span>
<span id="cb50-81"><a href="#cb50-81"></a>It follows that at the end of the epidemic a proportion $R(\infty) = Z / N$ have been infected and the fraction remaining susceptible is $S(\infty) = e^{-R(\infty) R_0}$, which is equal to $1 - R(\infty)$.</span>
<span id="cb50-82"><a href="#cb50-82"></a></span>
<span id="cb50-83"><a href="#cb50-83"></a>::: {.callout-note collapse="true"}</span>
<span id="cb50-84"><a href="#cb50-84"></a>$S(\infty) = e^{-R(\infty) R_0}$ can be calculated by acknowledging that at equilibrium ($t = \infty$), $S(\infty) = 1 - R(\infty) = Z / N$, so substituting $R(\infty)$ into $1 - e^{-Z R_0 / N}$ gives the desired result.</span>
<span id="cb50-85"><a href="#cb50-85"></a></span>
<span id="cb50-86"><a href="#cb50-86"></a>It could also be calculated by dividing $\frac{\dd{S}}{\dd{t}}$ by $\frac{\dd{R}}{\dd{t}}$:</span>
<span id="cb50-87"><a href="#cb50-87"></a></span>
<span id="cb50-88"><a href="#cb50-88"></a><span class="in">```{=tex}</span></span>
<span id="cb50-89"><a href="#cb50-89"></a><span class="in">\begin{aligned}</span></span>
<span id="cb50-90"><a href="#cb50-90"></a><span class="in">\frac{\dd{S}}{\dd{R}} &amp;= - \frac{\beta S}{\gamma} \\</span></span>
<span id="cb50-91"><a href="#cb50-91"></a><span class="in">&amp;= - R_0 S</span></span>
<span id="cb50-92"><a href="#cb50-92"></a><span class="in">\end{aligned}</span></span>
<span id="cb50-93"><a href="#cb50-93"></a><span class="in">```</span></span>
<span id="cb50-94"><a href="#cb50-94"></a>which is a <span class="co">[</span><span class="ot">separable differential equation</span><span class="co">](https://tutorial.math.lamar.edu/classes/de/separable.aspx)</span>, so can be integrated as follows:</span>
<span id="cb50-95"><a href="#cb50-95"></a></span>
<span id="cb50-96"><a href="#cb50-96"></a><span class="in">```{=tex}</span></span>
<span id="cb50-97"><a href="#cb50-97"></a><span class="in">\begin{aligned}</span></span>
<span id="cb50-98"><a href="#cb50-98"></a><span class="in">- \int_{0}^{t} \frac{1}{R_0 S} \dd{S} &amp;= \int_{0}^{t} \dd{R} \\</span></span>
<span id="cb50-99"><a href="#cb50-99"></a><span class="in">- \frac{1}{R_0} \left(\ln{S(t)} - \ln{S(0)} \right) &amp;= R(t) - \cancelto{0}{R(0)} \\</span></span>
<span id="cb50-100"><a href="#cb50-100"></a><span class="in">\ln{S(t)} &amp;= \ln{S(0)} - R_0 R(t) \\</span></span>
<span id="cb50-101"><a href="#cb50-101"></a><span class="in">S(t) &amp;= S(0) e^{-R_0 R(t)}</span></span>
<span id="cb50-102"><a href="#cb50-102"></a></span>
<span id="cb50-103"><a href="#cb50-103"></a><span class="in">\end{aligned}</span></span>
<span id="cb50-104"><a href="#cb50-104"></a><span class="in">```</span></span>
<span id="cb50-105"><a href="#cb50-105"></a>:::</span>
<span id="cb50-106"><a href="#cb50-106"></a></span>
<span id="cb50-107"><a href="#cb50-107"></a>Putting this together, we get:</span>
<span id="cb50-108"><a href="#cb50-108"></a></span>
<span id="cb50-109"><a href="#cb50-109"></a>$$</span>
<span id="cb50-110"><a href="#cb50-110"></a>1 - R(\infty) - e^{-R(\infty) R_0} = 0</span>
<span id="cb50-111"><a href="#cb50-111"></a>$$</span>
<span id="cb50-112"><a href="#cb50-112"></a></span>
<span id="cb50-113"><a href="#cb50-113"></a>Rearranging, we have the estimator</span>
<span id="cb50-114"><a href="#cb50-114"></a></span>
<span id="cb50-115"><a href="#cb50-115"></a>$$</span>
<span id="cb50-116"><a href="#cb50-116"></a>  \hat{R_0} = \frac{\ln(1 - Z / N)}{-Z / N},</span>
<span id="cb50-117"><a href="#cb50-117"></a>$$</span>
<span id="cb50-118"><a href="#cb50-118"></a></span>
<span id="cb50-119"><a href="#cb50-119"></a>which, in this case, evaluates to $\frac{\ln(1 - 512 / 764)}{-512 / 764} = 1.655$.</span>
<span id="cb50-120"><a href="#cb50-120"></a></span>
<span id="cb50-121"><a href="#cb50-121"></a>::: exercise</span>
<span id="cb50-122"><a href="#cb50-122"></a><span class="fu">### Exercise 1</span></span>
<span id="cb50-123"><a href="#cb50-123"></a>:::</span>
<span id="cb50-124"><a href="#cb50-124"></a></span>
<span id="cb50-125"><a href="#cb50-125"></a>This equation shows the important one-to-one relationship between $R_0$ and the final epidemic size.</span>
<span id="cb50-126"><a href="#cb50-126"></a>Plot the relationship between the total epidemic size and $R_0$ for the complete range of values between 0 and 1.</span>
<span id="cb50-127"><a href="#cb50-127"></a></span>
<span id="cb50-128"><a href="#cb50-128"></a><span class="fu">## Linear Approximation</span></span>
<span id="cb50-129"><a href="#cb50-129"></a></span>
<span id="cb50-130"><a href="#cb50-130"></a>The next method we introduce takes advantage of the fact that during the early stages of an outbreak, the number of infected individuals is given approximately as $I(t) \approx I_0 e^{((R_0 - 1)(\gamma + \mu)t)}$.</span>
<span id="cb50-131"><a href="#cb50-131"></a>Taking logarithms of both sides, we have $\ln(I(t)) \approx \ln(I_0) + (R_0 - 1)(\gamma + \mu)t$, showing that the log of the number of infected individuals is approximately linear in time with a slope that reflects both $R_0$ and the recovery rate.</span>
<span id="cb50-132"><a href="#cb50-132"></a></span>
<span id="cb50-133"><a href="#cb50-133"></a>This suggests that a simple linear regression fit to the first several data points on a log-scale, corrected to account for $\gamma$ and $\mu$, provides a rough and ready estimate of $R_0$.</span>
<span id="cb50-134"><a href="#cb50-134"></a>For flu, we can assume $\mu =0$ because the epidemic occurred over a time period during which natural mortality is negligible.</span>
<span id="cb50-135"><a href="#cb50-135"></a>Further, assuming an infectious period of about 2.5 days, we use $\gamma = (2.5)^{-1} = 0.4$ for the correction.</span>
<span id="cb50-136"><a href="#cb50-136"></a>Fitting to the first four data points, we obtain the slope as follows.</span>
<span id="cb50-137"><a href="#cb50-137"></a></span>
<span id="cb50-140"><a href="#cb50-140"></a><span class="in">```{r}</span></span>
<span id="cb50-141"><a href="#cb50-141"></a><span class="co"># Fit a linear model</span></span>
<span id="cb50-142"><a href="#cb50-142"></a>linear_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(flu[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">~</span> day[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="at">data =</span> flu)</span>
<span id="cb50-143"><a href="#cb50-143"></a></span>
<span id="cb50-144"><a href="#cb50-144"></a><span class="co"># Summary statistics for fit model</span></span>
<span id="cb50-145"><a href="#cb50-145"></a><span class="fu">summary</span>(linear_model)</span>
<span id="cb50-146"><a href="#cb50-146"></a></span>
<span id="cb50-147"><a href="#cb50-147"></a><span class="co"># Extract slope parameter</span></span>
<span id="cb50-148"><a href="#cb50-148"></a><span class="fu">coef</span>(linear_model)[<span class="dv">2</span>]</span>
<span id="cb50-149"><a href="#cb50-149"></a><span class="in">```</span></span>
<span id="cb50-150"><a href="#cb50-150"></a></span>
<span id="cb50-151"><a href="#cb50-151"></a>Rearranging the linear equation above and denoting the slope coefficient by $\hat \beta_1$ we have the estimator $\hat R_0 = \hat \beta_1 / \gamma + 1$ giving $\hat R_0 = 1.094913 / 0.4 + 1 \approx 3.7$.</span>
<span id="cb50-152"><a href="#cb50-152"></a></span>
<span id="cb50-153"><a href="#cb50-153"></a>::: exercise</span>
<span id="cb50-154"><a href="#cb50-154"></a><span class="fu">### Exercise 2</span></span>
<span id="cb50-155"><a href="#cb50-155"></a>:::</span>
<span id="cb50-156"><a href="#cb50-156"></a></span>
<span id="cb50-157"><a href="#cb50-157"></a>Our estimate assumes that boys remained infectious during the natural course of infection.</span>
<span id="cb50-158"><a href="#cb50-158"></a>The original report on this epidemic indicates that boys found to have symptoms were immediately confined to bed in the infirmary.</span>
<span id="cb50-159"><a href="#cb50-159"></a>The report also indicates that only 1 out of 130 adults at the school exhibited any symptoms.</span>
<span id="cb50-160"><a href="#cb50-160"></a>It is reasonable, then, to suppose that transmission in each case ceased once he had been admitted to the infirmary.</span>
<span id="cb50-161"><a href="#cb50-161"></a>Supposing admission happened within 24 hours of the onset of symptoms.</span>
<span id="cb50-162"><a href="#cb50-162"></a>How does this affect our estimate of $R_0$?</span>
<span id="cb50-163"><a href="#cb50-163"></a>Twelve hours?</span>
<span id="cb50-164"><a href="#cb50-164"></a></span>
<span id="cb50-165"><a href="#cb50-165"></a>::: exercise</span>
<span id="cb50-166"><a href="#cb50-166"></a><span class="fu">### Exercise 3</span></span>
<span id="cb50-167"><a href="#cb50-167"></a>:::</span>
<span id="cb50-168"><a href="#cb50-168"></a></span>
<span id="cb50-169"><a href="#cb50-169"></a>Biweekly data for outbreaks of measles in three communities in Niamey, Niger are provided in the dataframe <span class="in">`niamey`</span>.</span>
<span id="cb50-170"><a href="#cb50-170"></a>Use this method to obtain estimates of $R_0$ for measles from the first community assuming that the infectious period is approximately two weeks or $\frac{14}{365} \approx 0.0384$ years.</span>
<span id="cb50-171"><a href="#cb50-171"></a></span>
<span id="cb50-172"><a href="#cb50-172"></a>::: exercise</span>
<span id="cb50-173"><a href="#cb50-173"></a><span class="fu">### Exercise 4</span></span>
<span id="cb50-174"><a href="#cb50-174"></a>:::</span>
<span id="cb50-175"><a href="#cb50-175"></a></span>
<span id="cb50-176"><a href="#cb50-176"></a>A defect with this method is that it uses only a small fraction of the information that might be available, i.e., the first few data points.</span>
<span id="cb50-177"><a href="#cb50-177"></a>Indeed, there is nothing in the method that tells one how many data points to use--this is a matter of judgment.</span>
<span id="cb50-178"><a href="#cb50-178"></a>Further, there is a tradeoff in that as more and more data points are used the precision of the estimate increases, but this comes at a cost of additional bias.</span>
<span id="cb50-179"><a href="#cb50-179"></a>Plot the estimate of $R_0$ obtained from $n=3, 4, 5, ...$ data points against the standard error of the slope from the regression analysis to show this tradeoff.</span>
<span id="cb50-180"><a href="#cb50-180"></a></span>
<span id="cb50-181"><a href="#cb50-181"></a><span class="fu">## Estimating dynamical parameters with least squares</span></span>
<span id="cb50-182"><a href="#cb50-182"></a></span>
<span id="cb50-183"><a href="#cb50-183"></a>The objective of the previous exercise was to estimate $R_0$.</span>
<span id="cb50-184"><a href="#cb50-184"></a>Knowing $R_0$ is critical to understanding the dynamics of any epidemic system.</span>
<span id="cb50-185"><a href="#cb50-185"></a>It is, however, a composite quantity and is not sufficient to completely describe the epidemic trajectory.</span>
<span id="cb50-186"><a href="#cb50-186"></a>For this, we require estimates for all parameters of the model.</span>
<span id="cb50-187"><a href="#cb50-187"></a>In this exercise, we introduce a simple approach to model estimation called **least squares fitting**, sometimes called **trajectory matching**.</span>
<span id="cb50-188"><a href="#cb50-188"></a>The basic idea is that we find the values of the model parameters that minimize the squared differences between model predictions and the observed data.</span>
<span id="cb50-189"><a href="#cb50-189"></a>To demonstrate least squares fitting, we consider an outbreak of measles in Niamey, Niger, reported on by <span class="co">[</span><span class="ot">@graisEstimatingTransmissionIntensity2006</span><span class="co">]</span>.</span>
<span id="cb50-190"><a href="#cb50-190"></a></span>
<span id="cb50-193"><a href="#cb50-193"></a><span class="in">```{r}</span></span>
<span id="cb50-194"><a href="#cb50-194"></a><span class="co"># Replace an "NA"</span></span>
<span id="cb50-195"><a href="#cb50-195"></a>niamey[<span class="dv">5</span>, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb50-196"><a href="#cb50-196"></a></span>
<span id="cb50-197"><a href="#cb50-197"></a>niamey_df <span class="ot">&lt;-</span> niamey <span class="sc">%&gt;%</span></span>
<span id="cb50-198"><a href="#cb50-198"></a>  <span class="co"># Rename columns to remove automatic "V1" etc columns names</span></span>
<span id="cb50-199"><a href="#cb50-199"></a>  <span class="fu">rename_with</span>(., <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Site_"</span>, <span class="fu">str_remove</span>(.x, <span class="st">"V"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb50-200"><a href="#cb50-200"></a>  <span class="co"># Add a column for the biweekly time period</span></span>
<span id="cb50-201"><a href="#cb50-201"></a>  <span class="fu">mutate</span>(<span class="at">biweek =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-202"><a href="#cb50-202"></a>  <span class="co"># Convert to long format for plotting</span></span>
<span id="cb50-203"><a href="#cb50-203"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb50-204"><a href="#cb50-204"></a>    <span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"Site"</span>),</span>
<span id="cb50-205"><a href="#cb50-205"></a>    <span class="at">names_to =</span> <span class="st">"site"</span>,</span>
<span id="cb50-206"><a href="#cb50-206"></a>    <span class="at">values_to =</span> <span class="st">"cases"</span></span>
<span id="cb50-207"><a href="#cb50-207"></a>  )</span>
<span id="cb50-208"><a href="#cb50-208"></a><span class="in">```</span></span>
<span id="cb50-209"><a href="#cb50-209"></a></span>
<span id="cb50-212"><a href="#cb50-212"></a><span class="in">```{r}</span></span>
<span id="cb50-213"><a href="#cb50-213"></a><span class="co"># Create a vector of colors for each site in the Niamey dataset</span></span>
<span id="cb50-214"><a href="#cb50-214"></a>niamey_site_colors <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>, <span class="st">"Dark2"</span>)</span>
<span id="cb50-215"><a href="#cb50-215"></a><span class="co"># Assign names to the colors</span></span>
<span id="cb50-216"><a href="#cb50-216"></a><span class="fu">names</span>(niamey_site_colors) <span class="ot">&lt;-</span> <span class="fu">unique</span>(niamey_df<span class="sc">$</span>site)</span>
<span id="cb50-217"><a href="#cb50-217"></a></span>
<span id="cb50-218"><a href="#cb50-218"></a><span class="co"># Create a vector of labels for each site for nicer plotting legends</span></span>
<span id="cb50-219"><a href="#cb50-219"></a>niamey_site_labels <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">names</span>(niamey_site_colors), <span class="st">"_"</span>, <span class="st">" "</span>)</span>
<span id="cb50-220"><a href="#cb50-220"></a><span class="fu">names</span>(niamey_site_labels) <span class="ot">&lt;-</span> <span class="fu">names</span>(niamey_site_colors)</span>
<span id="cb50-221"><a href="#cb50-221"></a><span class="in">```</span></span>
<span id="cb50-222"><a href="#cb50-222"></a></span>
<span id="cb50-225"><a href="#cb50-225"></a><span class="in">```{r}</span></span>
<span id="cb50-226"><a href="#cb50-226"></a><span class="co">#| column: body</span></span>
<span id="cb50-227"><a href="#cb50-227"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb50-228"><a href="#cb50-228"></a><span class="fu">ggplot</span>(</span>
<span id="cb50-229"><a href="#cb50-229"></a>  niamey_df,</span>
<span id="cb50-230"><a href="#cb50-230"></a>  <span class="fu">aes</span>(<span class="at">x =</span> biweek, <span class="at">y =</span> cases, <span class="at">color =</span> site, <span class="at">fill =</span> site, <span class="at">group =</span> site)</span>
<span id="cb50-231"><a href="#cb50-231"></a>) <span class="sc">+</span></span>
<span id="cb50-232"><a href="#cb50-232"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb50-233"><a href="#cb50-233"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">21</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb50-234"><a href="#cb50-234"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb50-235"><a href="#cb50-235"></a>    <span class="at">values =</span> niamey_site_colors,</span>
<span id="cb50-236"><a href="#cb50-236"></a>    <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">"color"</span>, <span class="st">"fill"</span>),</span>
<span id="cb50-237"><a href="#cb50-237"></a>    <span class="at">labels =</span> niamey_site_labels</span>
<span id="cb50-238"><a href="#cb50-238"></a>  ) <span class="sc">+</span></span>
<span id="cb50-239"><a href="#cb50-239"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb50-240"><a href="#cb50-240"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Biweek"</span>, <span class="at">y =</span> <span class="st">"Number of Cases"</span>, <span class="at">fill =</span> <span class="st">"Site Number"</span>) <span class="sc">+</span></span>
<span id="cb50-241"><a href="#cb50-241"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb50-242"><a href="#cb50-242"></a><span class="in">```</span></span>
<span id="cb50-243"><a href="#cb50-243"></a></span>
<span id="cb50-244"><a href="#cb50-244"></a><span class="fu">## Dynamical Model</span></span>
<span id="cb50-245"><a href="#cb50-245"></a></span>
<span id="cb50-246"><a href="#cb50-246"></a>First, we write a specialized function for simulating the SIR model in a case where the removal rate is *"hard-wired"* and with no demography.</span>
<span id="cb50-247"><a href="#cb50-247"></a></span>
<span id="cb50-250"><a href="#cb50-250"></a><span class="in">```{r}</span></span>
<span id="cb50-251"><a href="#cb50-251"></a><span class="co">#' Basic SIR model</span></span>
<span id="cb50-252"><a href="#cb50-252"></a><span class="co">#'</span></span>
<span id="cb50-253"><a href="#cb50-253"></a><span class="co">#' A basic SIR model with no demographic structure to be used in deSolve</span></span>
<span id="cb50-254"><a href="#cb50-254"></a><span class="co">#'</span></span>
<span id="cb50-255"><a href="#cb50-255"></a><span class="co">#' @param time deSolve passes the time parameter to the function.</span></span>
<span id="cb50-256"><a href="#cb50-256"></a><span class="co">#' @param state A vector of states.</span></span>
<span id="cb50-257"><a href="#cb50-257"></a><span class="co">#' @param params The beta parameter</span></span>
<span id="cb50-258"><a href="#cb50-258"></a><span class="co">#' @param ... Other arguments passed by deSolve.</span></span>
<span id="cb50-259"><a href="#cb50-259"></a><span class="co">#'</span></span>
<span id="cb50-260"><a href="#cb50-260"></a><span class="co">#' @return A deSolve matrix of states at each time step.</span></span>
<span id="cb50-261"><a href="#cb50-261"></a><span class="co">#' @examples</span></span>
<span id="cb50-262"><a href="#cb50-262"></a><span class="co">#' sir_params &lt;- 0.0005</span></span>
<span id="cb50-263"><a href="#cb50-263"></a><span class="co">#' sir_init_states &lt;- c(S = 5000, I = 1, R = 0)</span></span>
<span id="cb50-264"><a href="#cb50-264"></a><span class="co">#' sim_times &lt;- seq(0, 16 / 365, by = 0.1 / 365)</span></span>
<span id="cb50-265"><a href="#cb50-265"></a><span class="co">#'</span></span>
<span id="cb50-266"><a href="#cb50-266"></a><span class="co">#' sir_sol &lt;- deSolve::ode(</span></span>
<span id="cb50-267"><a href="#cb50-267"></a><span class="co">#'    y = sir_init_states,</span></span>
<span id="cb50-268"><a href="#cb50-268"></a><span class="co">#'    times = sim_times,</span></span>
<span id="cb50-269"><a href="#cb50-269"></a><span class="co">#'    func = closed_sir_model,</span></span>
<span id="cb50-270"><a href="#cb50-270"></a><span class="co">#'    parms = sir_params</span></span>
<span id="cb50-271"><a href="#cb50-271"></a><span class="co">#' ))</span></span>
<span id="cb50-272"><a href="#cb50-272"></a>closed_sir_model <span class="ot">&lt;-</span> <span class="cf">function</span>(time, state, params, ...) {</span>
<span id="cb50-273"><a href="#cb50-273"></a>  <span class="co"># Unpack states</span></span>
<span id="cb50-274"><a href="#cb50-274"></a>  S <span class="ot">&lt;-</span> state[<span class="st">"S"</span>]</span>
<span id="cb50-275"><a href="#cb50-275"></a>  I <span class="ot">&lt;-</span> state[<span class="st">"I"</span>]</span>
<span id="cb50-276"><a href="#cb50-276"></a></span>
<span id="cb50-277"><a href="#cb50-277"></a>  <span class="co"># Unpack parameters</span></span>
<span id="cb50-278"><a href="#cb50-278"></a>  beta <span class="ot">&lt;-</span> params</span>
<span id="cb50-279"><a href="#cb50-279"></a>  dur_inf <span class="ot">&lt;-</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-280"><a href="#cb50-280"></a>  gamma <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> dur_inf</span>
<span id="cb50-281"><a href="#cb50-281"></a></span>
<span id="cb50-282"><a href="#cb50-282"></a>  new_inf <span class="ot">&lt;-</span> beta <span class="sc">*</span> S <span class="sc">*</span> I</span>
<span id="cb50-283"><a href="#cb50-283"></a></span>
<span id="cb50-284"><a href="#cb50-284"></a>  <span class="co"># Calculate the ODEs</span></span>
<span id="cb50-285"><a href="#cb50-285"></a>  dSdt <span class="ot">&lt;-</span> <span class="sc">-</span>new_inf</span>
<span id="cb50-286"><a href="#cb50-286"></a>  dIdt <span class="ot">&lt;-</span> new_inf <span class="sc">-</span> (gamma <span class="sc">*</span> I)</span>
<span id="cb50-287"><a href="#cb50-287"></a></span>
<span id="cb50-288"><a href="#cb50-288"></a>  <span class="co"># Return the ODEs</span></span>
<span id="cb50-289"><a href="#cb50-289"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="fu">c</span>(dSdt, dIdt, new_inf)))</span>
<span id="cb50-290"><a href="#cb50-290"></a>}</span>
<span id="cb50-291"><a href="#cb50-291"></a><span class="in">```</span></span>
<span id="cb50-292"><a href="#cb50-292"></a></span>
<span id="cb50-293"><a href="#cb50-293"></a><span class="fu">## Interactive Optimization</span></span>
<span id="cb50-294"><a href="#cb50-294"></a></span>
<span id="cb50-297"><a href="#cb50-297"></a><span class="in">```{r}</span></span>
<span id="cb50-298"><a href="#cb50-298"></a><span class="co">#| echo: false</span></span>
<span id="cb50-299"><a href="#cb50-299"></a>ojs_niamey <span class="ot">&lt;-</span> niamey_df <span class="sc">%&gt;%</span></span>
<span id="cb50-300"><a href="#cb50-300"></a>  <span class="fu">rename</span>(<span class="st">"Biweek"</span> <span class="ot">=</span> biweek, <span class="st">"Number of Individuals"</span> <span class="ot">=</span> cases) <span class="sc">%&gt;%</span></span>
<span id="cb50-301"><a href="#cb50-301"></a>  <span class="fu">mutate</span>(<span class="at">site =</span> <span class="fu">str_replace_all</span>(site, <span class="st">"_"</span>, <span class="st">" "</span>))</span>
<span id="cb50-302"><a href="#cb50-302"></a><span class="in">```</span></span>
<span id="cb50-303"><a href="#cb50-303"></a></span>
<span id="cb50-306"><a href="#cb50-306"></a><span class="in">```{r}</span></span>
<span id="cb50-307"><a href="#cb50-307"></a><span class="co">#| echo: false</span></span>
<span id="cb50-308"><a href="#cb50-308"></a><span class="co">#| cache: false</span></span>
<span id="cb50-309"><a href="#cb50-309"></a><span class="fu">ojs_define</span>(<span class="at">niamey_data =</span> ojs_niamey)</span>
<span id="cb50-310"><a href="#cb50-310"></a><span class="in">```</span></span>
<span id="cb50-311"><a href="#cb50-311"></a></span>
<span id="cb50-314"><a href="#cb50-314"></a><span class="in">```{ojs}</span></span>
<span id="cb50-315"><a href="#cb50-315"></a><span class="co">//| echo: false</span></span>
<span id="cb50-316"><a href="#cb50-316"></a>filtered_niamey_data <span class="op">=</span> aq<span class="op">.</span><span class="fu">table</span>(niamey_data)</span>
<span id="cb50-317"><a href="#cb50-317"></a>    <span class="op">.</span><span class="fu">filter</span>(aq<span class="op">.</span><span class="fu">escape</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">site</span> <span class="op">==</span> site_select))</span>
<span id="cb50-318"><a href="#cb50-318"></a><span class="in">```</span></span>
<span id="cb50-319"><a href="#cb50-319"></a></span>
<span id="cb50-322"><a href="#cb50-322"></a><span class="in">```{ojs}</span></span>
<span id="cb50-323"><a href="#cb50-323"></a><span class="co">//| echo: false</span></span>
<span id="cb50-324"><a href="#cb50-324"></a>reset_S <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb50-325"><a href="#cb50-325"></a>reset_I <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb50-326"><a href="#cb50-326"></a>reset_beta <span class="op">=</span> <span class="fl">5.00</span></span>
<span id="cb50-327"><a href="#cb50-327"></a><span class="in">```</span></span>
<span id="cb50-328"><a href="#cb50-328"></a></span>
<span id="cb50-331"><a href="#cb50-331"></a><span class="in">```{ojs}</span></span>
<span id="cb50-332"><a href="#cb50-332"></a><span class="co">//| echo: false</span></span>
<span id="cb50-333"><a href="#cb50-333"></a><span class="kw">function</span> <span class="fu">set</span>(input<span class="op">,</span> value) {</span>
<span id="cb50-334"><a href="#cb50-334"></a>  input<span class="op">.</span><span class="at">value</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb50-335"><a href="#cb50-335"></a>  input<span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">Event</span>(<span class="st">"input"</span><span class="op">,</span> {<span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span>}))<span class="op">;</span></span>
<span id="cb50-336"><a href="#cb50-336"></a>}</span>
<span id="cb50-337"><a href="#cb50-337"></a><span class="in">```</span></span>
<span id="cb50-338"><a href="#cb50-338"></a></span>
<span id="cb50-341"><a href="#cb50-341"></a><span class="in">```{ojs}</span></span>
<span id="cb50-342"><a href="#cb50-342"></a><span class="co">//| echo: false</span></span>
<span id="cb50-343"><a href="#cb50-343"></a><span class="kw">function</span> <span class="fu">sse</span>(obs<span class="op">,</span> preds) {</span>
<span id="cb50-344"><a href="#cb50-344"></a></span>
<span id="cb50-345"><a href="#cb50-345"></a>    <span class="cf">if</span>(obs<span class="op">.</span><span class="at">length</span> <span class="op">==</span> preds<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb50-346"><a href="#cb50-346"></a>        <span class="kw">var</span> squared_errs <span class="op">=</span> obs<span class="op">.</span><span class="fu">map</span>((e<span class="op">,</span> i) <span class="kw">=&gt;</span> (e <span class="op">-</span> preds[i])<span class="op">**</span><span class="dv">2</span> )</span>
<span id="cb50-347"><a href="#cb50-347"></a>        <span class="cf">return</span> squared_errs<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb50-348"><a href="#cb50-348"></a>    } <span class="cf">else</span> {</span>
<span id="cb50-349"><a href="#cb50-349"></a>        <span class="cf">return</span>(<span class="st">"lengths are not the same"</span>)</span>
<span id="cb50-350"><a href="#cb50-350"></a>    }</span>
<span id="cb50-351"><a href="#cb50-351"></a>}</span>
<span id="cb50-352"><a href="#cb50-352"></a><span class="in">```</span></span>
<span id="cb50-353"><a href="#cb50-353"></a></span>
<span id="cb50-356"><a href="#cb50-356"></a><span class="in">```{ojs}</span></span>
<span id="cb50-357"><a href="#cb50-357"></a><span class="co">//| panel: sidebar</span></span>
<span id="cb50-358"><a href="#cb50-358"></a><span class="co">//| echo: false</span></span>
<span id="cb50-359"><a href="#cb50-359"></a>viewof reset <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">button</span>([</span>
<span id="cb50-360"><a href="#cb50-360"></a>  [<span class="st">"Reset all sliders"</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb50-361"><a href="#cb50-361"></a>    <span class="kw">set</span>(viewof S0<span class="op">,</span> reset_S)</span>
<span id="cb50-362"><a href="#cb50-362"></a>    <span class="kw">set</span>(viewof I0<span class="op">,</span> reset_I)</span>
<span id="cb50-363"><a href="#cb50-363"></a>    <span class="kw">set</span>(viewof beta_input<span class="op">,</span> reset_beta)</span>
<span id="cb50-364"><a href="#cb50-364"></a>  }]</span>
<span id="cb50-365"><a href="#cb50-365"></a>])</span>
<span id="cb50-366"><a href="#cb50-366"></a>viewof S0 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb50-367"><a href="#cb50-367"></a>    [<span class="dv">500</span><span class="op">,</span> <span class="dv">15000</span>]<span class="op">,</span></span>
<span id="cb50-368"><a href="#cb50-368"></a>    {<span class="dt">value</span><span class="op">:</span> reset_S<span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">md</span><span class="vs">`</span><span class="sc">${</span><span class="fu">tex</span><span class="vs">`S(0)`</span><span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb50-369"><a href="#cb50-369"></a>)</span>
<span id="cb50-370"><a href="#cb50-370"></a></span>
<span id="cb50-371"><a href="#cb50-371"></a>viewof I0 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb50-372"><a href="#cb50-372"></a>    [<span class="fl">0.001</span><span class="op">,</span> <span class="dv">50</span>]<span class="op">,</span></span>
<span id="cb50-373"><a href="#cb50-373"></a>    {<span class="dt">value</span><span class="op">:</span> reset_I<span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.001</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">md</span><span class="vs">`</span><span class="sc">${</span><span class="fu">tex</span><span class="vs">`I(0)`</span><span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb50-374"><a href="#cb50-374"></a>)</span>
<span id="cb50-375"><a href="#cb50-375"></a></span>
<span id="cb50-376"><a href="#cb50-376"></a>viewof beta_input <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb50-377"><a href="#cb50-377"></a>    [<span class="dv">1</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span></span>
<span id="cb50-378"><a href="#cb50-378"></a>    {<span class="dt">value</span><span class="op">:</span> reset_beta<span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.001</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">md</span><span class="vs">`</span><span class="sc">${</span><span class="fu">tex</span><span class="vs">`</span><span class="sc">\b</span><span class="vs">eta (</span><span class="sc">\t</span><span class="vs">imes 10^{-3})`</span><span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb50-379"><a href="#cb50-379"></a>)</span>
<span id="cb50-380"><a href="#cb50-380"></a></span>
<span id="cb50-381"><a href="#cb50-381"></a>viewof site_select <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(</span>
<span id="cb50-382"><a href="#cb50-382"></a>    [<span class="st">"Site 1"</span><span class="op">,</span> <span class="st">"Site 2"</span><span class="op">,</span> <span class="st">"Site 3"</span>]<span class="op">,</span></span>
<span id="cb50-383"><a href="#cb50-383"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">"Select a site:"</span>}</span>
<span id="cb50-384"><a href="#cb50-384"></a>)</span>
<span id="cb50-385"><a href="#cb50-385"></a></span>
<span id="cb50-386"><a href="#cb50-386"></a><span class="co">// convert to daily time scale as easier to manipulate</span></span>
<span id="cb50-387"><a href="#cb50-387"></a>beta <span class="op">=</span> (beta_input <span class="op">/</span> <span class="dv">365</span>) <span class="op">*</span> (<span class="dv">10</span> <span class="op">**</span> (<span class="op">-</span><span class="dv">3</span>))</span>
<span id="cb50-388"><a href="#cb50-388"></a></span>
<span id="cb50-389"><a href="#cb50-389"></a><span class="fu">md</span><span class="vs">`</span><span class="sc">${</span><span class="fu">tex</span><span class="vs">`R_0 = </span><span class="sc">${</span>R0_str<span class="sc">}</span><span class="vs">`</span><span class="sc">}</span><span class="vs">`</span></span>
<span id="cb50-390"><a href="#cb50-390"></a><span class="in">```</span></span>
<span id="cb50-391"><a href="#cb50-391"></a></span>
<span id="cb50-394"><a href="#cb50-394"></a><span class="in">```{ojs}</span></span>
<span id="cb50-395"><a href="#cb50-395"></a><span class="co">//| echo: false</span></span>
<span id="cb50-396"><a href="#cb50-396"></a>dur_inf <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb50-397"><a href="#cb50-397"></a>gamma <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> dur_inf</span>
<span id="cb50-398"><a href="#cb50-398"></a>R0 <span class="op">=</span> beta <span class="op">*</span> (S0 <span class="op">+</span> I0)<span class="op">/</span> gamma</span>
<span id="cb50-399"><a href="#cb50-399"></a></span>
<span id="cb50-400"><a href="#cb50-400"></a>R0_str <span class="op">=</span> R0<span class="op">.</span><span class="fu">toPrecision</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">toLocaleString</span>()</span>
<span id="cb50-401"><a href="#cb50-401"></a><span class="in">```</span></span>
<span id="cb50-402"><a href="#cb50-402"></a></span>
<span id="cb50-405"><a href="#cb50-405"></a><span class="in">```{ojs}</span></span>
<span id="cb50-406"><a href="#cb50-406"></a><span class="co">//| echo: false</span></span>
<span id="cb50-407"><a href="#cb50-407"></a>dt <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb50-408"><a href="#cb50-408"></a>tmax <span class="op">=</span> <span class="dv">16</span> <span class="op">*</span> <span class="dv">14</span></span>
<span id="cb50-409"><a href="#cb50-409"></a><span class="in">```</span></span>
<span id="cb50-410"><a href="#cb50-410"></a></span>
<span id="cb50-413"><a href="#cb50-413"></a><span class="in">```{ojs}</span></span>
<span id="cb50-414"><a href="#cb50-414"></a><span class="co">//| echo: false</span></span>
<span id="cb50-415"><a href="#cb50-415"></a><span class="im">import</span> {odeRK4} <span class="im">from</span> <span class="st">'@rreusser/integration@3064'</span></span>
<span id="cb50-416"><a href="#cb50-416"></a><span class="im">import</span> { aq<span class="op">,</span> op } <span class="im">from</span> <span class="st">'@uwdata/arquero'</span></span>
<span id="cb50-417"><a href="#cb50-417"></a><span class="in">```</span></span>
<span id="cb50-418"><a href="#cb50-418"></a></span>
<span id="cb50-421"><a href="#cb50-421"></a><span class="in">```{ojs}</span></span>
<span id="cb50-422"><a href="#cb50-422"></a><span class="co">//| echo: false</span></span>
<span id="cb50-423"><a href="#cb50-423"></a><span class="kw">function</span> <span class="fu">sir</span>(dydt<span class="op">,</span> y<span class="op">,</span> t) {</span>
<span id="cb50-424"><a href="#cb50-424"></a>    dydt[<span class="dv">3</span>] <span class="op">=</span> beta <span class="op">*</span> y[<span class="dv">0</span>] <span class="op">*</span> y[<span class="dv">1</span>]</span>
<span id="cb50-425"><a href="#cb50-425"></a></span>
<span id="cb50-426"><a href="#cb50-426"></a>    dydt[<span class="dv">0</span>] <span class="op">=</span> <span class="op">-</span> dydt[<span class="dv">3</span>]</span>
<span id="cb50-427"><a href="#cb50-427"></a>    dydt[<span class="dv">1</span>] <span class="op">=</span> dydt[<span class="dv">3</span>] <span class="op">-</span> gamma <span class="op">*</span> y[<span class="dv">1</span>]</span>
<span id="cb50-428"><a href="#cb50-428"></a>    dydt[<span class="dv">2</span>] <span class="op">=</span> gamma <span class="op">*</span> y[<span class="dv">1</span>]</span>
<span id="cb50-429"><a href="#cb50-429"></a>}</span>
<span id="cb50-430"><a href="#cb50-430"></a><span class="in">```</span></span>
<span id="cb50-431"><a href="#cb50-431"></a></span>
<span id="cb50-434"><a href="#cb50-434"></a><span class="in">```{ojs}</span></span>
<span id="cb50-435"><a href="#cb50-435"></a><span class="co">//| echo: false</span></span>
<span id="cb50-436"><a href="#cb50-436"></a><span class="kw">function</span> <span class="fu">simulate</span>(f<span class="op">,</span> t0<span class="op">,</span> y0<span class="op">,</span> dt<span class="op">,</span> tmax) {</span>
<span id="cb50-437"><a href="#cb50-437"></a>    <span class="kw">var</span> t <span class="op">=</span> t0</span>
<span id="cb50-438"><a href="#cb50-438"></a>    <span class="kw">var</span> y <span class="op">=</span> y0</span>
<span id="cb50-439"><a href="#cb50-439"></a>    <span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb50-440"><a href="#cb50-440"></a></span>
<span id="cb50-441"><a href="#cb50-441"></a>    <span class="kw">var</span> ysim <span class="op">=</span> [y0]</span>
<span id="cb50-442"><a href="#cb50-442"></a></span>
<span id="cb50-443"><a href="#cb50-443"></a>    <span class="cf">for</span> (t <span class="op">=</span> t0 <span class="op">+</span> dt<span class="op">;</span> t <span class="op">&lt;=</span> tmax<span class="op">;</span> t <span class="op">+=</span> dt) {</span>
<span id="cb50-444"><a href="#cb50-444"></a>        ysim<span class="op">.</span><span class="fu">push</span>(<span class="fu">odeRK4</span>([]<span class="op">,</span> ysim[i]<span class="op">,</span> f<span class="op">,</span> dt))</span>
<span id="cb50-445"><a href="#cb50-445"></a>        i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb50-446"><a href="#cb50-446"></a>    }</span>
<span id="cb50-447"><a href="#cb50-447"></a></span>
<span id="cb50-448"><a href="#cb50-448"></a>    <span class="co">// return cumulative infections</span></span>
<span id="cb50-449"><a href="#cb50-449"></a>    <span class="cf">return</span> ysim<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d[<span class="dv">3</span>])</span>
<span id="cb50-450"><a href="#cb50-450"></a>}</span>
<span id="cb50-451"><a href="#cb50-451"></a><span class="in">```</span></span>
<span id="cb50-452"><a href="#cb50-452"></a></span>
<span id="cb50-455"><a href="#cb50-455"></a><span class="in">```{ojs}</span></span>
<span id="cb50-456"><a href="#cb50-456"></a><span class="co">//| echo: false</span></span>
<span id="cb50-457"><a href="#cb50-457"></a>sir_sol <span class="op">=</span> <span class="fu">simulate</span>(sir<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> [S0<span class="op">,</span> I0<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span>]<span class="op">,</span> dt<span class="op">,</span> tmax)</span>
<span id="cb50-458"><a href="#cb50-458"></a><span class="in">```</span></span>
<span id="cb50-459"><a href="#cb50-459"></a></span>
<span id="cb50-462"><a href="#cb50-462"></a><span class="in">```{ojs}</span></span>
<span id="cb50-463"><a href="#cb50-463"></a><span class="co">//| echo: false</span></span>
<span id="cb50-464"><a href="#cb50-464"></a>siteColors <span class="op">=</span> [<span class="st">"#1b9e77"</span><span class="op">,</span> <span class="st">"#d95f02"</span><span class="op">,</span> <span class="st">"#7570b3"</span>]</span>
<span id="cb50-465"><a href="#cb50-465"></a><span class="in">```</span></span>
<span id="cb50-466"><a href="#cb50-466"></a></span>
<span id="cb50-469"><a href="#cb50-469"></a><span class="in">```{ojs}</span></span>
<span id="cb50-470"><a href="#cb50-470"></a><span class="co">//| echo: false</span></span>
<span id="cb50-471"><a href="#cb50-471"></a><span class="co">// Create an array of time indices, dropping first as from returns index 0, which</span></span>
<span id="cb50-472"><a href="#cb50-472"></a><span class="co">// doesn't exist in the real data</span></span>
<span id="cb50-473"><a href="#cb50-473"></a>times <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>({<span class="dt">length</span><span class="op">:</span> <span class="dv">17</span>}<span class="op">,</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> i <span class="op">*</span> <span class="dv">14</span>)<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb50-474"><a href="#cb50-474"></a>tindex <span class="op">=</span> times<span class="op">.</span><span class="fu">map</span>((e<span class="op">,</span> i) <span class="kw">=&gt;</span> e <span class="op">*</span> (<span class="dv">1</span> <span class="op">/</span> dt))</span>
<span id="cb50-475"><a href="#cb50-475"></a></span>
<span id="cb50-476"><a href="#cb50-476"></a>cum_inc <span class="op">=</span> tindex<span class="op">.</span><span class="fu">map</span>((i) <span class="kw">=&gt;</span> sir_sol[i])</span>
<span id="cb50-477"><a href="#cb50-477"></a></span>
<span id="cb50-478"><a href="#cb50-478"></a>preds <span class="op">=</span> [cum_inc[<span class="dv">0</span>] <span class="op">+</span> I0<span class="op">,</span> <span class="op">...</span>cum_inc<span class="op">.</span><span class="fu">map</span>((e<span class="op">,</span> i) <span class="kw">=&gt;</span> cum_inc[i] <span class="op">-</span> cum_inc[i<span class="op">-</span><span class="dv">1</span>])<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)]</span>
<span id="cb50-479"><a href="#cb50-479"></a></span>
<span id="cb50-480"><a href="#cb50-480"></a>sir_tbl <span class="op">=</span> aq<span class="op">.</span><span class="fu">table</span>({</span>
<span id="cb50-481"><a href="#cb50-481"></a>    <span class="dt">Biweek</span><span class="op">:</span> times<span class="op">.</span><span class="fu">map</span>(t <span class="kw">=&gt;</span> t <span class="op">/</span> <span class="dv">14</span>)<span class="op">,</span></span>
<span id="cb50-482"><a href="#cb50-482"></a>    <span class="st">"Cumulative Incidence"</span><span class="op">:</span> cum_inc<span class="op">,</span></span>
<span id="cb50-483"><a href="#cb50-483"></a>    <span class="st">"Number of Individuals"</span><span class="op">:</span> preds</span>
<span id="cb50-484"><a href="#cb50-484"></a>})</span>
<span id="cb50-485"><a href="#cb50-485"></a></span>
<span id="cb50-486"><a href="#cb50-486"></a>sim_sse <span class="op">=</span> [({</span>
<span id="cb50-487"><a href="#cb50-487"></a>    <span class="dt">sse</span><span class="op">:</span> <span class="fu">sse</span>(</span>
<span id="cb50-488"><a href="#cb50-488"></a>            filtered_niamey_data<span class="op">.</span><span class="fu">array</span>(<span class="st">"Number of Individuals"</span>)<span class="op">,</span></span>
<span id="cb50-489"><a href="#cb50-489"></a>            preds</span>
<span id="cb50-490"><a href="#cb50-490"></a>        )<span class="op">.</span><span class="fu">toPrecision</span>(<span class="dv">4</span>)<span class="op">,</span></span>
<span id="cb50-491"><a href="#cb50-491"></a>    <span class="dt">Biweek</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb50-492"><a href="#cb50-492"></a>    <span class="st">"Number of Individuals"</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(</span>
<span id="cb50-493"><a href="#cb50-493"></a>        <span class="op">...</span>sir_tbl<span class="op">.</span><span class="fu">array</span>(<span class="st">"Number of Individuals"</span>)<span class="op">,</span></span>
<span id="cb50-494"><a href="#cb50-494"></a>        <span class="op">...</span>filtered_niamey_data<span class="op">.</span><span class="fu">array</span>(<span class="st">"Number of Individuals"</span>)</span>
<span id="cb50-495"><a href="#cb50-495"></a>    ) <span class="op">*</span> <span class="fl">0.9</span></span>
<span id="cb50-496"><a href="#cb50-496"></a>})]</span>
<span id="cb50-497"><a href="#cb50-497"></a><span class="in">```</span></span>
<span id="cb50-498"><a href="#cb50-498"></a></span>
<span id="cb50-501"><a href="#cb50-501"></a><span class="in">```{ojs}</span></span>
<span id="cb50-502"><a href="#cb50-502"></a><span class="co">//| echo: false</span></span>
<span id="cb50-503"><a href="#cb50-503"></a><span class="co">//| panel: fill</span></span>
<span id="cb50-504"><a href="#cb50-504"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb50-505"><a href="#cb50-505"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb50-506"><a href="#cb50-506"></a>        <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb50-507"><a href="#cb50-507"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Site 1"</span><span class="op">,</span> <span class="st">"Site 2"</span><span class="op">,</span> <span class="st">"Site 3"</span>]<span class="op">,</span></span>
<span id="cb50-508"><a href="#cb50-508"></a>        <span class="dt">range</span><span class="op">:</span> siteColors<span class="op">,</span></span>
<span id="cb50-509"><a href="#cb50-509"></a>    }<span class="op">,</span></span>
<span id="cb50-510"><a href="#cb50-510"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontSize</span><span class="op">:</span> <span class="st">"20px"</span>}<span class="op">,</span></span>
<span id="cb50-511"><a href="#cb50-511"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">75</span><span class="op">,</span></span>
<span id="cb50-512"><a href="#cb50-512"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb50-513"><a href="#cb50-513"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">55</span><span class="op">,</span></span>
<span id="cb50-514"><a href="#cb50-514"></a>    <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb50-515"><a href="#cb50-515"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb50-516"><a href="#cb50-516"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">670</span><span class="op">,</span></span>
<span id="cb50-517"><a href="#cb50-517"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb50-518"><a href="#cb50-518"></a>        Plot<span class="op">.</span><span class="fu">lineY</span>(</span>
<span id="cb50-519"><a href="#cb50-519"></a>            sir_tbl<span class="op">,</span></span>
<span id="cb50-520"><a href="#cb50-520"></a>            {<span class="dt">x</span><span class="op">:</span> <span class="st">"Biweek"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"Number of Individuals"</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"#4d4d4dff"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">strokeOpacity</span><span class="op">:</span> <span class="fl">0.8</span>}</span>
<span id="cb50-521"><a href="#cb50-521"></a>        )<span class="op">,</span></span>
<span id="cb50-522"><a href="#cb50-522"></a>        Plot<span class="op">.</span><span class="fu">dot</span>(</span>
<span id="cb50-523"><a href="#cb50-523"></a>            filtered_niamey_data<span class="op">,</span></span>
<span id="cb50-524"><a href="#cb50-524"></a>            {<span class="dt">x</span><span class="op">:</span> <span class="st">"Biweek"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"Number of Individuals"</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"site"</span><span class="op">,</span> <span class="dt">fill</span><span class="op">:</span> <span class="st">"site"</span><span class="op">,</span> <span class="dt">fillOpacity</span><span class="op">:</span> <span class="fl">0.6</span><span class="op">,</span> <span class="dt">r</span><span class="op">:</span> <span class="dv">12</span>}</span>
<span id="cb50-525"><a href="#cb50-525"></a>        )<span class="op">,</span></span>
<span id="cb50-526"><a href="#cb50-526"></a>        Plot<span class="op">.</span><span class="fu">lineY</span>(</span>
<span id="cb50-527"><a href="#cb50-527"></a>            filtered_niamey_data<span class="op">,</span></span>
<span id="cb50-528"><a href="#cb50-528"></a>            {<span class="dt">x</span><span class="op">:</span> <span class="st">"Biweek"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"Number of Individuals"</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"site"</span>}</span>
<span id="cb50-529"><a href="#cb50-529"></a>        )<span class="op">,</span></span>
<span id="cb50-530"><a href="#cb50-530"></a>        Plot<span class="op">.</span><span class="fu">text</span>(</span>
<span id="cb50-531"><a href="#cb50-531"></a>            sim_sse<span class="op">,</span></span>
<span id="cb50-532"><a href="#cb50-532"></a>            {<span class="dt">x</span><span class="op">:</span> <span class="st">"Biweek"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"Number of Individuals"</span><span class="op">,</span> <span class="dt">text</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> <span class="vs">`SSE = </span><span class="sc">${</span>d<span class="op">.</span><span class="at">sse</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="dt">dx</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">dy</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span>}</span>
<span id="cb50-533"><a href="#cb50-533"></a>        )</span>
<span id="cb50-534"><a href="#cb50-534"></a>    ]</span>
<span id="cb50-535"><a href="#cb50-535"></a>})</span>
<span id="cb50-536"><a href="#cb50-536"></a><span class="in">```</span></span>
<span id="cb50-537"><a href="#cb50-537"></a></span>
<span id="cb50-538"><a href="#cb50-538"></a><span class="fu">## Objective Function</span></span>
<span id="cb50-539"><a href="#cb50-539"></a></span>
<span id="cb50-540"><a href="#cb50-540"></a>Now we set up a function that will calculate the sum of the squared differences between the observations and the model at any parameterization (more commonly known as *"sum of squared errors"*).</span>
<span id="cb50-541"><a href="#cb50-541"></a>In general, this is called the **objective function** because it is the quantity that optimization seeks to minimize.</span>
<span id="cb50-542"><a href="#cb50-542"></a></span>
<span id="cb50-545"><a href="#cb50-545"></a><span class="in">```{r}</span></span>
<span id="cb50-546"><a href="#cb50-546"></a><span class="co">#' Calculate the Sum of Squared Errors</span></span>
<span id="cb50-547"><a href="#cb50-547"></a><span class="co">#'</span></span>
<span id="cb50-548"><a href="#cb50-548"></a><span class="co">#' A function to take in biweekly incidence data, and SIR parameters, and</span></span>
<span id="cb50-549"><a href="#cb50-549"></a><span class="co">#' calculate the SSE</span></span>
<span id="cb50-550"><a href="#cb50-550"></a><span class="co">#'</span></span>
<span id="cb50-551"><a href="#cb50-551"></a><span class="co">#' @param params A vector of parameter values</span></span>
<span id="cb50-552"><a href="#cb50-552"></a><span class="co">#' @param data A dataframe containing biweekly incidence data in the case column</span></span>
<span id="cb50-553"><a href="#cb50-553"></a><span class="co">#'</span></span>
<span id="cb50-554"><a href="#cb50-554"></a><span class="co">#' @return The SSE of type double</span></span>
<span id="cb50-555"><a href="#cb50-555"></a><span class="co">#' @examples</span></span>
<span id="cb50-556"><a href="#cb50-556"></a>sse_sir <span class="ot">&lt;-</span> <span class="cf">function</span>(params, data) {</span>
<span id="cb50-557"><a href="#cb50-557"></a>  <span class="co"># Convert biweekly time series into annual time scale</span></span>
<span id="cb50-558"><a href="#cb50-558"></a>  <span class="co"># Daily time scale has requires beta values to be too small - doesn't</span></span>
<span id="cb50-559"><a href="#cb50-559"></a>  <span class="co"># optimize well</span></span>
<span id="cb50-560"><a href="#cb50-560"></a>  dt <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb50-561"><a href="#cb50-561"></a>  max_biweek <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>biweek)</span>
<span id="cb50-562"><a href="#cb50-562"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_biweek <span class="sc">*</span> <span class="dv">14</span>, dt) <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-563"><a href="#cb50-563"></a></span>
<span id="cb50-564"><a href="#cb50-564"></a>  <span class="co"># Extract the number of observed incidence</span></span>
<span id="cb50-565"><a href="#cb50-565"></a>  obs_inc <span class="ot">&lt;-</span> data<span class="sc">$</span>cases</span>
<span id="cb50-566"><a href="#cb50-566"></a></span>
<span id="cb50-567"><a href="#cb50-567"></a>  <span class="co"># Note the parameters are updated throughout the optimization process by</span></span>
<span id="cb50-568"><a href="#cb50-568"></a>  <span class="co"># the optim() function</span></span>
<span id="cb50-569"><a href="#cb50-569"></a>  <span class="co"># Unpack the transmission parameter and exponentiate to fit on ln scale</span></span>
<span id="cb50-570"><a href="#cb50-570"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"beta"</span>]])</span>
<span id="cb50-571"><a href="#cb50-571"></a></span>
<span id="cb50-572"><a href="#cb50-572"></a>  <span class="co"># Unpack the initial states and exponentiate to fit on normal scale</span></span>
<span id="cb50-573"><a href="#cb50-573"></a>  S_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"S_init"</span>]])</span>
<span id="cb50-574"><a href="#cb50-574"></a>  I_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"I_init"</span>]])</span>
<span id="cb50-575"><a href="#cb50-575"></a></span>
<span id="cb50-576"><a href="#cb50-576"></a>  <span class="co"># Fit SIR model to the parameters</span></span>
<span id="cb50-577"><a href="#cb50-577"></a>  sol <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb50-578"><a href="#cb50-578"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> S_init, <span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb50-579"><a href="#cb50-579"></a>    <span class="at">times =</span> t,</span>
<span id="cb50-580"><a href="#cb50-580"></a>    <span class="at">func =</span> closed_sir_model,</span>
<span id="cb50-581"><a href="#cb50-581"></a>    <span class="at">parms =</span> beta,</span>
<span id="cb50-582"><a href="#cb50-582"></a>    <span class="co"># Use rk4 as fixed time steps, which is important for indexing</span></span>
<span id="cb50-583"><a href="#cb50-583"></a>    <span class="at">method =</span> <span class="st">"rk4"</span></span>
<span id="cb50-584"><a href="#cb50-584"></a>  )</span>
<span id="cb50-585"><a href="#cb50-585"></a></span>
<span id="cb50-586"><a href="#cb50-586"></a>  <span class="co"># Extract the cumulative incidence</span></span>
<span id="cb50-587"><a href="#cb50-587"></a>  cum_inc <span class="ot">&lt;-</span> sol[, <span class="st">"new_inf"</span>]</span>
<span id="cb50-588"><a href="#cb50-588"></a></span>
<span id="cb50-589"><a href="#cb50-589"></a>  <span class="co"># Find the indices of the cumulative incidence to extract</span></span>
<span id="cb50-590"><a href="#cb50-590"></a>  biweek_index <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, max_biweek) <span class="sc">*</span> (<span class="dv">14</span> <span class="sc">/</span> dt) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb50-591"><a href="#cb50-591"></a></span>
<span id="cb50-592"><a href="#cb50-592"></a>  <span class="co"># Index cumulative incidence to get the values at the end of the biweeks</span></span>
<span id="cb50-593"><a href="#cb50-593"></a>  biweek_cum_inc <span class="ot">&lt;-</span> cum_inc[biweek_index]</span>
<span id="cb50-594"><a href="#cb50-594"></a></span>
<span id="cb50-595"><a href="#cb50-595"></a>  <span class="co"># Calculate the biweekly incidence by using the difference between</span></span>
<span id="cb50-596"><a href="#cb50-596"></a>  <span class="co"># consecutive biweeks. Need to manually prepend first week's incidence</span></span>
<span id="cb50-597"><a href="#cb50-597"></a>  <span class="co"># and add in the initial number of infectious individuals, as ODE model</span></span>
<span id="cb50-598"><a href="#cb50-598"></a>  <span class="co"># only returns the cumulative differences, which is 0 at the start.</span></span>
<span id="cb50-599"><a href="#cb50-599"></a>  biweek_inc <span class="ot">&lt;-</span> <span class="fu">c</span>(biweek_cum_inc[<span class="dv">1</span>] <span class="sc">+</span> I_init, <span class="fu">diff</span>(biweek_cum_inc, <span class="at">lag =</span> <span class="dv">1</span>))</span>
<span id="cb50-600"><a href="#cb50-600"></a></span>
<span id="cb50-601"><a href="#cb50-601"></a>  <span class="co"># return SSE of predicted vs observed incidence</span></span>
<span id="cb50-602"><a href="#cb50-602"></a>  <span class="fu">return</span>(<span class="fu">sum</span>((biweek_inc <span class="sc">-</span> obs_inc)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb50-603"><a href="#cb50-603"></a>}</span>
<span id="cb50-604"><a href="#cb50-604"></a><span class="in">```</span></span>
<span id="cb50-605"><a href="#cb50-605"></a></span>
<span id="cb50-606"><a href="#cb50-606"></a>Notice that the code for <span class="in">`sse_sir()`</span> makes use of the following modeling trick.</span>
<span id="cb50-607"><a href="#cb50-607"></a>We know that $\beta$, $S_0$, and $I_0$ must be positive, but our search to optimize these parameters will be over the entire number line.</span>
<span id="cb50-608"><a href="#cb50-608"></a>We could constrain the search using a more sophisticated algorithm, but this might introduce other problems (i.e., stability at the boundaries).</span>
<span id="cb50-609"><a href="#cb50-609"></a>Instead, we parameterize our objective function (<span class="in">`sse_sir`</span>) in terms of some alternative variables $\ln(\beta)$, $\ln(S_0)$, and $\ln(I_0)$.</span>
<span id="cb50-610"><a href="#cb50-610"></a>While these numbers range from $-\infty$ to $\infty$ (the range of our search) they map to our model parameters on a range from $0$ to $\infty$ (the range that is biologically meaningful).</span>
<span id="cb50-611"><a href="#cb50-611"></a></span>
<span id="cb50-612"><a href="#cb50-612"></a><span class="fu">## Optimization</span></span>
<span id="cb50-613"><a href="#cb50-613"></a></span>
<span id="cb50-614"><a href="#cb50-614"></a>Our final step is to use the function <span class="in">`optim`</span> to find the values of $\beta$, $S_0$, and $I_0$ that minimize the sum of squared errors as calculated using our function.</span>
<span id="cb50-615"><a href="#cb50-615"></a></span>
<span id="cb50-616"><a href="#cb50-616"></a>Finally, we plot these fits against the data.</span>
<span id="cb50-617"><a href="#cb50-617"></a></span>
<span id="cb50-620"><a href="#cb50-620"></a><span class="in">```{r}</span></span>
<span id="cb50-621"><a href="#cb50-621"></a><span class="co"># Initial guess</span></span>
<span id="cb50-622"><a href="#cb50-622"></a>sse_optim_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> <span class="fu">log</span>(<span class="fl">0.055</span>), <span class="at">S_init =</span> <span class="fu">log</span>(<span class="dv">5000</span>), <span class="at">I_init =</span> <span class="fu">log</span>(<span class="dv">1</span>))</span>
<span id="cb50-623"><a href="#cb50-623"></a></span>
<span id="cb50-624"><a href="#cb50-624"></a><span class="co"># Create a dataframe of optimized parameters</span></span>
<span id="cb50-625"><a href="#cb50-625"></a>niamey_optims <span class="ot">&lt;-</span> niamey_df <span class="sc">%&gt;%</span></span>
<span id="cb50-626"><a href="#cb50-626"></a>  <span class="co"># Create a nested dataframe i.e. one row for each site, and the data column</span></span>
<span id="cb50-627"><a href="#cb50-627"></a>  <span class="co"># now is a list column that contains a separate dataframe of times and</span></span>
<span id="cb50-628"><a href="#cb50-628"></a>  <span class="co"># cases for each site</span></span>
<span id="cb50-629"><a href="#cb50-629"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>site) <span class="sc">%&gt;%</span></span>
<span id="cb50-630"><a href="#cb50-630"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-631"><a href="#cb50-631"></a>    <span class="co"># Map the optim() function call to each of the separate dataframes</span></span>
<span id="cb50-632"><a href="#cb50-632"></a>    <span class="co"># stored in the nested data column we just created</span></span>
<span id="cb50-633"><a href="#cb50-633"></a>    <span class="at">fit =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">optim</span>(sse_optim_params, sse_sir, <span class="at">data =</span> .x)),</span>
<span id="cb50-634"><a href="#cb50-634"></a>    <span class="co"># Map the exp() function to each of the model fits just created, and</span></span>
<span id="cb50-635"><a href="#cb50-635"></a>    <span class="co"># output to a dataframe instead of a list (like in map()), for easier</span></span>
<span id="cb50-636"><a href="#cb50-636"></a>    <span class="co"># use in the plottinge predictions later</span></span>
<span id="cb50-637"><a href="#cb50-637"></a>    <span class="fu">map_dfr</span>(fit, <span class="sc">~</span> <span class="fu">exp</span>(.x<span class="sc">$</span>par))</span>
<span id="cb50-638"><a href="#cb50-638"></a>  )</span>
<span id="cb50-639"><a href="#cb50-639"></a><span class="in">```</span></span>
<span id="cb50-640"><a href="#cb50-640"></a></span>
<span id="cb50-643"><a href="#cb50-643"></a><span class="in">```{r}</span></span>
<span id="cb50-644"><a href="#cb50-644"></a>niamey_optims <span class="sc">%&gt;%</span></span>
<span id="cb50-645"><a href="#cb50-645"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(data, fit)) <span class="sc">%&gt;%</span></span>
<span id="cb50-646"><a href="#cb50-646"></a>  <span class="fu">mutate</span>(<span class="at">site =</span> <span class="fu">str_replace_all</span>(site, <span class="st">"_"</span>, <span class="st">" "</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb50-647"><a href="#cb50-647"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-648"><a href="#cb50-648"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span>site, <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-649"><a href="#cb50-649"></a>  <span class="fu">fmt_scientific</span>(<span class="at">columns =</span> beta, <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-650"><a href="#cb50-650"></a>  <span class="co"># Relabel the column headers</span></span>
<span id="cb50-651"><a href="#cb50-651"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb50-652"><a href="#cb50-652"></a>    <span class="at">site =</span> <span class="fu">md</span>(<span class="st">"**Site**"</span>),</span>
<span id="cb50-653"><a href="#cb50-653"></a>    <span class="at">beta =</span> <span class="fu">md</span>(<span class="st">"**Beta**"</span>),</span>
<span id="cb50-654"><a href="#cb50-654"></a>    <span class="at">S_init =</span> <span class="fu">md</span>(<span class="st">"**Initial S**"</span>),</span>
<span id="cb50-655"><a href="#cb50-655"></a>    <span class="at">I_init =</span> <span class="fu">md</span>(<span class="st">"**Initial I**"</span>)</span>
<span id="cb50-656"><a href="#cb50-656"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb50-657"><a href="#cb50-657"></a>  <span class="co"># Apply style to the table with gray alternating rows</span></span>
<span id="cb50-658"><a href="#cb50-658"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">'gray'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-659"><a href="#cb50-659"></a>  <span class="co"># Increate space between columns</span></span>
<span id="cb50-660"><a href="#cb50-660"></a>  <span class="fu">opt_horizontal_padding</span>(<span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-661"><a href="#cb50-661"></a>  <span class="fu">cols_align</span>(<span class="st">"center"</span>)</span>
<span id="cb50-662"><a href="#cb50-662"></a><span class="in">```</span></span>
<span id="cb50-663"><a href="#cb50-663"></a></span>
<span id="cb50-664"><a href="#cb50-664"></a>::: callout-note</span>
<span id="cb50-665"><a href="#cb50-665"></a>You may have noticed that you can achieve slightly different results for the optimal parameter values using the interactive plot than are being presented here (though they are very similar).</span>
<span id="cb50-666"><a href="#cb50-666"></a>This is because while the optimization code is running in <span class="in">`R`</span>, the interactive plot and the calculation of the SSE is implemented using JavaScript.</span>
<span id="cb50-667"><a href="#cb50-667"></a>Therefore, despite using the same underlying model structure, the answers will vary slightly, because the ODE solvers are different, resulting in different model simulations.</span>
<span id="cb50-668"><a href="#cb50-668"></a>The difference is not enough to be concerned with here, but it is a point that's worth being aware of when you build your own models - you may want to perform sensitivity to confirm that your model implementation is not driving the magnitude of the results you see, and the inferences you make.</span>
<span id="cb50-669"><a href="#cb50-669"></a>:::</span>
<span id="cb50-670"><a href="#cb50-670"></a></span>
<span id="cb50-673"><a href="#cb50-673"></a><span class="in">```{r}</span></span>
<span id="cb50-674"><a href="#cb50-674"></a>niamey_predictions <span class="ot">&lt;-</span> niamey_optims <span class="sc">%&gt;%</span></span>
<span id="cb50-675"><a href="#cb50-675"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-676"><a href="#cb50-676"></a>    <span class="co"># For each of the different site's nested dataframes, fit the SIR model</span></span>
<span id="cb50-677"><a href="#cb50-677"></a>    <span class="co"># with the optimal parameters to get best fit predictions</span></span>
<span id="cb50-678"><a href="#cb50-678"></a>    <span class="at">predictions =</span> <span class="fu">pmap</span>(</span>
<span id="cb50-679"><a href="#cb50-679"></a>      <span class="at">.l =</span> <span class="fu">list</span>(</span>
<span id="cb50-680"><a href="#cb50-680"></a>        <span class="at">S_init =</span> S_init,</span>
<span id="cb50-681"><a href="#cb50-681"></a>        <span class="at">I_init =</span> I_init,</span>
<span id="cb50-682"><a href="#cb50-682"></a>        <span class="at">beta =</span> beta,</span>
<span id="cb50-683"><a href="#cb50-683"></a>        <span class="at">time_data =</span> data</span>
<span id="cb50-684"><a href="#cb50-684"></a>      ),</span>
<span id="cb50-685"><a href="#cb50-685"></a>      <span class="at">.f =</span> <span class="cf">function</span>(S_init, I_init, beta, time_data) {</span>
<span id="cb50-686"><a href="#cb50-686"></a>        site_times <span class="ot">&lt;-</span> time_data<span class="sc">$</span>biweek <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-687"><a href="#cb50-687"></a></span>
<span id="cb50-688"><a href="#cb50-688"></a>        <span class="co"># Return a dataframe of model solutions</span></span>
<span id="cb50-689"><a href="#cb50-689"></a>        <span class="fu">as_tibble</span>(<span class="fu">ode</span>(</span>
<span id="cb50-690"><a href="#cb50-690"></a>          <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> S_init, <span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb50-691"><a href="#cb50-691"></a>          <span class="at">times =</span> site_times,</span>
<span id="cb50-692"><a href="#cb50-692"></a>          <span class="at">func =</span> closed_sir_model,</span>
<span id="cb50-693"><a href="#cb50-693"></a>          <span class="at">parms =</span> beta,</span>
<span id="cb50-694"><a href="#cb50-694"></a>          <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb50-695"><a href="#cb50-695"></a>        )) <span class="sc">%&gt;%</span></span>
<span id="cb50-696"><a href="#cb50-696"></a>          <span class="co"># Make sure all values are numeric for plotting purposes</span></span>
<span id="cb50-697"><a href="#cb50-697"></a>          <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), as.numeric)) <span class="sc">%&gt;%</span></span>
<span id="cb50-698"><a href="#cb50-698"></a>          <span class="fu">mutate</span>(</span>
<span id="cb50-699"><a href="#cb50-699"></a>            <span class="at">incidence =</span> <span class="fu">ifelse</span>(</span>
<span id="cb50-700"><a href="#cb50-700"></a>              <span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb50-701"><a href="#cb50-701"></a>              new_inf[<span class="dv">1</span>],</span>
<span id="cb50-702"><a href="#cb50-702"></a>              <span class="fu">diff</span>(new_inf, <span class="at">lag =</span> <span class="dv">1</span>)</span>
<span id="cb50-703"><a href="#cb50-703"></a>            )</span>
<span id="cb50-704"><a href="#cb50-704"></a>          )</span>
<span id="cb50-705"><a href="#cb50-705"></a>      }</span>
<span id="cb50-706"><a href="#cb50-706"></a>    )</span>
<span id="cb50-707"><a href="#cb50-707"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb50-708"><a href="#cb50-708"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(data, predictions))</span>
<span id="cb50-709"><a href="#cb50-709"></a><span class="in">```</span></span>
<span id="cb50-710"><a href="#cb50-710"></a></span>
<span id="cb50-711"><a href="#cb50-711"></a>::: callout-important</span>
<span id="cb50-712"><a href="#cb50-712"></a>An important point to note is that our data is biweekly **incidence** (new cases in time period), whereas out SIR model produces **prevalence** (total cases at any time point).</span>
<span id="cb50-713"><a href="#cb50-713"></a>To account for this, our SIR model returns the cumulative incidence (line 32 of the model code), and our objective function extracts the biweekly incidence (lines 41-54), to ensure we are fitting the same data!</span>
<span id="cb50-714"><a href="#cb50-714"></a>This is a common source of error in interpretation when people fit models to data.</span>
<span id="cb50-715"><a href="#cb50-715"></a>:::</span>
<span id="cb50-716"><a href="#cb50-716"></a></span>
<span id="cb50-719"><a href="#cb50-719"></a><span class="in">```{r}</span></span>
<span id="cb50-720"><a href="#cb50-720"></a><span class="co">#| column: body</span></span>
<span id="cb50-721"><a href="#cb50-721"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb50-722"><a href="#cb50-722"></a><span class="co"># Create a dataframe to store the positions of the text labels</span></span>
<span id="cb50-723"><a href="#cb50-723"></a>niamey_preds_labels <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb50-724"><a href="#cb50-724"></a>  <span class="at">site =</span> <span class="fu">c</span>(<span class="st">"Site_1"</span>, <span class="st">"Site_2"</span>),</span>
<span id="cb50-725"><a href="#cb50-725"></a>  <span class="at">x_label =</span> <span class="fu">c</span>(<span class="fl">6.5</span>, <span class="fl">6.5</span>),</span>
<span id="cb50-726"><a href="#cb50-726"></a>  <span class="at">x_arrow_just =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>),</span>
<span id="cb50-727"><a href="#cb50-727"></a>  <span class="at">x_arrow_end =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="fl">7.75</span>),</span>
<span id="cb50-728"><a href="#cb50-728"></a>  <span class="at">y_label =</span> <span class="fu">c</span>(<span class="dv">900</span>, <span class="dv">600</span>),</span>
<span id="cb50-729"><a href="#cb50-729"></a>  <span class="at">y_arrow_just =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">80</span>, <span class="sc">-</span><span class="dv">70</span>),</span>
<span id="cb50-730"><a href="#cb50-730"></a>  <span class="at">y_arrow_end =</span> <span class="fu">c</span>(<span class="dv">350</span>, <span class="dv">290</span>),</span>
<span id="cb50-731"><a href="#cb50-731"></a>  <span class="at">commentary =</span> <span class="fu">c</span>(<span class="st">"**Predicted"</span>, <span class="st">"**Observed"</span>),</span>
<span id="cb50-732"><a href="#cb50-732"></a>  <span class="at">color =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, niamey_site_colors[<span class="st">"Site_2"</span>])</span>
<span id="cb50-733"><a href="#cb50-733"></a>)</span>
<span id="cb50-734"><a href="#cb50-734"></a></span>
<span id="cb50-735"><a href="#cb50-735"></a><span class="fu">ggplot</span>(niamey_predictions, <span class="fu">aes</span>(<span class="at">x =</span> biweek, <span class="at">group =</span> site)) <span class="sc">+</span></span>
<span id="cb50-736"><a href="#cb50-736"></a>  <span class="co"># Plot the actual data in color</span></span>
<span id="cb50-737"><a href="#cb50-737"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> cases, <span class="at">color =</span> site)) <span class="sc">+</span></span>
<span id="cb50-738"><a href="#cb50-738"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> cases, <span class="at">color =</span> site), <span class="at">size =</span> <span class="dv">4</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb50-739"><a href="#cb50-739"></a>  <span class="co"># Plot the best-fit model predictions in black</span></span>
<span id="cb50-740"><a href="#cb50-740"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> incidence), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb50-741"><a href="#cb50-741"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb50-742"><a href="#cb50-742"></a>    <span class="at">values =</span> niamey_site_colors,</span>
<span id="cb50-743"><a href="#cb50-743"></a>    <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">"color"</span>, <span class="st">"fill"</span>)</span>
<span id="cb50-744"><a href="#cb50-744"></a>  ) <span class="sc">+</span></span>
<span id="cb50-745"><a href="#cb50-745"></a>  <span class="co"># Place each site on it's own subplot and change labels</span></span>
<span id="cb50-746"><a href="#cb50-746"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb50-747"><a href="#cb50-747"></a>    <span class="sc">~</span>site,</span>
<span id="cb50-748"><a href="#cb50-748"></a>    <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb50-749"><a href="#cb50-749"></a>    <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb50-750"><a href="#cb50-750"></a>    <span class="at">labeller =</span> <span class="fu">as_labeller</span>(niamey_site_labels)</span>
<span id="cb50-751"><a href="#cb50-751"></a>  ) <span class="sc">+</span></span>
<span id="cb50-752"><a href="#cb50-752"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Biweek"</span>, <span class="at">y =</span> <span class="st">"Number of Case"</span>) <span class="sc">+</span></span>
<span id="cb50-753"><a href="#cb50-753"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb50-754"><a href="#cb50-754"></a>  ggtext<span class="sc">::</span><span class="fu">geom_textbox</span>(</span>
<span id="cb50-755"><a href="#cb50-755"></a>    <span class="at">data =</span> niamey_preds_labels,</span>
<span id="cb50-756"><a href="#cb50-756"></a>    <span class="fu">aes</span>(</span>
<span id="cb50-757"><a href="#cb50-757"></a>      <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb50-758"><a href="#cb50-758"></a>        <span class="st">"&lt;span style = </span><span class="sc">\"</span><span class="st">color:"</span>,</span>
<span id="cb50-759"><a href="#cb50-759"></a>        color,</span>
<span id="cb50-760"><a href="#cb50-760"></a>        <span class="st">"</span><span class="sc">\"</span><span class="st">&gt;"</span>,</span>
<span id="cb50-761"><a href="#cb50-761"></a>        commentary,</span>
<span id="cb50-762"><a href="#cb50-762"></a>        <span class="st">" Cases**"</span>,</span>
<span id="cb50-763"><a href="#cb50-763"></a>        <span class="st">"&lt;/span&gt;"</span></span>
<span id="cb50-764"><a href="#cb50-764"></a>      ),</span>
<span id="cb50-765"><a href="#cb50-765"></a>      <span class="at">x =</span> x_label,</span>
<span id="cb50-766"><a href="#cb50-766"></a>      <span class="at">y =</span> y_label</span>
<span id="cb50-767"><a href="#cb50-767"></a>    ),</span>
<span id="cb50-768"><a href="#cb50-768"></a>    <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb50-769"><a href="#cb50-769"></a>    <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb50-770"><a href="#cb50-770"></a>    <span class="at">box.colour =</span> <span class="cn">NA</span></span>
<span id="cb50-771"><a href="#cb50-771"></a>  ) <span class="sc">+</span></span>
<span id="cb50-772"><a href="#cb50-772"></a>  <span class="fu">geom_curve</span>(</span>
<span id="cb50-773"><a href="#cb50-773"></a>    <span class="at">data =</span> niamey_preds_labels,</span>
<span id="cb50-774"><a href="#cb50-774"></a>    <span class="fu">aes</span>(</span>
<span id="cb50-775"><a href="#cb50-775"></a>      <span class="at">x =</span> x_label <span class="sc">+</span> x_arrow_just,</span>
<span id="cb50-776"><a href="#cb50-776"></a>      <span class="at">xend =</span> x_arrow_end,</span>
<span id="cb50-777"><a href="#cb50-777"></a>      <span class="at">y =</span> y_label <span class="sc">+</span> y_arrow_just,</span>
<span id="cb50-778"><a href="#cb50-778"></a>      <span class="at">yend =</span> y_arrow_end</span>
<span id="cb50-779"><a href="#cb50-779"></a>    ),</span>
<span id="cb50-780"><a href="#cb50-780"></a>    <span class="at">linewidth =</span> <span class="fl">0.75</span>,</span>
<span id="cb50-781"><a href="#cb50-781"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>)),</span>
<span id="cb50-782"><a href="#cb50-782"></a>    <span class="at">curvature =</span> <span class="fu">list</span>(<span class="fl">0.25</span>),</span>
<span id="cb50-783"><a href="#cb50-783"></a>    <span class="at">color =</span> <span class="st">"grey20"</span></span>
<span id="cb50-784"><a href="#cb50-784"></a>  )</span>
<span id="cb50-785"><a href="#cb50-785"></a><span class="in">```</span></span>
<span id="cb50-786"><a href="#cb50-786"></a></span>
<span id="cb50-787"><a href="#cb50-787"></a>::: exercise</span>
<span id="cb50-788"><a href="#cb50-788"></a><span class="fu">### Exercise 5</span></span>
<span id="cb50-789"><a href="#cb50-789"></a>:::</span>
<span id="cb50-790"><a href="#cb50-790"></a></span>
<span id="cb50-791"><a href="#cb50-791"></a>To make things easier, we have assumed the infectious period is known to be 14 days.</span>
<span id="cb50-792"><a href="#cb50-792"></a>In terms of years, $\text{D} = \frac{14}{365} \approx 0.0384$, and the recovery rate is the inverse i.e., $\gamma = \frac{14}{365}$.</span>
<span id="cb50-793"><a href="#cb50-793"></a>Now, modify the code above to estimate $\gamma$ and $\beta$ simultaneously.</span>
<span id="cb50-794"><a href="#cb50-794"></a></span>
<span id="cb50-795"><a href="#cb50-795"></a>::: exercise</span>
<span id="cb50-796"><a href="#cb50-796"></a><span class="fu">### Exercise 6</span></span>
<span id="cb50-797"><a href="#cb50-797"></a>:::</span>
<span id="cb50-798"><a href="#cb50-798"></a></span>
<span id="cb50-799"><a href="#cb50-799"></a>What happens if one or both of the other unknowns ($S_0$ and $I_0$) is fixed instead of $\gamma$?</span>
<span id="cb50-800"><a href="#cb50-800"></a></span>
<span id="cb50-801"><a href="#cb50-801"></a><span class="fu">## Solutions</span></span>
<span id="cb50-802"><a href="#cb50-802"></a></span>
<span id="cb50-803"><a href="#cb50-803"></a><span class="fu">### Exercise 1</span></span>
<span id="cb50-804"><a href="#cb50-804"></a></span>
<span id="cb50-807"><a href="#cb50-807"></a><span class="in">```{r}</span></span>
<span id="cb50-808"><a href="#cb50-808"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-809"><a href="#cb50-809"></a>p_infec <span class="ot">&lt;-</span> (<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.001</span>))</span>
<span id="cb50-810"><a href="#cb50-810"></a>r0_p <span class="ot">&lt;-</span> (<span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> p_infec)) <span class="sc">/</span> (<span class="sc">-</span>p_infec)</span>
<span id="cb50-811"><a href="#cb50-811"></a><span class="fu">plot</span>(</span>
<span id="cb50-812"><a href="#cb50-812"></a>  <span class="at">x =</span> p_infec,</span>
<span id="cb50-813"><a href="#cb50-813"></a>  <span class="at">y =</span> r0_p,</span>
<span id="cb50-814"><a href="#cb50-814"></a>  <span class="at">main =</span> <span class="st">"Relationship between final proportion infected and R0"</span>,</span>
<span id="cb50-815"><a href="#cb50-815"></a>  <span class="at">xlab =</span> <span class="st">"Final proportion infected"</span>,</span>
<span id="cb50-816"><a href="#cb50-816"></a>  <span class="at">ylab =</span> <span class="st">"R0"</span></span>
<span id="cb50-817"><a href="#cb50-817"></a>)</span>
<span id="cb50-818"><a href="#cb50-818"></a><span class="in">```</span></span>
<span id="cb50-819"><a href="#cb50-819"></a></span>
<span id="cb50-820"><a href="#cb50-820"></a><span class="fu">### Exercise 2</span></span>
<span id="cb50-821"><a href="#cb50-821"></a></span>
<span id="cb50-824"><a href="#cb50-824"></a><span class="in">```{r}</span></span>
<span id="cb50-825"><a href="#cb50-825"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-826"><a href="#cb50-826"></a><span class="co">#A: If the cases were isolated after 24 hours, then gamma would be 1/1 = 1, and if the cases were isolated after 12 hours, gamma would be 1/0.5 = 2. R0 would be calculated as the beta coefficient over gamma, below:</span></span>
<span id="cb50-827"><a href="#cb50-827"></a></span>
<span id="cb50-828"><a href="#cb50-828"></a>r0_g1 <span class="ot">&lt;-</span> <span class="fl">1.094913</span> <span class="sc">/</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb50-829"><a href="#cb50-829"></a>r0_g1</span>
<span id="cb50-830"><a href="#cb50-830"></a></span>
<span id="cb50-831"><a href="#cb50-831"></a>r0_g2 <span class="ot">&lt;-</span> <span class="fl">1.094913</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb50-832"><a href="#cb50-832"></a>r0_g2</span>
<span id="cb50-833"><a href="#cb50-833"></a><span class="in">```</span></span>
<span id="cb50-834"><a href="#cb50-834"></a></span>
<span id="cb50-835"><a href="#cb50-835"></a><span class="fu">### Exercise 3</span></span>
<span id="cb50-836"><a href="#cb50-836"></a></span>
<span id="cb50-839"><a href="#cb50-839"></a><span class="in">```{r}</span></span>
<span id="cb50-840"><a href="#cb50-840"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-841"><a href="#cb50-841"></a>niamey[<span class="dv">5</span>, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#replace a "NA"</span></span>
<span id="cb50-842"><a href="#cb50-842"></a><span class="co">#the command below organizes the data so it can be plotted and analyzed</span></span>
<span id="cb50-843"><a href="#cb50-843"></a>niamey <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb50-844"><a href="#cb50-844"></a>  <span class="at">biweek =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">16</span>), <span class="dv">3</span>),</span>
<span id="cb50-845"><a href="#cb50-845"></a>  <span class="at">site =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">16</span>), <span class="fu">rep</span>(<span class="dv">2</span>, <span class="dv">16</span>), <span class="fu">rep</span>(<span class="dv">3</span>, <span class="dv">16</span>)),</span>
<span id="cb50-846"><a href="#cb50-846"></a>  <span class="at">cases =</span> <span class="fu">c</span>(niamey[, <span class="dv">1</span>], niamey[, <span class="dv">2</span>], niamey[, <span class="dv">3</span>])</span>
<span id="cb50-847"><a href="#cb50-847"></a>) <span class="co">#define "biweeks"</span></span>
<span id="cb50-848"><a href="#cb50-848"></a></span>
<span id="cb50-849"><a href="#cb50-849"></a><span class="co"># As the data are reported every two weeks, this corresponds to the 10th observation. Let’s fit a linear model</span></span>
<span id="cb50-850"><a href="#cb50-850"></a><span class="in">```</span></span>
<span id="cb50-851"><a href="#cb50-851"></a></span>
<span id="cb50-854"><a href="#cb50-854"></a><span class="in">```{r}</span></span>
<span id="cb50-855"><a href="#cb50-855"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-856"><a href="#cb50-856"></a></span>
<span id="cb50-857"><a href="#cb50-857"></a><span class="co"># First let's see what the outbreak looks like for the first community on a linear scale</span></span>
<span id="cb50-858"><a href="#cb50-858"></a><span class="fu">plot</span>(</span>
<span id="cb50-859"><a href="#cb50-859"></a>  niamey<span class="sc">$</span>biweek[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb50-860"><a href="#cb50-860"></a>  niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb50-861"><a href="#cb50-861"></a>  <span class="at">type =</span> <span class="st">'p'</span>,</span>
<span id="cb50-862"><a href="#cb50-862"></a>  <span class="at">col =</span> niamey<span class="sc">$</span>site,</span>
<span id="cb50-863"><a href="#cb50-863"></a>  <span class="at">xlab =</span> <span class="st">'Biweek'</span>,</span>
<span id="cb50-864"><a href="#cb50-864"></a>  <span class="at">ylab =</span> <span class="st">'Cases'</span></span>
<span id="cb50-865"><a href="#cb50-865"></a>)</span>
<span id="cb50-866"><a href="#cb50-866"></a><span class="fu">lines</span>(niamey<span class="sc">$</span>biweek[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb50-867"><a href="#cb50-867"></a><span class="in">```</span></span>
<span id="cb50-868"><a href="#cb50-868"></a></span>
<span id="cb50-871"><a href="#cb50-871"></a><span class="in">```{r}</span></span>
<span id="cb50-872"><a href="#cb50-872"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-873"><a href="#cb50-873"></a></span>
<span id="cb50-874"><a href="#cb50-874"></a><span class="co"># Now let’s try it on a log scale to see until when the outbreak is roughly linear</span></span>
<span id="cb50-875"><a href="#cb50-875"></a><span class="fu">plot</span>(</span>
<span id="cb50-876"><a href="#cb50-876"></a>  niamey<span class="sc">$</span>biweek[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb50-877"><a href="#cb50-877"></a>  niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb50-878"><a href="#cb50-878"></a>  <span class="at">type =</span> <span class="st">'p'</span>,</span>
<span id="cb50-879"><a href="#cb50-879"></a>  <span class="at">col =</span> niamey<span class="sc">$</span>site,</span>
<span id="cb50-880"><a href="#cb50-880"></a>  <span class="at">xlab =</span> <span class="st">'Biweek'</span>,</span>
<span id="cb50-881"><a href="#cb50-881"></a>  <span class="at">ylab =</span> <span class="st">'Cases'</span>,</span>
<span id="cb50-882"><a href="#cb50-882"></a>  <span class="at">log =</span> <span class="st">'y'</span></span>
<span id="cb50-883"><a href="#cb50-883"></a>)</span>
<span id="cb50-884"><a href="#cb50-884"></a><span class="fu">lines</span>(niamey<span class="sc">$</span>biweek[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb50-885"><a href="#cb50-885"></a><span class="in">```</span></span>
<span id="cb50-886"><a href="#cb50-886"></a></span>
<span id="cb50-889"><a href="#cb50-889"></a><span class="in">```{r}</span></span>
<span id="cb50-890"><a href="#cb50-890"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-891"><a href="#cb50-891"></a><span class="co"># here we create a "week" variable to run the analysis on a weekly</span></span>
<span id="cb50-892"><a href="#cb50-892"></a>niamey<span class="sc">$</span>week <span class="ot">&lt;-</span> niamey<span class="sc">$</span>biweek <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb50-893"><a href="#cb50-893"></a><span class="co"># we use the `head` command to take the first N values of a vector. In this case, we're taking the first 10 values of our outcome (cases) and predictor (time) variables.</span></span>
<span id="cb50-894"><a href="#cb50-894"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb50-895"><a href="#cb50-895"></a>  <span class="fu">log</span>(<span class="fu">head</span>(niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], <span class="dv">10</span>)) <span class="sc">~</span></span>
<span id="cb50-896"><a href="#cb50-896"></a>    (<span class="fu">head</span>(niamey<span class="sc">$</span>week[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], <span class="dv">10</span>))</span>
<span id="cb50-897"><a href="#cb50-897"></a>)</span>
<span id="cb50-898"><a href="#cb50-898"></a><span class="fu">summary</span>(model) <span class="co">#summary statistics for fit model</span></span>
<span id="cb50-899"><a href="#cb50-899"></a><span class="in">```</span></span>
<span id="cb50-900"><a href="#cb50-900"></a></span>
<span id="cb50-903"><a href="#cb50-903"></a><span class="in">```{r}</span></span>
<span id="cb50-904"><a href="#cb50-904"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-905"><a href="#cb50-905"></a><span class="co"># Now let's get the slope and display it</span></span>
<span id="cb50-906"><a href="#cb50-906"></a>slope <span class="ot">&lt;-</span> <span class="fu">coef</span>(model)[<span class="dv">2</span>] <span class="co">#extract slope parameter</span></span>
<span id="cb50-907"><a href="#cb50-907"></a>slope <span class="co">#print to screen</span></span>
<span id="cb50-908"><a href="#cb50-908"></a><span class="in">```</span></span>
<span id="cb50-909"><a href="#cb50-909"></a></span>
<span id="cb50-910"><a href="#cb50-910"></a>As we ran the model by weeks, the $\gamma$ value is $2^{-1}$ and $\hat R_0 = \hat \beta_1 / \gamma +1$ giving $\hat R_0=0.2196041/0.5+1 \approx 1.44$.</span>
<span id="cb50-911"><a href="#cb50-911"></a></span>
<span id="cb50-912"><a href="#cb50-912"></a><span class="fu">### Exercise 4</span></span>
<span id="cb50-913"><a href="#cb50-913"></a></span>
<span id="cb50-914"><a href="#cb50-914"></a>Here, we can use a loop and repeat the regression procedure we used above for varying numbers of initial data points in our model.</span>
<span id="cb50-915"><a href="#cb50-915"></a></span>
<span id="cb50-918"><a href="#cb50-918"></a><span class="in">```{r}</span></span>
<span id="cb50-919"><a href="#cb50-919"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-920"><a href="#cb50-920"></a>slope <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb50-921"><a href="#cb50-921"></a>se <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb50-922"><a href="#cb50-922"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">18</span>) {</span>
<span id="cb50-923"><a href="#cb50-923"></a>  model <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb50-924"><a href="#cb50-924"></a>    <span class="fu">log</span>(<span class="fu">head</span>(niamey<span class="sc">$</span>cases[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], i)) <span class="sc">~</span></span>
<span id="cb50-925"><a href="#cb50-925"></a>      (<span class="fu">head</span>(niamey<span class="sc">$</span>week[niamey<span class="sc">$</span>site <span class="sc">==</span> <span class="dv">1</span>], i))</span>
<span id="cb50-926"><a href="#cb50-926"></a>  )</span>
<span id="cb50-927"><a href="#cb50-927"></a>  slope <span class="ot">&lt;-</span> <span class="fu">c</span>(slope, <span class="fu">as.numeric</span>(<span class="fu">coef</span>(model)[<span class="dv">2</span>]))</span>
<span id="cb50-928"><a href="#cb50-928"></a>  se <span class="ot">&lt;-</span> <span class="fu">c</span>(se, <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients[<span class="dv">4</span>])</span>
<span id="cb50-929"><a href="#cb50-929"></a>}</span>
<span id="cb50-930"><a href="#cb50-930"></a>R0 <span class="ot">&lt;-</span> slope <span class="sc">/</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb50-931"><a href="#cb50-931"></a><span class="fu">plot</span>(R0, se, <span class="at">ylab =</span> <span class="st">'Standard error'</span>)</span>
<span id="cb50-932"><a href="#cb50-932"></a><span class="in">```</span></span>
<span id="cb50-933"><a href="#cb50-933"></a></span>
<span id="cb50-934"><a href="#cb50-934"></a><span class="fu">### Exercise 5</span></span>
<span id="cb50-935"><a href="#cb50-935"></a></span>
<span id="cb50-936"><a href="#cb50-936"></a>First, let's add in $\gamma$ estimation into the <span class="in">`sse.sir`</span> function and create a new <span class="in">`sse.sir`</span> function called <span class="in">`sse.sir.g`</span></span>
<span id="cb50-937"><a href="#cb50-937"></a></span>
<span id="cb50-940"><a href="#cb50-940"></a><span class="in">```{r}</span></span>
<span id="cb50-941"><a href="#cb50-941"></a><span class="co">#' Basic SIR model</span></span>
<span id="cb50-942"><a href="#cb50-942"></a><span class="co">#'</span></span>
<span id="cb50-943"><a href="#cb50-943"></a><span class="co">#' A basic SIR model with no demographic structure to be used in deSolve</span></span>
<span id="cb50-944"><a href="#cb50-944"></a><span class="co">#'</span></span>
<span id="cb50-945"><a href="#cb50-945"></a><span class="co">#' @param time deSolve passes the time parameter to the function.</span></span>
<span id="cb50-946"><a href="#cb50-946"></a><span class="co">#' @param state A vector of states.</span></span>
<span id="cb50-947"><a href="#cb50-947"></a><span class="co">#' @param params The beta parameter</span></span>
<span id="cb50-948"><a href="#cb50-948"></a><span class="co">#' @param ... Other arguments passed by deSolve.</span></span>
<span id="cb50-949"><a href="#cb50-949"></a><span class="co">#'</span></span>
<span id="cb50-950"><a href="#cb50-950"></a><span class="co">#' @return A deSolve matrix of states at each time step.</span></span>
<span id="cb50-951"><a href="#cb50-951"></a><span class="co">#' @examples</span></span>
<span id="cb50-952"><a href="#cb50-952"></a><span class="co">#' sir_params &lt;- 0.0005</span></span>
<span id="cb50-953"><a href="#cb50-953"></a><span class="co">#' sir_init_states &lt;- c(S = 5000, I = 1, R = 0)</span></span>
<span id="cb50-954"><a href="#cb50-954"></a><span class="co">#' sim_times &lt;- seq(0, 16 / 365, by = 0.1 / 365)</span></span>
<span id="cb50-955"><a href="#cb50-955"></a><span class="co">#'</span></span>
<span id="cb50-956"><a href="#cb50-956"></a><span class="co">#' sir_sol &lt;- deSolve::ode(</span></span>
<span id="cb50-957"><a href="#cb50-957"></a><span class="co">#'    y = sir_init_states,</span></span>
<span id="cb50-958"><a href="#cb50-958"></a><span class="co">#'    times = sim_times,</span></span>
<span id="cb50-959"><a href="#cb50-959"></a><span class="co">#'    func = closed_sir_model,</span></span>
<span id="cb50-960"><a href="#cb50-960"></a><span class="co">#'    parms = sir_params</span></span>
<span id="cb50-961"><a href="#cb50-961"></a><span class="co">#' )</span></span>
<span id="cb50-962"><a href="#cb50-962"></a></span>
<span id="cb50-963"><a href="#cb50-963"></a><span class="co"># Create a new SIR model to include gamma</span></span>
<span id="cb50-964"><a href="#cb50-964"></a>closed_sir_model_g <span class="ot">&lt;-</span> <span class="cf">function</span>(time, state, params, ...) {</span>
<span id="cb50-965"><a href="#cb50-965"></a>  <span class="co"># Unpack states</span></span>
<span id="cb50-966"><a href="#cb50-966"></a>  S <span class="ot">&lt;-</span> state[<span class="st">"S"</span>]</span>
<span id="cb50-967"><a href="#cb50-967"></a>  I <span class="ot">&lt;-</span> state[<span class="st">"I"</span>]</span>
<span id="cb50-968"><a href="#cb50-968"></a></span>
<span id="cb50-969"><a href="#cb50-969"></a>  <span class="co"># Unpack parameters</span></span>
<span id="cb50-970"><a href="#cb50-970"></a>  beta <span class="ot">&lt;-</span> params[[<span class="st">"beta"</span>]]</span>
<span id="cb50-971"><a href="#cb50-971"></a>  dur_inf <span class="ot">&lt;-</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-972"><a href="#cb50-972"></a>  gamma <span class="ot">&lt;-</span> params[[<span class="st">"gamma"</span>]]</span>
<span id="cb50-973"><a href="#cb50-973"></a></span>
<span id="cb50-974"><a href="#cb50-974"></a>  new_inf <span class="ot">&lt;-</span> beta <span class="sc">*</span> S <span class="sc">*</span> I</span>
<span id="cb50-975"><a href="#cb50-975"></a></span>
<span id="cb50-976"><a href="#cb50-976"></a>  <span class="co"># Calculate the ODEs</span></span>
<span id="cb50-977"><a href="#cb50-977"></a>  dSdt <span class="ot">&lt;-</span> <span class="sc">-</span>new_inf</span>
<span id="cb50-978"><a href="#cb50-978"></a>  dIdt <span class="ot">&lt;-</span> new_inf <span class="sc">-</span> (gamma <span class="sc">*</span> I)</span>
<span id="cb50-979"><a href="#cb50-979"></a></span>
<span id="cb50-980"><a href="#cb50-980"></a>  <span class="co"># Return the ODEs</span></span>
<span id="cb50-981"><a href="#cb50-981"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="fu">c</span>(dSdt, dIdt, new_inf)))</span>
<span id="cb50-982"><a href="#cb50-982"></a>}</span>
<span id="cb50-983"><a href="#cb50-983"></a></span>
<span id="cb50-984"><a href="#cb50-984"></a></span>
<span id="cb50-985"><a href="#cb50-985"></a><span class="co">#' Calculate the Sum of Squared Errors</span></span>
<span id="cb50-986"><a href="#cb50-986"></a><span class="co">#'</span></span>
<span id="cb50-987"><a href="#cb50-987"></a><span class="co">#' A function to take in biweekly incidence data, and SIR parameters, and</span></span>
<span id="cb50-988"><a href="#cb50-988"></a><span class="co">#' calculate the SSE</span></span>
<span id="cb50-989"><a href="#cb50-989"></a><span class="co">#'</span></span>
<span id="cb50-990"><a href="#cb50-990"></a><span class="co">#' @param params A vector of parameter values</span></span>
<span id="cb50-991"><a href="#cb50-991"></a><span class="co">#' @param data A dataframe containing biweekly incidence data in the case column</span></span>
<span id="cb50-992"><a href="#cb50-992"></a><span class="co">#'</span></span>
<span id="cb50-993"><a href="#cb50-993"></a><span class="co">#' @return The SSE of type double</span></span>
<span id="cb50-994"><a href="#cb50-994"></a><span class="co">#' @examples</span></span>
<span id="cb50-995"><a href="#cb50-995"></a>sse_sir_g <span class="ot">&lt;-</span> <span class="cf">function</span>(params, data) {</span>
<span id="cb50-996"><a href="#cb50-996"></a>  <span class="co"># Convert biweekly time series into annual time scale</span></span>
<span id="cb50-997"><a href="#cb50-997"></a>  <span class="co"># Daily time scale has requires beta values to be too small - doesn't</span></span>
<span id="cb50-998"><a href="#cb50-998"></a>  <span class="co"># optimize well</span></span>
<span id="cb50-999"><a href="#cb50-999"></a>  dt <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb50-1000"><a href="#cb50-1000"></a>  max_biweek <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>biweek)</span>
<span id="cb50-1001"><a href="#cb50-1001"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_biweek <span class="sc">*</span> <span class="dv">14</span>, dt) <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-1002"><a href="#cb50-1002"></a></span>
<span id="cb50-1003"><a href="#cb50-1003"></a>  <span class="co"># Extract the number of observed incidence</span></span>
<span id="cb50-1004"><a href="#cb50-1004"></a>  obs_inc <span class="ot">&lt;-</span> data<span class="sc">$</span>cases</span>
<span id="cb50-1005"><a href="#cb50-1005"></a></span>
<span id="cb50-1006"><a href="#cb50-1006"></a>  <span class="co"># Note the parameters are updated throughout the optimization process by</span></span>
<span id="cb50-1007"><a href="#cb50-1007"></a>  <span class="co"># the optim() function</span></span>
<span id="cb50-1008"><a href="#cb50-1008"></a>  <span class="co"># Unpack the transmission parameter and exponentiate to fit on ln scale</span></span>
<span id="cb50-1009"><a href="#cb50-1009"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"beta"</span>]])</span>
<span id="cb50-1010"><a href="#cb50-1010"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"gamma"</span>]])</span>
<span id="cb50-1011"><a href="#cb50-1011"></a></span>
<span id="cb50-1012"><a href="#cb50-1012"></a>  in_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"beta"</span> <span class="ot">=</span> beta, <span class="st">"gamma"</span> <span class="ot">=</span> gamma)</span>
<span id="cb50-1013"><a href="#cb50-1013"></a>  <span class="co"># Unpack the initial states and exponentiate to fit on normal scale</span></span>
<span id="cb50-1014"><a href="#cb50-1014"></a>  S_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"S_init"</span>]])</span>
<span id="cb50-1015"><a href="#cb50-1015"></a>  I_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"I_init"</span>]])</span>
<span id="cb50-1016"><a href="#cb50-1016"></a></span>
<span id="cb50-1017"><a href="#cb50-1017"></a>  <span class="co"># Fit SIR model to the parameters</span></span>
<span id="cb50-1018"><a href="#cb50-1018"></a>  sol <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb50-1019"><a href="#cb50-1019"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> S_init, <span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb50-1020"><a href="#cb50-1020"></a>    <span class="at">times =</span> t,</span>
<span id="cb50-1021"><a href="#cb50-1021"></a>    <span class="at">func =</span> closed_sir_model_g,</span>
<span id="cb50-1022"><a href="#cb50-1022"></a>    <span class="at">parms =</span> in_parms,</span>
<span id="cb50-1023"><a href="#cb50-1023"></a>    <span class="co"># Use rk4 as fixed time steps, which is important for indexing</span></span>
<span id="cb50-1024"><a href="#cb50-1024"></a>    <span class="at">method =</span> <span class="st">"rk4"</span></span>
<span id="cb50-1025"><a href="#cb50-1025"></a>  )</span>
<span id="cb50-1026"><a href="#cb50-1026"></a></span>
<span id="cb50-1027"><a href="#cb50-1027"></a>  <span class="co"># Extract the cumulative incidence</span></span>
<span id="cb50-1028"><a href="#cb50-1028"></a>  cum_inc <span class="ot">&lt;-</span> sol[, <span class="st">"new_inf"</span>]</span>
<span id="cb50-1029"><a href="#cb50-1029"></a></span>
<span id="cb50-1030"><a href="#cb50-1030"></a>  <span class="co"># Find the indices of the cumulative incidence to extract</span></span>
<span id="cb50-1031"><a href="#cb50-1031"></a>  biweek_index <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, max_biweek) <span class="sc">*</span> (<span class="dv">14</span> <span class="sc">/</span> dt) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb50-1032"><a href="#cb50-1032"></a></span>
<span id="cb50-1033"><a href="#cb50-1033"></a>  <span class="co"># Index cumulative incidence to get the values at the end of the biweeks</span></span>
<span id="cb50-1034"><a href="#cb50-1034"></a>  biweek_cum_inc <span class="ot">&lt;-</span> cum_inc[biweek_index]</span>
<span id="cb50-1035"><a href="#cb50-1035"></a></span>
<span id="cb50-1036"><a href="#cb50-1036"></a>  <span class="co"># Calculate the biweekly incidence by using the difference between</span></span>
<span id="cb50-1037"><a href="#cb50-1037"></a>  <span class="co"># consecutive biweeks. Need to manually prepend first week's incidence</span></span>
<span id="cb50-1038"><a href="#cb50-1038"></a>  <span class="co"># and add in the initial number of infectious individuals, as ODE model</span></span>
<span id="cb50-1039"><a href="#cb50-1039"></a>  <span class="co"># only returns the cumulative differences, which is 0 at the start.</span></span>
<span id="cb50-1040"><a href="#cb50-1040"></a>  biweek_inc <span class="ot">&lt;-</span> <span class="fu">c</span>(biweek_cum_inc[<span class="dv">1</span>] <span class="sc">+</span> I_init, <span class="fu">diff</span>(biweek_cum_inc, <span class="at">lag =</span> <span class="dv">1</span>))</span>
<span id="cb50-1041"><a href="#cb50-1041"></a></span>
<span id="cb50-1042"><a href="#cb50-1042"></a>  <span class="co"># return SSE of predicted vs observed incidence</span></span>
<span id="cb50-1043"><a href="#cb50-1043"></a>  <span class="fu">return</span>(<span class="fu">sum</span>((biweek_inc <span class="sc">-</span> obs_inc)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb50-1044"><a href="#cb50-1044"></a>}</span>
<span id="cb50-1045"><a href="#cb50-1045"></a><span class="in">```</span></span>
<span id="cb50-1046"><a href="#cb50-1046"></a></span>
<span id="cb50-1047"><a href="#cb50-1047"></a>Now we can run the code to optimize, beta, gamma, I0, and S0</span>
<span id="cb50-1048"><a href="#cb50-1048"></a></span>
<span id="cb50-1051"><a href="#cb50-1051"></a><span class="in">```{r}</span></span>
<span id="cb50-1052"><a href="#cb50-1052"></a>sse_optim_params_g <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb50-1053"><a href="#cb50-1053"></a>  <span class="at">beta =</span> <span class="fu">log</span>(<span class="fl">0.055</span>),</span>
<span id="cb50-1054"><a href="#cb50-1054"></a>  <span class="at">gamma =</span> <span class="fu">log</span>(<span class="dv">365</span> <span class="sc">/</span> <span class="dv">14</span>),</span>
<span id="cb50-1055"><a href="#cb50-1055"></a>  <span class="at">S_init =</span> <span class="fu">log</span>(<span class="dv">5000</span>),</span>
<span id="cb50-1056"><a href="#cb50-1056"></a>  <span class="at">I_init =</span> <span class="fu">log</span>(<span class="dv">1</span>)</span>
<span id="cb50-1057"><a href="#cb50-1057"></a>)</span>
<span id="cb50-1058"><a href="#cb50-1058"></a></span>
<span id="cb50-1059"><a href="#cb50-1059"></a><span class="co"># Create a dataframe of optimized parameters</span></span>
<span id="cb50-1060"><a href="#cb50-1060"></a>niamey_optims_g <span class="ot">&lt;-</span> niamey_df <span class="sc">%&gt;%</span></span>
<span id="cb50-1061"><a href="#cb50-1061"></a>  <span class="co"># Create a nested dataframe i.e. one row for each site, and the data column</span></span>
<span id="cb50-1062"><a href="#cb50-1062"></a>  <span class="co"># now is a list column that contains a separate dataframe of times and</span></span>
<span id="cb50-1063"><a href="#cb50-1063"></a>  <span class="co"># cases for each site</span></span>
<span id="cb50-1064"><a href="#cb50-1064"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>site) <span class="sc">%&gt;%</span></span>
<span id="cb50-1065"><a href="#cb50-1065"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-1066"><a href="#cb50-1066"></a>    <span class="co"># Map the optim() function call to each of the separate dataframes</span></span>
<span id="cb50-1067"><a href="#cb50-1067"></a>    <span class="co"># stored in the nested data column we just created</span></span>
<span id="cb50-1068"><a href="#cb50-1068"></a>    <span class="at">fit =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">optim</span>(sse_optim_params_g, sse_sir_g, <span class="at">data =</span> .x)),</span>
<span id="cb50-1069"><a href="#cb50-1069"></a>    <span class="co"># Map the exp() function to each of the model fits just created, and</span></span>
<span id="cb50-1070"><a href="#cb50-1070"></a>    <span class="co"># output to a dataframe instead of a list (like in map()), for easier</span></span>
<span id="cb50-1071"><a href="#cb50-1071"></a>    <span class="co"># use in the plottinge predictions later</span></span>
<span id="cb50-1072"><a href="#cb50-1072"></a>    <span class="fu">map_dfr</span>(fit, <span class="sc">~</span> <span class="fu">exp</span>(.x<span class="sc">$</span>par))</span>
<span id="cb50-1073"><a href="#cb50-1073"></a>  )</span>
<span id="cb50-1074"><a href="#cb50-1074"></a><span class="in">```</span></span>
<span id="cb50-1075"><a href="#cb50-1075"></a></span>
<span id="cb50-1076"><a href="#cb50-1076"></a>Now we can get our optimized parameters</span>
<span id="cb50-1077"><a href="#cb50-1077"></a></span>
<span id="cb50-1080"><a href="#cb50-1080"></a><span class="in">```{r}</span></span>
<span id="cb50-1081"><a href="#cb50-1081"></a>niamey_optims_g <span class="sc">%&gt;%</span></span>
<span id="cb50-1082"><a href="#cb50-1082"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(data, fit)) <span class="sc">%&gt;%</span></span>
<span id="cb50-1083"><a href="#cb50-1083"></a>  <span class="fu">mutate</span>(<span class="at">site =</span> <span class="fu">str_replace_all</span>(site, <span class="st">"_"</span>, <span class="st">" "</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb50-1084"><a href="#cb50-1084"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-1085"><a href="#cb50-1085"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span>site, <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-1086"><a href="#cb50-1086"></a>  <span class="fu">fmt_scientific</span>(<span class="at">columns =</span> beta, <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-1087"><a href="#cb50-1087"></a>  <span class="co"># Relabel the column headers</span></span>
<span id="cb50-1088"><a href="#cb50-1088"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb50-1089"><a href="#cb50-1089"></a>    <span class="at">site =</span> <span class="fu">md</span>(<span class="st">"**Site**"</span>),</span>
<span id="cb50-1090"><a href="#cb50-1090"></a>    <span class="at">beta =</span> <span class="fu">md</span>(<span class="st">"**Beta**"</span>),</span>
<span id="cb50-1091"><a href="#cb50-1091"></a>    <span class="at">gamma =</span> <span class="fu">md</span>(<span class="st">"**Gamma**"</span>),</span>
<span id="cb50-1092"><a href="#cb50-1092"></a>    <span class="at">S_init =</span> <span class="fu">md</span>(<span class="st">"**Initial S**"</span>),</span>
<span id="cb50-1093"><a href="#cb50-1093"></a>    <span class="at">I_init =</span> <span class="fu">md</span>(<span class="st">"**Initial I**"</span>)</span>
<span id="cb50-1094"><a href="#cb50-1094"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb50-1095"><a href="#cb50-1095"></a>  <span class="co"># Apply style to the table with gray alternating rows</span></span>
<span id="cb50-1096"><a href="#cb50-1096"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">'gray'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-1097"><a href="#cb50-1097"></a>  <span class="co"># Increate space between columns</span></span>
<span id="cb50-1098"><a href="#cb50-1098"></a>  <span class="fu">opt_horizontal_padding</span>(<span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-1099"><a href="#cb50-1099"></a>  <span class="fu">cols_align</span>(<span class="st">"center"</span>)</span>
<span id="cb50-1100"><a href="#cb50-1100"></a><span class="in">```</span></span>
<span id="cb50-1101"><a href="#cb50-1101"></a></span>
<span id="cb50-1102"><a href="#cb50-1102"></a>Getting new predictions from the optimized parameters and a new model run for each site.</span>
<span id="cb50-1103"><a href="#cb50-1103"></a></span>
<span id="cb50-1106"><a href="#cb50-1106"></a><span class="in">```{r}</span></span>
<span id="cb50-1107"><a href="#cb50-1107"></a>niamey_predictions_g <span class="ot">&lt;-</span> niamey_optims_g <span class="sc">%&gt;%</span></span>
<span id="cb50-1108"><a href="#cb50-1108"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-1109"><a href="#cb50-1109"></a>    <span class="co"># For each of the different site's nested dataframes, fit the SIR model</span></span>
<span id="cb50-1110"><a href="#cb50-1110"></a>    <span class="co"># with the optimal parameters to get best fit predictions</span></span>
<span id="cb50-1111"><a href="#cb50-1111"></a>    <span class="at">predictions =</span> <span class="fu">pmap</span>(</span>
<span id="cb50-1112"><a href="#cb50-1112"></a>      <span class="at">.l =</span> <span class="fu">list</span>(</span>
<span id="cb50-1113"><a href="#cb50-1113"></a>        <span class="at">S_init =</span> S_init,</span>
<span id="cb50-1114"><a href="#cb50-1114"></a>        <span class="at">I_init =</span> I_init,</span>
<span id="cb50-1115"><a href="#cb50-1115"></a>        <span class="at">beta =</span> beta,</span>
<span id="cb50-1116"><a href="#cb50-1116"></a>        <span class="at">gamma =</span> gamma,</span>
<span id="cb50-1117"><a href="#cb50-1117"></a>        <span class="at">time_data =</span> data</span>
<span id="cb50-1118"><a href="#cb50-1118"></a>      ),</span>
<span id="cb50-1119"><a href="#cb50-1119"></a>      <span class="at">.f =</span> <span class="cf">function</span>(S_init, I_init, beta, gamma, time_data) {</span>
<span id="cb50-1120"><a href="#cb50-1120"></a>        site_times <span class="ot">&lt;-</span> time_data<span class="sc">$</span>biweek <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-1121"><a href="#cb50-1121"></a></span>
<span id="cb50-1122"><a href="#cb50-1122"></a>        in_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"beta"</span> <span class="ot">=</span> beta, <span class="st">"gamma"</span> <span class="ot">=</span> gamma)</span>
<span id="cb50-1123"><a href="#cb50-1123"></a>        <span class="co"># Return a dataframe of model solutions</span></span>
<span id="cb50-1124"><a href="#cb50-1124"></a>        <span class="fu">as_tibble</span>(<span class="fu">ode</span>(</span>
<span id="cb50-1125"><a href="#cb50-1125"></a>          <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> S_init, <span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb50-1126"><a href="#cb50-1126"></a>          <span class="at">times =</span> site_times,</span>
<span id="cb50-1127"><a href="#cb50-1127"></a>          <span class="at">func =</span> closed_sir_model_g,</span>
<span id="cb50-1128"><a href="#cb50-1128"></a>          <span class="at">parms =</span> in_parms,</span>
<span id="cb50-1129"><a href="#cb50-1129"></a>          <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb50-1130"><a href="#cb50-1130"></a>        )) <span class="sc">%&gt;%</span></span>
<span id="cb50-1131"><a href="#cb50-1131"></a>          <span class="co"># Make sure all values are numeric for plotting purposes</span></span>
<span id="cb50-1132"><a href="#cb50-1132"></a>          <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), as.numeric)) <span class="sc">%&gt;%</span></span>
<span id="cb50-1133"><a href="#cb50-1133"></a>          <span class="fu">mutate</span>(</span>
<span id="cb50-1134"><a href="#cb50-1134"></a>            <span class="at">incidence =</span> <span class="fu">ifelse</span>(</span>
<span id="cb50-1135"><a href="#cb50-1135"></a>              <span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb50-1136"><a href="#cb50-1136"></a>              new_inf[<span class="dv">1</span>],</span>
<span id="cb50-1137"><a href="#cb50-1137"></a>              <span class="fu">diff</span>(new_inf, <span class="at">lag =</span> <span class="dv">1</span>)</span>
<span id="cb50-1138"><a href="#cb50-1138"></a>            )</span>
<span id="cb50-1139"><a href="#cb50-1139"></a>          )</span>
<span id="cb50-1140"><a href="#cb50-1140"></a>      }</span>
<span id="cb50-1141"><a href="#cb50-1141"></a>    )</span>
<span id="cb50-1142"><a href="#cb50-1142"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb50-1143"><a href="#cb50-1143"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(data, predictions))</span>
<span id="cb50-1144"><a href="#cb50-1144"></a><span class="in">```</span></span>
<span id="cb50-1145"><a href="#cb50-1145"></a></span>
<span id="cb50-1146"><a href="#cb50-1146"></a>Finally we can plot:</span>
<span id="cb50-1147"><a href="#cb50-1147"></a></span>
<span id="cb50-1150"><a href="#cb50-1150"></a><span class="in">```{r}</span></span>
<span id="cb50-1151"><a href="#cb50-1151"></a><span class="co"># Create a dataframe to store the positions of the text labels</span></span>
<span id="cb50-1152"><a href="#cb50-1152"></a>niamey_preds_labels <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb50-1153"><a href="#cb50-1153"></a>  <span class="at">site =</span> <span class="fu">c</span>(<span class="st">"Site_1"</span>, <span class="st">"Site_2"</span>),</span>
<span id="cb50-1154"><a href="#cb50-1154"></a>  <span class="at">x_label =</span> <span class="fu">c</span>(<span class="fl">6.5</span>, <span class="fl">6.5</span>),</span>
<span id="cb50-1155"><a href="#cb50-1155"></a>  <span class="at">x_arrow_just =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>),</span>
<span id="cb50-1156"><a href="#cb50-1156"></a>  <span class="at">x_arrow_end =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="fl">7.75</span>),</span>
<span id="cb50-1157"><a href="#cb50-1157"></a>  <span class="at">y_label =</span> <span class="fu">c</span>(<span class="dv">900</span>, <span class="dv">600</span>),</span>
<span id="cb50-1158"><a href="#cb50-1158"></a>  <span class="at">y_arrow_just =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">80</span>, <span class="sc">-</span><span class="dv">70</span>),</span>
<span id="cb50-1159"><a href="#cb50-1159"></a>  <span class="at">y_arrow_end =</span> <span class="fu">c</span>(<span class="dv">350</span>, <span class="dv">290</span>),</span>
<span id="cb50-1160"><a href="#cb50-1160"></a>  <span class="at">commentary =</span> <span class="fu">c</span>(<span class="st">"**Predicted"</span>, <span class="st">"**Observed"</span>),</span>
<span id="cb50-1161"><a href="#cb50-1161"></a>  <span class="at">color =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, niamey_site_colors[<span class="st">"Site_2"</span>])</span>
<span id="cb50-1162"><a href="#cb50-1162"></a>)</span>
<span id="cb50-1163"><a href="#cb50-1163"></a></span>
<span id="cb50-1164"><a href="#cb50-1164"></a><span class="fu">ggplot</span>(niamey_predictions_g, <span class="fu">aes</span>(<span class="at">x =</span> biweek, <span class="at">group =</span> site)) <span class="sc">+</span></span>
<span id="cb50-1165"><a href="#cb50-1165"></a>  <span class="co"># Plot the actual data in color</span></span>
<span id="cb50-1166"><a href="#cb50-1166"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> cases, <span class="at">color =</span> site)) <span class="sc">+</span></span>
<span id="cb50-1167"><a href="#cb50-1167"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> cases, <span class="at">color =</span> site), <span class="at">size =</span> <span class="dv">4</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb50-1168"><a href="#cb50-1168"></a>  <span class="co"># Plot the best-fit model predictions in black</span></span>
<span id="cb50-1169"><a href="#cb50-1169"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> incidence), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb50-1170"><a href="#cb50-1170"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb50-1171"><a href="#cb50-1171"></a>    <span class="at">values =</span> niamey_site_colors,</span>
<span id="cb50-1172"><a href="#cb50-1172"></a>    <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">"color"</span>, <span class="st">"fill"</span>)</span>
<span id="cb50-1173"><a href="#cb50-1173"></a>  ) <span class="sc">+</span></span>
<span id="cb50-1174"><a href="#cb50-1174"></a>  <span class="co"># Place each site on it's own subplot and change labels</span></span>
<span id="cb50-1175"><a href="#cb50-1175"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb50-1176"><a href="#cb50-1176"></a>    <span class="sc">~</span>site,</span>
<span id="cb50-1177"><a href="#cb50-1177"></a>    <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb50-1178"><a href="#cb50-1178"></a>    <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb50-1179"><a href="#cb50-1179"></a>    <span class="at">labeller =</span> <span class="fu">as_labeller</span>(niamey_site_labels)</span>
<span id="cb50-1180"><a href="#cb50-1180"></a>  ) <span class="sc">+</span></span>
<span id="cb50-1181"><a href="#cb50-1181"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Biweek"</span>, <span class="at">y =</span> <span class="st">"Number of Case"</span>) <span class="sc">+</span></span>
<span id="cb50-1182"><a href="#cb50-1182"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb50-1183"><a href="#cb50-1183"></a>  ggtext<span class="sc">::</span><span class="fu">geom_textbox</span>(</span>
<span id="cb50-1184"><a href="#cb50-1184"></a>    <span class="at">data =</span> niamey_preds_labels,</span>
<span id="cb50-1185"><a href="#cb50-1185"></a>    <span class="fu">aes</span>(</span>
<span id="cb50-1186"><a href="#cb50-1186"></a>      <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb50-1187"><a href="#cb50-1187"></a>        <span class="st">"&lt;span style = </span><span class="sc">\"</span><span class="st">color:"</span>,</span>
<span id="cb50-1188"><a href="#cb50-1188"></a>        color,</span>
<span id="cb50-1189"><a href="#cb50-1189"></a>        <span class="st">"</span><span class="sc">\"</span><span class="st">&gt;"</span>,</span>
<span id="cb50-1190"><a href="#cb50-1190"></a>        commentary,</span>
<span id="cb50-1191"><a href="#cb50-1191"></a>        <span class="st">" Cases**"</span>,</span>
<span id="cb50-1192"><a href="#cb50-1192"></a>        <span class="st">"&lt;/span&gt;"</span></span>
<span id="cb50-1193"><a href="#cb50-1193"></a>      ),</span>
<span id="cb50-1194"><a href="#cb50-1194"></a>      <span class="at">x =</span> x_label,</span>
<span id="cb50-1195"><a href="#cb50-1195"></a>      <span class="at">y =</span> y_label</span>
<span id="cb50-1196"><a href="#cb50-1196"></a>    ),</span>
<span id="cb50-1197"><a href="#cb50-1197"></a>    <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb50-1198"><a href="#cb50-1198"></a>    <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb50-1199"><a href="#cb50-1199"></a>    <span class="at">box.colour =</span> <span class="cn">NA</span></span>
<span id="cb50-1200"><a href="#cb50-1200"></a>  ) <span class="sc">+</span></span>
<span id="cb50-1201"><a href="#cb50-1201"></a>  <span class="fu">geom_curve</span>(</span>
<span id="cb50-1202"><a href="#cb50-1202"></a>    <span class="at">data =</span> niamey_preds_labels,</span>
<span id="cb50-1203"><a href="#cb50-1203"></a>    <span class="fu">aes</span>(</span>
<span id="cb50-1204"><a href="#cb50-1204"></a>      <span class="at">x =</span> x_label <span class="sc">+</span> x_arrow_just,</span>
<span id="cb50-1205"><a href="#cb50-1205"></a>      <span class="at">xend =</span> x_arrow_end,</span>
<span id="cb50-1206"><a href="#cb50-1206"></a>      <span class="at">y =</span> y_label <span class="sc">+</span> y_arrow_just,</span>
<span id="cb50-1207"><a href="#cb50-1207"></a>      <span class="at">yend =</span> y_arrow_end</span>
<span id="cb50-1208"><a href="#cb50-1208"></a>    ),</span>
<span id="cb50-1209"><a href="#cb50-1209"></a>    <span class="at">linewidth =</span> <span class="fl">0.75</span>,</span>
<span id="cb50-1210"><a href="#cb50-1210"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>)),</span>
<span id="cb50-1211"><a href="#cb50-1211"></a>    <span class="at">curvature =</span> <span class="fu">list</span>(<span class="fl">0.25</span>),</span>
<span id="cb50-1212"><a href="#cb50-1212"></a>    <span class="at">color =</span> <span class="st">"grey20"</span></span>
<span id="cb50-1213"><a href="#cb50-1213"></a>  )</span>
<span id="cb50-1214"><a href="#cb50-1214"></a><span class="in">```</span></span>
<span id="cb50-1215"><a href="#cb50-1215"></a></span>
<span id="cb50-1218"><a href="#cb50-1218"></a><span class="in">```{r}</span></span>
<span id="cb50-1219"><a href="#cb50-1219"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-1220"><a href="#cb50-1220"></a><span class="co">#| echo: false</span></span>
<span id="cb50-1221"><a href="#cb50-1221"></a><span class="co">#| eval: false</span></span>
<span id="cb50-1222"><a href="#cb50-1222"></a>closed.sir.model.g <span class="ot">&lt;-</span> <span class="cf">function</span>(t, x, params) {</span>
<span id="cb50-1223"><a href="#cb50-1223"></a>  <span class="co">#SIR model equations</span></span>
<span id="cb50-1224"><a href="#cb50-1224"></a>  X <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb50-1225"><a href="#cb50-1225"></a>  Y <span class="ot">&lt;-</span> x[<span class="dv">2</span>]</span>
<span id="cb50-1226"><a href="#cb50-1226"></a>  beta <span class="ot">&lt;-</span> params[<span class="dv">1</span>]</span>
<span id="cb50-1227"><a href="#cb50-1227"></a>  gamma <span class="ot">&lt;-</span> params[<span class="dv">2</span>]</span>
<span id="cb50-1228"><a href="#cb50-1228"></a>  dX <span class="ot">&lt;-</span> <span class="sc">-</span>beta <span class="sc">*</span> X <span class="sc">*</span> Y</span>
<span id="cb50-1229"><a href="#cb50-1229"></a>  dY <span class="ot">&lt;-</span> beta <span class="sc">*</span> X <span class="sc">*</span> Y <span class="sc">-</span> gamma <span class="sc">*</span> Y</span>
<span id="cb50-1230"><a href="#cb50-1230"></a>  <span class="fu">list</span>(<span class="fu">c</span>(dX, dY))</span>
<span id="cb50-1231"><a href="#cb50-1231"></a>}</span>
<span id="cb50-1232"><a href="#cb50-1232"></a></span>
<span id="cb50-1233"><a href="#cb50-1233"></a>sse.sir.g <span class="ot">&lt;-</span> <span class="cf">function</span>(params0, data, site) {</span>
<span id="cb50-1234"><a href="#cb50-1234"></a>  <span class="co">#function to calculate squared errors</span></span>
<span id="cb50-1235"><a href="#cb50-1235"></a>  data <span class="ot">&lt;-</span> data[data<span class="sc">$</span>site <span class="sc">==</span> site, ] <span class="co">#working dataset, based on site</span></span>
<span id="cb50-1236"><a href="#cb50-1236"></a>  t <span class="ot">&lt;-</span> data[, <span class="dv">1</span>] <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span> <span class="co">#time in biweeks</span></span>
<span id="cb50-1237"><a href="#cb50-1237"></a>  cases <span class="ot">&lt;-</span> data[, <span class="dv">3</span>] <span class="co">#number of cases</span></span>
<span id="cb50-1238"><a href="#cb50-1238"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">1</span>]) <span class="co">#parameter beta</span></span>
<span id="cb50-1239"><a href="#cb50-1239"></a>  X0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">2</span>]) <span class="co">#initial susceptibles</span></span>
<span id="cb50-1240"><a href="#cb50-1240"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">3</span>]) <span class="co">#initial infected</span></span>
<span id="cb50-1241"><a href="#cb50-1241"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">4</span>]) <span class="co">#initial gamma</span></span>
<span id="cb50-1242"><a href="#cb50-1242"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ode</span>(</span>
<span id="cb50-1243"><a href="#cb50-1243"></a>    <span class="fu">c</span>(<span class="at">X =</span> X0, <span class="at">Y =</span> Y0),</span>
<span id="cb50-1244"><a href="#cb50-1244"></a>    <span class="at">times =</span> t,</span>
<span id="cb50-1245"><a href="#cb50-1245"></a>    closed.sir.model.g,</span>
<span id="cb50-1246"><a href="#cb50-1246"></a>    <span class="fu">c</span>(beta, gamma),</span>
<span id="cb50-1247"><a href="#cb50-1247"></a>    <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb50-1248"><a href="#cb50-1248"></a>  ))</span>
<span id="cb50-1249"><a href="#cb50-1249"></a>  <span class="fu">sum</span>((out<span class="sc">$</span>Y <span class="sc">-</span> cases)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#sum of squared errors that is returned to the optim function</span></span>
<span id="cb50-1250"><a href="#cb50-1250"></a>}</span>
<span id="cb50-1251"><a href="#cb50-1251"></a><span class="in">```</span></span>
<span id="cb50-1252"><a href="#cb50-1252"></a></span>
<span id="cb50-1255"><a href="#cb50-1255"></a><span class="in">```{r}</span></span>
<span id="cb50-1256"><a href="#cb50-1256"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-1257"><a href="#cb50-1257"></a><span class="co">#| echo: false</span></span>
<span id="cb50-1258"><a href="#cb50-1258"></a><span class="co">#| eval: false</span></span>
<span id="cb50-1259"><a href="#cb50-1259"></a>params0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.2</span>, <span class="fl">7.3</span>, <span class="sc">-</span><span class="fl">2.6</span>, <span class="fu">log</span>(<span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span>)) <span class="co"># initial guess</span></span>
<span id="cb50-1260"><a href="#cb50-1260"></a><span class="fu">print</span>(<span class="st">"Site 1"</span>)</span>
<span id="cb50-1261"><a href="#cb50-1261"></a>fit1.g <span class="ot">&lt;-</span> <span class="fu">optim</span>(params0, sse.sir.g, <span class="at">data =</span> niamey, <span class="at">site =</span> <span class="dv">1</span>, <span class="at">hessian =</span> <span class="cn">TRUE</span>) <span class="co">#fit</span></span>
<span id="cb50-1262"><a href="#cb50-1262"></a><span class="fu">exp</span>(fit1.g<span class="sc">$</span>par) <span class="co">#back-transform parameters</span></span>
<span id="cb50-1263"><a href="#cb50-1263"></a><span class="fu">print</span>(<span class="st">"Site 2"</span>)</span>
<span id="cb50-1264"><a href="#cb50-1264"></a>fit2.g <span class="ot">&lt;-</span> <span class="fu">optim</span>(params0, sse.sir.g, <span class="at">data =</span> niamey, <span class="at">site =</span> <span class="dv">2</span>, <span class="at">hessian =</span> <span class="cn">TRUE</span>) <span class="co">#fit</span></span>
<span id="cb50-1265"><a href="#cb50-1265"></a><span class="fu">exp</span>(fit2.g<span class="sc">$</span>par) <span class="co">#back-transform parameters</span></span>
<span id="cb50-1266"><a href="#cb50-1266"></a><span class="fu">print</span>(<span class="st">"Site 3"</span>)</span>
<span id="cb50-1267"><a href="#cb50-1267"></a>fit3.g <span class="ot">&lt;-</span> <span class="fu">optim</span>(params0, sse.sir.g, <span class="at">data =</span> niamey, <span class="at">site =</span> <span class="dv">3</span>, <span class="at">hessian =</span> <span class="cn">TRUE</span>) <span class="co">#fit</span></span>
<span id="cb50-1268"><a href="#cb50-1268"></a><span class="fu">exp</span>(fit3.g<span class="sc">$</span>par) <span class="co">#back-transform parameters</span></span>
<span id="cb50-1269"><a href="#cb50-1269"></a><span class="in">```</span></span>
<span id="cb50-1270"><a href="#cb50-1270"></a></span>
<span id="cb50-1273"><a href="#cb50-1273"></a><span class="in">```{r}</span></span>
<span id="cb50-1274"><a href="#cb50-1274"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-1275"><a href="#cb50-1275"></a><span class="co">#| echo: false</span></span>
<span id="cb50-1276"><a href="#cb50-1276"></a><span class="co">#| eval: false</span></span>
<span id="cb50-1277"><a href="#cb50-1277"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="co">#set up plotting area for multiple panels</span></span>
<span id="cb50-1278"><a href="#cb50-1278"></a><span class="fu">plot</span>(cases <span class="sc">~</span> biweek, <span class="at">data =</span> <span class="fu">subset</span>(niamey, site <span class="sc">==</span> <span class="dv">1</span>), <span class="at">type =</span> <span class="st">'p'</span>, <span class="at">pch =</span> <span class="dv">21</span>) <span class="co">#plot site 1</span></span>
<span id="cb50-1279"><a href="#cb50-1279"></a>t <span class="ot">&lt;-</span> <span class="fu">subset</span>(niamey, site <span class="sc">==</span> <span class="dv">1</span>)[, <span class="dv">1</span>] <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-1280"><a href="#cb50-1280"></a>mod.pred.g1 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ode</span>(</span>
<span id="cb50-1281"><a href="#cb50-1281"></a>  <span class="fu">c</span>(<span class="at">X =</span> <span class="fu">exp</span>(fit1.g<span class="sc">$</span>par[<span class="dv">2</span>]), <span class="at">Y =</span> <span class="fu">exp</span>(fit1.g<span class="sc">$</span>par[<span class="dv">3</span>])),</span>
<span id="cb50-1282"><a href="#cb50-1282"></a>  <span class="at">times =</span> t,</span>
<span id="cb50-1283"><a href="#cb50-1283"></a>  closed.sir.model.g,</span>
<span id="cb50-1284"><a href="#cb50-1284"></a>  <span class="fu">c</span>(<span class="fu">exp</span>(fit1.g<span class="sc">$</span>par[<span class="dv">1</span>]), <span class="fu">exp</span>(fit1.g<span class="sc">$</span>par[<span class="dv">4</span>])),</span>
<span id="cb50-1285"><a href="#cb50-1285"></a>  <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb50-1286"><a href="#cb50-1286"></a>))</span>
<span id="cb50-1287"><a href="#cb50-1287"></a><span class="co">#obtain model predictions</span></span>
<span id="cb50-1288"><a href="#cb50-1288"></a><span class="fu">lines</span>(mod.pred.g1<span class="sc">$</span>Y <span class="sc">~</span> <span class="fu">subset</span>(niamey, site <span class="sc">==</span> <span class="dv">1</span>)[, <span class="dv">1</span>]) <span class="co">#and plot as a line</span></span>
<span id="cb50-1289"><a href="#cb50-1289"></a></span>
<span id="cb50-1290"><a href="#cb50-1290"></a><span class="fu">plot</span>(cases <span class="sc">~</span> biweek, <span class="at">data =</span> <span class="fu">subset</span>(niamey, site <span class="sc">==</span> <span class="dv">2</span>), <span class="at">type =</span> <span class="st">'b'</span>, <span class="at">col =</span> site) <span class="co">#site 2</span></span>
<span id="cb50-1291"><a href="#cb50-1291"></a>t <span class="ot">&lt;-</span> <span class="fu">subset</span>(niamey, site <span class="sc">==</span> <span class="dv">2</span>)[, <span class="dv">1</span>] <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-1292"><a href="#cb50-1292"></a>mod.pred.g2 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ode</span>(</span>
<span id="cb50-1293"><a href="#cb50-1293"></a>  <span class="fu">c</span>(<span class="at">X =</span> <span class="fu">exp</span>(fit2.g<span class="sc">$</span>par[<span class="dv">2</span>]), <span class="at">Y =</span> <span class="fu">exp</span>(fit2.g<span class="sc">$</span>par[<span class="dv">3</span>])),</span>
<span id="cb50-1294"><a href="#cb50-1294"></a>  <span class="at">times =</span> t,</span>
<span id="cb50-1295"><a href="#cb50-1295"></a>  closed.sir.model.g,</span>
<span id="cb50-1296"><a href="#cb50-1296"></a>  <span class="fu">c</span>(<span class="fu">exp</span>(fit2.g<span class="sc">$</span>par[<span class="dv">1</span>]), <span class="fu">exp</span>(fit2.g<span class="sc">$</span>par[<span class="dv">4</span>])),</span>
<span id="cb50-1297"><a href="#cb50-1297"></a>  <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb50-1298"><a href="#cb50-1298"></a>))</span>
<span id="cb50-1299"><a href="#cb50-1299"></a><span class="co">#obtain model predictions</span></span>
<span id="cb50-1300"><a href="#cb50-1300"></a><span class="fu">lines</span>(mod.pred.g2<span class="sc">$</span>Y <span class="sc">~</span> <span class="fu">subset</span>(niamey, site <span class="sc">==</span> <span class="dv">2</span>)[, <span class="dv">1</span>]) <span class="co">#and plot as a line</span></span>
<span id="cb50-1301"><a href="#cb50-1301"></a></span>
<span id="cb50-1302"><a href="#cb50-1302"></a><span class="fu">plot</span>(cases <span class="sc">~</span> biweek, <span class="at">data =</span> <span class="fu">subset</span>(niamey, site <span class="sc">==</span> <span class="dv">3</span>), <span class="at">type =</span> <span class="st">'b'</span>, <span class="at">col =</span> site) <span class="co">#site 3</span></span>
<span id="cb50-1303"><a href="#cb50-1303"></a>t <span class="ot">&lt;-</span> <span class="fu">subset</span>(niamey, site <span class="sc">==</span> <span class="dv">3</span>)[, <span class="dv">1</span>] <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-1304"><a href="#cb50-1304"></a>mod.pred.g3 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ode</span>(</span>
<span id="cb50-1305"><a href="#cb50-1305"></a>  <span class="fu">c</span>(<span class="at">X =</span> <span class="fu">exp</span>(fit3.g<span class="sc">$</span>par[<span class="dv">2</span>]), <span class="at">Y =</span> <span class="fu">exp</span>(fit3.g<span class="sc">$</span>par[<span class="dv">3</span>])),</span>
<span id="cb50-1306"><a href="#cb50-1306"></a>  <span class="at">times =</span> t,</span>
<span id="cb50-1307"><a href="#cb50-1307"></a>  closed.sir.model.g,</span>
<span id="cb50-1308"><a href="#cb50-1308"></a>  <span class="fu">c</span>(<span class="fu">exp</span>(fit3.g<span class="sc">$</span>par[<span class="dv">1</span>]), <span class="fu">exp</span>(fit3.g<span class="sc">$</span>par[<span class="dv">4</span>])),</span>
<span id="cb50-1309"><a href="#cb50-1309"></a>  <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb50-1310"><a href="#cb50-1310"></a>))</span>
<span id="cb50-1311"><a href="#cb50-1311"></a><span class="fu">lines</span>(mod.pred.g3<span class="sc">$</span>Y <span class="sc">~</span> <span class="fu">subset</span>(niamey, site <span class="sc">==</span> <span class="dv">3</span>)[, <span class="dv">1</span>])</span>
<span id="cb50-1312"><a href="#cb50-1312"></a><span class="in">```</span></span>
<span id="cb50-1313"><a href="#cb50-1313"></a></span>
<span id="cb50-1314"><a href="#cb50-1314"></a><span class="fu">### Exercise 6</span></span>
<span id="cb50-1315"><a href="#cb50-1315"></a></span>
<span id="cb50-1316"><a href="#cb50-1316"></a>What happens if one or both of the other unknowns ($X_0$ and $Y_0$) is fixed instead of $\gamma$?</span>
<span id="cb50-1317"><a href="#cb50-1317"></a></span>
<span id="cb50-1318"><a href="#cb50-1318"></a><span class="fu">#### Solutions coming soon!</span></span>
<span id="cb50-1319"><a href="#cb50-1319"></a></span>
<span id="cb50-1320"><a href="#cb50-1320"></a>First we modify the <span class="in">`sse_sir_g`</span> function again to fix $X_0$ and $Y_0$ (or both)</span>
<span id="cb50-1321"><a href="#cb50-1321"></a></span>
<span id="cb50-1324"><a href="#cb50-1324"></a><span class="in">```{r}</span></span>
<span id="cb50-1325"><a href="#cb50-1325"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-1326"><a href="#cb50-1326"></a><span class="co">#| echo: false</span></span>
<span id="cb50-1327"><a href="#cb50-1327"></a><span class="co">#| eval: false</span></span>
<span id="cb50-1328"><a href="#cb50-1328"></a><span class="co"># fix S0</span></span>
<span id="cb50-1329"><a href="#cb50-1329"></a>sse_sir_S0 <span class="ot">&lt;-</span> <span class="cf">function</span>(params, data) {</span>
<span id="cb50-1330"><a href="#cb50-1330"></a>  <span class="co"># Convert biweekly time series into annual time scale</span></span>
<span id="cb50-1331"><a href="#cb50-1331"></a>  <span class="co"># Daily time scale has requires beta values to be too small - doesn't</span></span>
<span id="cb50-1332"><a href="#cb50-1332"></a>  <span class="co"># optimize well</span></span>
<span id="cb50-1333"><a href="#cb50-1333"></a>  dt <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb50-1334"><a href="#cb50-1334"></a>  max_biweek <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>biweek)</span>
<span id="cb50-1335"><a href="#cb50-1335"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_biweek <span class="sc">*</span> <span class="dv">14</span>, dt) <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-1336"><a href="#cb50-1336"></a></span>
<span id="cb50-1337"><a href="#cb50-1337"></a>  <span class="co"># Extract the number of observed incidence</span></span>
<span id="cb50-1338"><a href="#cb50-1338"></a>  obs_inc <span class="ot">&lt;-</span> data<span class="sc">$</span>cases</span>
<span id="cb50-1339"><a href="#cb50-1339"></a></span>
<span id="cb50-1340"><a href="#cb50-1340"></a>  <span class="co"># Note the parameters are updated throughout the optimization process by</span></span>
<span id="cb50-1341"><a href="#cb50-1341"></a>  <span class="co"># the optim() function</span></span>
<span id="cb50-1342"><a href="#cb50-1342"></a>  <span class="co"># Unpack the transmission parameter and exponentiate to fit on ln scale</span></span>
<span id="cb50-1343"><a href="#cb50-1343"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"beta"</span>]])</span>
<span id="cb50-1344"><a href="#cb50-1344"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"gamma"</span>]])</span>
<span id="cb50-1345"><a href="#cb50-1345"></a></span>
<span id="cb50-1346"><a href="#cb50-1346"></a>  in_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"beta"</span> <span class="ot">=</span> beta, <span class="st">"gamma"</span> <span class="ot">=</span> gamma)</span>
<span id="cb50-1347"><a href="#cb50-1347"></a>  <span class="co"># Unpack the initial states and exponentiate to fit on normal scale</span></span>
<span id="cb50-1348"><a href="#cb50-1348"></a>  S_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="dv">12500</span>) <span class="co">#initial susceptibles (FIXED)</span></span>
<span id="cb50-1349"><a href="#cb50-1349"></a>  I_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"I_init"</span>]])</span>
<span id="cb50-1350"><a href="#cb50-1350"></a></span>
<span id="cb50-1351"><a href="#cb50-1351"></a>  <span class="co"># Fit SIR model to the parameters</span></span>
<span id="cb50-1352"><a href="#cb50-1352"></a>  sol <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb50-1353"><a href="#cb50-1353"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb50-1354"><a href="#cb50-1354"></a>    <span class="at">times =</span> t,</span>
<span id="cb50-1355"><a href="#cb50-1355"></a>    <span class="at">func =</span> closed_sir_model_g,</span>
<span id="cb50-1356"><a href="#cb50-1356"></a>    <span class="at">parms =</span> in_parms,</span>
<span id="cb50-1357"><a href="#cb50-1357"></a>    <span class="co"># Use rk4 as fixed time steps, which is important for indexing</span></span>
<span id="cb50-1358"><a href="#cb50-1358"></a>    <span class="at">method =</span> <span class="st">"rk4"</span></span>
<span id="cb50-1359"><a href="#cb50-1359"></a>  )</span>
<span id="cb50-1360"><a href="#cb50-1360"></a></span>
<span id="cb50-1361"><a href="#cb50-1361"></a>  <span class="co"># Extract the cumulative incidence</span></span>
<span id="cb50-1362"><a href="#cb50-1362"></a>  cum_inc <span class="ot">&lt;-</span> sol[, <span class="st">"new_inf"</span>]</span>
<span id="cb50-1363"><a href="#cb50-1363"></a></span>
<span id="cb50-1364"><a href="#cb50-1364"></a>  <span class="co"># Find the indices of the cumulative incidence to extract</span></span>
<span id="cb50-1365"><a href="#cb50-1365"></a>  biweek_index <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, max_biweek) <span class="sc">*</span> (<span class="dv">14</span> <span class="sc">/</span> dt) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb50-1366"><a href="#cb50-1366"></a></span>
<span id="cb50-1367"><a href="#cb50-1367"></a>  <span class="co"># Index cumulative incidence to get the values at the end of the biweeks</span></span>
<span id="cb50-1368"><a href="#cb50-1368"></a>  biweek_cum_inc <span class="ot">&lt;-</span> cum_inc[biweek_index]</span>
<span id="cb50-1369"><a href="#cb50-1369"></a></span>
<span id="cb50-1370"><a href="#cb50-1370"></a>  <span class="co"># Calculate the biweekly incidence by using the difference between</span></span>
<span id="cb50-1371"><a href="#cb50-1371"></a>  <span class="co"># consecutive biweeks. Need to manually prepend first week's incidence</span></span>
<span id="cb50-1372"><a href="#cb50-1372"></a>  <span class="co"># and add in the initial number of infectious individuals, as ODE model</span></span>
<span id="cb50-1373"><a href="#cb50-1373"></a>  <span class="co"># only returns the cumulative differences, which is 0 at the start.</span></span>
<span id="cb50-1374"><a href="#cb50-1374"></a>  biweek_inc <span class="ot">&lt;-</span> <span class="fu">c</span>(biweek_cum_inc[<span class="dv">1</span>] <span class="sc">+</span> I_init, <span class="fu">diff</span>(biweek_cum_inc, <span class="at">lag =</span> <span class="dv">1</span>))</span>
<span id="cb50-1375"><a href="#cb50-1375"></a></span>
<span id="cb50-1376"><a href="#cb50-1376"></a>  <span class="co"># return SSE of predicted vs observed incidence</span></span>
<span id="cb50-1377"><a href="#cb50-1377"></a>  <span class="fu">return</span>(<span class="fu">sum</span>((biweek_inc <span class="sc">-</span> obs_inc)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb50-1378"><a href="#cb50-1378"></a>}</span>
<span id="cb50-1379"><a href="#cb50-1379"></a></span>
<span id="cb50-1380"><a href="#cb50-1380"></a><span class="co">#fix I0</span></span>
<span id="cb50-1381"><a href="#cb50-1381"></a>sse_sir_I0 <span class="ot">&lt;-</span> <span class="cf">function</span>(params, data) {</span>
<span id="cb50-1382"><a href="#cb50-1382"></a>  <span class="co"># Convert biweekly time series into annual time scale</span></span>
<span id="cb50-1383"><a href="#cb50-1383"></a>  <span class="co"># Daily time scale has requires beta values to be too small - doesn't</span></span>
<span id="cb50-1384"><a href="#cb50-1384"></a>  <span class="co"># optimize well</span></span>
<span id="cb50-1385"><a href="#cb50-1385"></a>  dt <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb50-1386"><a href="#cb50-1386"></a>  max_biweek <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>biweek)</span>
<span id="cb50-1387"><a href="#cb50-1387"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_biweek <span class="sc">*</span> <span class="dv">14</span>, dt) <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-1388"><a href="#cb50-1388"></a></span>
<span id="cb50-1389"><a href="#cb50-1389"></a>  <span class="co"># Extract the number of observed incidence</span></span>
<span id="cb50-1390"><a href="#cb50-1390"></a>  obs_inc <span class="ot">&lt;-</span> data<span class="sc">$</span>cases</span>
<span id="cb50-1391"><a href="#cb50-1391"></a></span>
<span id="cb50-1392"><a href="#cb50-1392"></a>  <span class="co"># Note the parameters are updated throughout the optimization process by</span></span>
<span id="cb50-1393"><a href="#cb50-1393"></a>  <span class="co"># the optim() function</span></span>
<span id="cb50-1394"><a href="#cb50-1394"></a>  <span class="co"># Unpack the transmission parameter and exponentiate to fit on ln scale</span></span>
<span id="cb50-1395"><a href="#cb50-1395"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"beta"</span>]])</span>
<span id="cb50-1396"><a href="#cb50-1396"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"gamma"</span>]])</span>
<span id="cb50-1397"><a href="#cb50-1397"></a></span>
<span id="cb50-1398"><a href="#cb50-1398"></a>  in_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"beta"</span> <span class="ot">=</span> beta, <span class="st">"gamma"</span> <span class="ot">=</span> gamma)</span>
<span id="cb50-1399"><a href="#cb50-1399"></a>  <span class="co"># Unpack the initial states and exponentiate to fit on normal scale</span></span>
<span id="cb50-1400"><a href="#cb50-1400"></a>  S_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"S_init"</span>]])</span>
<span id="cb50-1401"><a href="#cb50-1401"></a>  I_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="dv">1000</span>) <span class="co"># initial infecteds (FIXED)</span></span>
<span id="cb50-1402"><a href="#cb50-1402"></a></span>
<span id="cb50-1403"><a href="#cb50-1403"></a>  <span class="co"># Fit SIR model to the parameters</span></span>
<span id="cb50-1404"><a href="#cb50-1404"></a>  sol <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb50-1405"><a href="#cb50-1405"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> S_init, <span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb50-1406"><a href="#cb50-1406"></a>    <span class="at">times =</span> t,</span>
<span id="cb50-1407"><a href="#cb50-1407"></a>    <span class="at">func =</span> closed_sir_model_g,</span>
<span id="cb50-1408"><a href="#cb50-1408"></a>    <span class="at">parms =</span> in_parms,</span>
<span id="cb50-1409"><a href="#cb50-1409"></a>    <span class="co"># Use rk4 as fixed time steps, which is important for indexing</span></span>
<span id="cb50-1410"><a href="#cb50-1410"></a>    <span class="at">method =</span> <span class="st">"rk4"</span></span>
<span id="cb50-1411"><a href="#cb50-1411"></a>  )</span>
<span id="cb50-1412"><a href="#cb50-1412"></a></span>
<span id="cb50-1413"><a href="#cb50-1413"></a>  <span class="co"># Extract the cumulative incidence</span></span>
<span id="cb50-1414"><a href="#cb50-1414"></a>  cum_inc <span class="ot">&lt;-</span> sol[, <span class="st">"new_inf"</span>]</span>
<span id="cb50-1415"><a href="#cb50-1415"></a></span>
<span id="cb50-1416"><a href="#cb50-1416"></a>  <span class="co"># Find the indices of the cumulative incidence to extract</span></span>
<span id="cb50-1417"><a href="#cb50-1417"></a>  biweek_index <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, max_biweek) <span class="sc">*</span> (<span class="dv">14</span> <span class="sc">/</span> dt) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb50-1418"><a href="#cb50-1418"></a></span>
<span id="cb50-1419"><a href="#cb50-1419"></a>  <span class="co"># Index cumulative incidence to get the values at the end of the biweeks</span></span>
<span id="cb50-1420"><a href="#cb50-1420"></a>  biweek_cum_inc <span class="ot">&lt;-</span> cum_inc[biweek_index]</span>
<span id="cb50-1421"><a href="#cb50-1421"></a></span>
<span id="cb50-1422"><a href="#cb50-1422"></a>  <span class="co"># Calculate the biweekly incidence by using the difference between</span></span>
<span id="cb50-1423"><a href="#cb50-1423"></a>  <span class="co"># consecutive biweeks. Need to manually prepend first week's incidence</span></span>
<span id="cb50-1424"><a href="#cb50-1424"></a>  <span class="co"># and add in the initial number of infectious individuals, as ODE model</span></span>
<span id="cb50-1425"><a href="#cb50-1425"></a>  <span class="co"># only returns the cumulative differences, which is 0 at the start.</span></span>
<span id="cb50-1426"><a href="#cb50-1426"></a>  biweek_inc <span class="ot">&lt;-</span> <span class="fu">c</span>(biweek_cum_inc[<span class="dv">1</span>] <span class="sc">+</span> I_init, <span class="fu">diff</span>(biweek_cum_inc, <span class="at">lag =</span> <span class="dv">1</span>))</span>
<span id="cb50-1427"><a href="#cb50-1427"></a></span>
<span id="cb50-1428"><a href="#cb50-1428"></a>  <span class="co"># return SSE of predicted vs observed incidence</span></span>
<span id="cb50-1429"><a href="#cb50-1429"></a>  <span class="fu">return</span>(<span class="fu">sum</span>((biweek_inc <span class="sc">-</span> obs_inc)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb50-1430"><a href="#cb50-1430"></a>}</span>
<span id="cb50-1431"><a href="#cb50-1431"></a></span>
<span id="cb50-1432"><a href="#cb50-1432"></a><span class="co"># fix S0 and I0</span></span>
<span id="cb50-1433"><a href="#cb50-1433"></a>sse_sir_S0_I0 <span class="ot">&lt;-</span> <span class="cf">function</span>(params, data) {</span>
<span id="cb50-1434"><a href="#cb50-1434"></a>  <span class="co"># Convert biweekly time series into annual time scale</span></span>
<span id="cb50-1435"><a href="#cb50-1435"></a>  <span class="co"># Daily time scale has requires beta values to be too small - doesn't</span></span>
<span id="cb50-1436"><a href="#cb50-1436"></a>  <span class="co"># optimize well</span></span>
<span id="cb50-1437"><a href="#cb50-1437"></a>  dt <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb50-1438"><a href="#cb50-1438"></a>  max_biweek <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>biweek)</span>
<span id="cb50-1439"><a href="#cb50-1439"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_biweek <span class="sc">*</span> <span class="dv">14</span>, dt) <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb50-1440"><a href="#cb50-1440"></a></span>
<span id="cb50-1441"><a href="#cb50-1441"></a>  <span class="co"># Extract the number of observed incidence</span></span>
<span id="cb50-1442"><a href="#cb50-1442"></a>  obs_inc <span class="ot">&lt;-</span> data<span class="sc">$</span>cases</span>
<span id="cb50-1443"><a href="#cb50-1443"></a></span>
<span id="cb50-1444"><a href="#cb50-1444"></a>  <span class="co"># Note the parameters are updated throughout the optimization process by</span></span>
<span id="cb50-1445"><a href="#cb50-1445"></a>  <span class="co"># the optim() function</span></span>
<span id="cb50-1446"><a href="#cb50-1446"></a>  <span class="co"># Unpack the transmission parameter and exponentiate to fit on ln scale</span></span>
<span id="cb50-1447"><a href="#cb50-1447"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"beta"</span>]])</span>
<span id="cb50-1448"><a href="#cb50-1448"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">exp</span>(params[[<span class="st">"gamma"</span>]])</span>
<span id="cb50-1449"><a href="#cb50-1449"></a></span>
<span id="cb50-1450"><a href="#cb50-1450"></a>  in_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"beta"</span> <span class="ot">=</span> beta, <span class="st">"gamma"</span> <span class="ot">=</span> gamma)</span>
<span id="cb50-1451"><a href="#cb50-1451"></a>  <span class="co"># Unpack the initial states and exponentiate to fit on normal scale</span></span>
<span id="cb50-1452"><a href="#cb50-1452"></a>  S_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="dv">12500</span>) <span class="co"># initial susceptibles (FIXED)</span></span>
<span id="cb50-1453"><a href="#cb50-1453"></a>  I_init <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="dv">1000</span>) <span class="co"># initial infecteds (FIXED)</span></span>
<span id="cb50-1454"><a href="#cb50-1454"></a></span>
<span id="cb50-1455"><a href="#cb50-1455"></a>  <span class="co"># Fit SIR model to the parameters</span></span>
<span id="cb50-1456"><a href="#cb50-1456"></a>  sol <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb50-1457"><a href="#cb50-1457"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> S_init, <span class="at">I =</span> I_init, <span class="at">new_inf =</span> <span class="dv">0</span>),</span>
<span id="cb50-1458"><a href="#cb50-1458"></a>    <span class="at">times =</span> t,</span>
<span id="cb50-1459"><a href="#cb50-1459"></a>    <span class="at">func =</span> closed_sir_model_g,</span>
<span id="cb50-1460"><a href="#cb50-1460"></a>    <span class="at">parms =</span> in_parms,</span>
<span id="cb50-1461"><a href="#cb50-1461"></a>    <span class="co"># Use rk4 as fixed time steps, which is important for indexing</span></span>
<span id="cb50-1462"><a href="#cb50-1462"></a>    <span class="at">method =</span> <span class="st">"rk4"</span></span>
<span id="cb50-1463"><a href="#cb50-1463"></a>  )</span>
<span id="cb50-1464"><a href="#cb50-1464"></a></span>
<span id="cb50-1465"><a href="#cb50-1465"></a>  <span class="co"># Extract the cumulative incidence</span></span>
<span id="cb50-1466"><a href="#cb50-1466"></a>  cum_inc <span class="ot">&lt;-</span> sol[, <span class="st">"new_inf"</span>]</span>
<span id="cb50-1467"><a href="#cb50-1467"></a></span>
<span id="cb50-1468"><a href="#cb50-1468"></a>  <span class="co"># Find the indices of the cumulative incidence to extract</span></span>
<span id="cb50-1469"><a href="#cb50-1469"></a>  biweek_index <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, max_biweek) <span class="sc">*</span> (<span class="dv">14</span> <span class="sc">/</span> dt) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb50-1470"><a href="#cb50-1470"></a></span>
<span id="cb50-1471"><a href="#cb50-1471"></a>  <span class="co"># Index cumulative incidence to get the values at the end of the biweeks</span></span>
<span id="cb50-1472"><a href="#cb50-1472"></a>  biweek_cum_inc <span class="ot">&lt;-</span> cum_inc[biweek_index]</span>
<span id="cb50-1473"><a href="#cb50-1473"></a></span>
<span id="cb50-1474"><a href="#cb50-1474"></a>  <span class="co"># Calculate the biweekly incidence by using the difference between</span></span>
<span id="cb50-1475"><a href="#cb50-1475"></a>  <span class="co"># consecutive biweeks. Need to manually prepend first week's incidence</span></span>
<span id="cb50-1476"><a href="#cb50-1476"></a>  <span class="co"># and add in the initial number of infectious individuals, as ODE model</span></span>
<span id="cb50-1477"><a href="#cb50-1477"></a>  <span class="co"># only returns the cumulative differences, which is 0 at the start.</span></span>
<span id="cb50-1478"><a href="#cb50-1478"></a>  biweek_inc <span class="ot">&lt;-</span> <span class="fu">c</span>(biweek_cum_inc[<span class="dv">1</span>] <span class="sc">+</span> I_init, <span class="fu">diff</span>(biweek_cum_inc, <span class="at">lag =</span> <span class="dv">1</span>))</span>
<span id="cb50-1479"><a href="#cb50-1479"></a></span>
<span id="cb50-1480"><a href="#cb50-1480"></a>  <span class="co"># return SSE of predicted vs observed incidence</span></span>
<span id="cb50-1481"><a href="#cb50-1481"></a>  <span class="fu">return</span>(<span class="fu">sum</span>((biweek_inc <span class="sc">-</span> obs_inc)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb50-1482"><a href="#cb50-1482"></a>}</span>
<span id="cb50-1483"><a href="#cb50-1483"></a><span class="in">```</span></span>
<span id="cb50-1484"><a href="#cb50-1484"></a></span>
<span id="cb50-1485"><a href="#cb50-1485"></a>Now we can run the optim algorithm and find the best parameters for the SIR model for each of the scenario.</span>
<span id="cb50-1486"><a href="#cb50-1486"></a></span>
<span id="cb50-1487"><a href="#cb50-1487"></a>First, for S0 fixed:</span>
<span id="cb50-1488"><a href="#cb50-1488"></a></span>
<span id="cb50-1491"><a href="#cb50-1491"></a><span class="in">```{r}</span></span>
<span id="cb50-1492"><a href="#cb50-1492"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-1493"><a href="#cb50-1493"></a><span class="co">#| echo: false</span></span>
<span id="cb50-1494"><a href="#cb50-1494"></a><span class="co">#| eval: false</span></span>
<span id="cb50-1495"><a href="#cb50-1495"></a>sse_optim_params_S0 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb50-1496"><a href="#cb50-1496"></a>  <span class="at">beta =</span> <span class="fu">log</span>(<span class="fl">0.055</span>),</span>
<span id="cb50-1497"><a href="#cb50-1497"></a>  <span class="at">gamma =</span> <span class="fu">log</span>(<span class="dv">365</span> <span class="sc">/</span> <span class="dv">14</span>),</span>
<span id="cb50-1498"><a href="#cb50-1498"></a>  <span class="at">I_init =</span> <span class="fu">log</span>(<span class="dv">1</span>)</span>
<span id="cb50-1499"><a href="#cb50-1499"></a>)</span>
<span id="cb50-1500"><a href="#cb50-1500"></a></span>
<span id="cb50-1501"><a href="#cb50-1501"></a><span class="co"># Create a dataframe of optimized parameters</span></span>
<span id="cb50-1502"><a href="#cb50-1502"></a>niamey_optims_S0 <span class="ot">&lt;-</span> niamey_df <span class="sc">%&gt;%</span></span>
<span id="cb50-1503"><a href="#cb50-1503"></a>  <span class="co"># Create a nested dataframe i.e. one row for each site, and the data column</span></span>
<span id="cb50-1504"><a href="#cb50-1504"></a>  <span class="co"># now is a list column that contains a separate dataframe of times and</span></span>
<span id="cb50-1505"><a href="#cb50-1505"></a>  <span class="co"># cases for each site</span></span>
<span id="cb50-1506"><a href="#cb50-1506"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>site) <span class="sc">%&gt;%</span></span>
<span id="cb50-1507"><a href="#cb50-1507"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-1508"><a href="#cb50-1508"></a>    <span class="co"># Map the optim() function call to each of the separate dataframes</span></span>
<span id="cb50-1509"><a href="#cb50-1509"></a>    <span class="co"># stored in the nested data column we just created</span></span>
<span id="cb50-1510"><a href="#cb50-1510"></a>    <span class="at">fit =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">optim</span>(sse_optim_params_S0, sse_sir_S0, <span class="at">data =</span> .x)),</span>
<span id="cb50-1511"><a href="#cb50-1511"></a>    <span class="co"># Map the exp() function to each of the model fits just created, and</span></span>
<span id="cb50-1512"><a href="#cb50-1512"></a>    <span class="co"># output to a dataframe instead of a list (like in map()), for easier</span></span>
<span id="cb50-1513"><a href="#cb50-1513"></a>    <span class="co"># use in the plottinge predictions later</span></span>
<span id="cb50-1514"><a href="#cb50-1514"></a>    <span class="fu">map_dfr</span>(fit, <span class="sc">~</span> <span class="fu">exp</span>(.x<span class="sc">$</span>par))</span>
<span id="cb50-1515"><a href="#cb50-1515"></a>  )</span>
<span id="cb50-1516"><a href="#cb50-1516"></a><span class="in">```</span></span>
<span id="cb50-1517"><a href="#cb50-1517"></a></span>
<span id="cb50-1518"><a href="#cb50-1518"></a>Second, for I0 fixed:</span>
<span id="cb50-1519"><a href="#cb50-1519"></a></span>
<span id="cb50-1522"><a href="#cb50-1522"></a><span class="in">```{r}</span></span>
<span id="cb50-1523"><a href="#cb50-1523"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-1524"><a href="#cb50-1524"></a><span class="co">#| echo: false</span></span>
<span id="cb50-1525"><a href="#cb50-1525"></a><span class="co">#| eval: false</span></span>
<span id="cb50-1526"><a href="#cb50-1526"></a>sse_optim_params_I0 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb50-1527"><a href="#cb50-1527"></a>  <span class="at">beta =</span> <span class="fu">log</span>(<span class="fl">0.055</span>),</span>
<span id="cb50-1528"><a href="#cb50-1528"></a>  <span class="at">gamma =</span> <span class="fu">log</span>(<span class="dv">365</span> <span class="sc">/</span> <span class="dv">14</span>),</span>
<span id="cb50-1529"><a href="#cb50-1529"></a>  <span class="at">S_init =</span> <span class="fu">log</span>(<span class="dv">5000</span>),</span>
<span id="cb50-1530"><a href="#cb50-1530"></a>  <span class="at">I_init =</span> <span class="fu">log</span>(<span class="dv">1</span>)</span>
<span id="cb50-1531"><a href="#cb50-1531"></a>)</span>
<span id="cb50-1532"><a href="#cb50-1532"></a></span>
<span id="cb50-1533"><a href="#cb50-1533"></a><span class="co"># Create a dataframe of optimized parameters</span></span>
<span id="cb50-1534"><a href="#cb50-1534"></a>niamey_optims_I0 <span class="ot">&lt;-</span> niamey_df <span class="sc">%&gt;%</span></span>
<span id="cb50-1535"><a href="#cb50-1535"></a>  <span class="co"># Create a nested dataframe i.e. one row for each site, and the data column</span></span>
<span id="cb50-1536"><a href="#cb50-1536"></a>  <span class="co"># now is a list column that contains a separate dataframe of times and</span></span>
<span id="cb50-1537"><a href="#cb50-1537"></a>  <span class="co"># cases for each site</span></span>
<span id="cb50-1538"><a href="#cb50-1538"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>site) <span class="sc">%&gt;%</span></span>
<span id="cb50-1539"><a href="#cb50-1539"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-1540"><a href="#cb50-1540"></a>    <span class="co"># Map the optim() function call to each of the separate dataframes</span></span>
<span id="cb50-1541"><a href="#cb50-1541"></a>    <span class="co"># stored in the nested data column we just created</span></span>
<span id="cb50-1542"><a href="#cb50-1542"></a>    <span class="at">fit =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">optim</span>(sse_optim_params_I0, sse_sir_I0, <span class="at">data =</span> .x)),</span>
<span id="cb50-1543"><a href="#cb50-1543"></a>    <span class="co"># Map the exp() function to each of the model fits just created, and</span></span>
<span id="cb50-1544"><a href="#cb50-1544"></a>    <span class="co"># output to a dataframe instead of a list (like in map()), for easier</span></span>
<span id="cb50-1545"><a href="#cb50-1545"></a>    <span class="co"># use in the plottinge predictions later</span></span>
<span id="cb50-1546"><a href="#cb50-1546"></a>    <span class="fu">map_dfr</span>(fit, <span class="sc">~</span> <span class="fu">exp</span>(.x<span class="sc">$</span>par))</span>
<span id="cb50-1547"><a href="#cb50-1547"></a>  )</span>
<span id="cb50-1548"><a href="#cb50-1548"></a><span class="in">```</span></span>
<span id="cb50-1549"><a href="#cb50-1549"></a></span>
<span id="cb50-1550"><a href="#cb50-1550"></a>Third, for fixing both S0 and I0:</span>
<span id="cb50-1551"><a href="#cb50-1551"></a></span>
<span id="cb50-1554"><a href="#cb50-1554"></a><span class="in">```{r}</span></span>
<span id="cb50-1555"><a href="#cb50-1555"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-1556"><a href="#cb50-1556"></a><span class="co">#| echo: false</span></span>
<span id="cb50-1557"><a href="#cb50-1557"></a><span class="co">#| eval: false</span></span>
<span id="cb50-1558"><a href="#cb50-1558"></a>sse_optim_params_S0_I0 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb50-1559"><a href="#cb50-1559"></a>  <span class="at">beta =</span> <span class="fu">log</span>(<span class="fl">0.055</span>),</span>
<span id="cb50-1560"><a href="#cb50-1560"></a>  <span class="at">gamma =</span> <span class="fu">log</span>(<span class="dv">365</span> <span class="sc">/</span> <span class="dv">14</span>),</span>
<span id="cb50-1561"><a href="#cb50-1561"></a>  <span class="at">S_init =</span> <span class="fu">log</span>(<span class="dv">5000</span>),</span>
<span id="cb50-1562"><a href="#cb50-1562"></a>  <span class="at">I_init =</span> <span class="fu">log</span>(<span class="dv">1</span>)</span>
<span id="cb50-1563"><a href="#cb50-1563"></a>)</span>
<span id="cb50-1564"><a href="#cb50-1564"></a></span>
<span id="cb50-1565"><a href="#cb50-1565"></a><span class="co"># Create a dataframe of optimized parameters</span></span>
<span id="cb50-1566"><a href="#cb50-1566"></a>niamey_optims_S0_I0 <span class="ot">&lt;-</span> niamey_df <span class="sc">%&gt;%</span></span>
<span id="cb50-1567"><a href="#cb50-1567"></a>  <span class="co"># Create a nested dataframe i.e. one row for each site, and the data column</span></span>
<span id="cb50-1568"><a href="#cb50-1568"></a>  <span class="co"># now is a list column that contains a separate dataframe of times and</span></span>
<span id="cb50-1569"><a href="#cb50-1569"></a>  <span class="co"># cases for each site</span></span>
<span id="cb50-1570"><a href="#cb50-1570"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>site) <span class="sc">%&gt;%</span></span>
<span id="cb50-1571"><a href="#cb50-1571"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-1572"><a href="#cb50-1572"></a>    <span class="co"># Map the optim() function call to each of the separate dataframes</span></span>
<span id="cb50-1573"><a href="#cb50-1573"></a>    <span class="co"># stored in the nested data column we just created</span></span>
<span id="cb50-1574"><a href="#cb50-1574"></a>    <span class="at">fit =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">optim</span>(sse_optim_params_S0_I0, sse_sir_S0_I0, <span class="at">data =</span> .x)),</span>
<span id="cb50-1575"><a href="#cb50-1575"></a>    <span class="co"># Map the exp() function to each of the model fits just created, and</span></span>
<span id="cb50-1576"><a href="#cb50-1576"></a>    <span class="co"># output to a dataframe instead of a list (like in map()), for easier</span></span>
<span id="cb50-1577"><a href="#cb50-1577"></a>    <span class="co"># use in the plottinge predictions later</span></span>
<span id="cb50-1578"><a href="#cb50-1578"></a>    <span class="fu">map_dfr</span>(fit, <span class="sc">~</span> <span class="fu">exp</span>(.x<span class="sc">$</span>par))</span>
<span id="cb50-1579"><a href="#cb50-1579"></a>  )</span>
<span id="cb50-1580"><a href="#cb50-1580"></a><span class="in">```</span></span>
<span id="cb50-1581"><a href="#cb50-1581"></a></span>
<span id="cb50-1584"><a href="#cb50-1584"></a><span class="in">```{r}</span></span>
<span id="cb50-1585"><a href="#cb50-1585"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-1586"><a href="#cb50-1586"></a><span class="co">#| echo: false</span></span>
<span id="cb50-1587"><a href="#cb50-1587"></a><span class="co">#| eval: false</span></span>
<span id="cb50-1588"><a href="#cb50-1588"></a>sse.sir.x0 <span class="ot">&lt;-</span> <span class="cf">function</span>(params0, data, site) {</span>
<span id="cb50-1589"><a href="#cb50-1589"></a>  <span class="co">#function to calculate squared errors</span></span>
<span id="cb50-1590"><a href="#cb50-1590"></a>  data <span class="ot">&lt;-</span> data[data<span class="sc">$</span>site <span class="sc">==</span> site, ] <span class="co">#working dataset, based on site</span></span>
<span id="cb50-1591"><a href="#cb50-1591"></a>  t <span class="ot">&lt;-</span> data[, <span class="dv">1</span>] <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span> <span class="co">#time in biweeks</span></span>
<span id="cb50-1592"><a href="#cb50-1592"></a>  cases <span class="ot">&lt;-</span> data[, <span class="dv">3</span>] <span class="co">#number of cases</span></span>
<span id="cb50-1593"><a href="#cb50-1593"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">1</span>]) <span class="co">#parameter beta</span></span>
<span id="cb50-1594"><a href="#cb50-1594"></a>  X0 <span class="ot">&lt;-</span> <span class="dv">12500</span> <span class="co">#initial susceptibles (FIXED)</span></span>
<span id="cb50-1595"><a href="#cb50-1595"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">2</span>]) <span class="co">#initial infected</span></span>
<span id="cb50-1596"><a href="#cb50-1596"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">3</span>])</span>
<span id="cb50-1597"><a href="#cb50-1597"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ode</span>(</span>
<span id="cb50-1598"><a href="#cb50-1598"></a>    <span class="fu">c</span>(<span class="at">X =</span> X0, <span class="at">Y =</span> Y0),</span>
<span id="cb50-1599"><a href="#cb50-1599"></a>    <span class="at">times =</span> t,</span>
<span id="cb50-1600"><a href="#cb50-1600"></a>    closed.sir.model.g,</span>
<span id="cb50-1601"><a href="#cb50-1601"></a>    <span class="fu">c</span>(beta, gamma),</span>
<span id="cb50-1602"><a href="#cb50-1602"></a>    <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb50-1603"><a href="#cb50-1603"></a>  ))</span>
<span id="cb50-1604"><a href="#cb50-1604"></a>  <span class="fu">sum</span>((out<span class="sc">$</span>Y <span class="sc">-</span> cases)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#sum of squared errors that is returned to the optim function</span></span>
<span id="cb50-1605"><a href="#cb50-1605"></a>}</span>
<span id="cb50-1606"><a href="#cb50-1606"></a></span>
<span id="cb50-1607"><a href="#cb50-1607"></a></span>
<span id="cb50-1608"><a href="#cb50-1608"></a>sse.sir.y0 <span class="ot">&lt;-</span> <span class="cf">function</span>(params0, data, site) {</span>
<span id="cb50-1609"><a href="#cb50-1609"></a>  <span class="co">#function to calculate squared errors</span></span>
<span id="cb50-1610"><a href="#cb50-1610"></a>  data <span class="ot">&lt;-</span> data[data<span class="sc">$</span>site <span class="sc">==</span> site, ] <span class="co">#working dataset, based on site</span></span>
<span id="cb50-1611"><a href="#cb50-1611"></a>  t <span class="ot">&lt;-</span> data[, <span class="dv">1</span>] <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span> <span class="co">#time in biweeks</span></span>
<span id="cb50-1612"><a href="#cb50-1612"></a>  cases <span class="ot">&lt;-</span> data[, <span class="dv">3</span>] <span class="co">#number of cases</span></span>
<span id="cb50-1613"><a href="#cb50-1613"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">1</span>]) <span class="co">#parameter beta</span></span>
<span id="cb50-1614"><a href="#cb50-1614"></a>  X0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">2</span>]) <span class="co">#initial susceptibles (FIXED)</span></span>
<span id="cb50-1615"><a href="#cb50-1615"></a>  Y0 <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co">#initial infected</span></span>
<span id="cb50-1616"><a href="#cb50-1616"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">3</span>])</span>
<span id="cb50-1617"><a href="#cb50-1617"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ode</span>(</span>
<span id="cb50-1618"><a href="#cb50-1618"></a>    <span class="fu">c</span>(<span class="at">X =</span> X0, <span class="at">Y =</span> Y0),</span>
<span id="cb50-1619"><a href="#cb50-1619"></a>    <span class="at">times =</span> t,</span>
<span id="cb50-1620"><a href="#cb50-1620"></a>    closed.sir.model.g,</span>
<span id="cb50-1621"><a href="#cb50-1621"></a>    <span class="fu">c</span>(beta, gamma),</span>
<span id="cb50-1622"><a href="#cb50-1622"></a>    <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb50-1623"><a href="#cb50-1623"></a>  ))</span>
<span id="cb50-1624"><a href="#cb50-1624"></a>  <span class="fu">sum</span>((out<span class="sc">$</span>Y <span class="sc">-</span> cases)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#sum of squared errors that is returned to the optim function</span></span>
<span id="cb50-1625"><a href="#cb50-1625"></a>}</span>
<span id="cb50-1626"><a href="#cb50-1626"></a></span>
<span id="cb50-1627"><a href="#cb50-1627"></a></span>
<span id="cb50-1628"><a href="#cb50-1628"></a>sse.sir.x0y0 <span class="ot">&lt;-</span> <span class="cf">function</span>(params0, data, site) {</span>
<span id="cb50-1629"><a href="#cb50-1629"></a>  <span class="co">#function to calculate squared errors</span></span>
<span id="cb50-1630"><a href="#cb50-1630"></a>  data <span class="ot">&lt;-</span> data[data<span class="sc">$</span>site <span class="sc">==</span> site, ] <span class="co">#working dataset, based on site</span></span>
<span id="cb50-1631"><a href="#cb50-1631"></a>  t <span class="ot">&lt;-</span> data[, <span class="dv">1</span>] <span class="sc">*</span> <span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span> <span class="co">#time in biweeks</span></span>
<span id="cb50-1632"><a href="#cb50-1632"></a>  cases <span class="ot">&lt;-</span> data[, <span class="dv">3</span>] <span class="co">#number of cases</span></span>
<span id="cb50-1633"><a href="#cb50-1633"></a>  beta <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">1</span>]) <span class="co">#parameter beta</span></span>
<span id="cb50-1634"><a href="#cb50-1634"></a>  X0 <span class="ot">&lt;-</span> <span class="dv">12500</span> <span class="co">#initial susceptibles (FIXED)</span></span>
<span id="cb50-1635"><a href="#cb50-1635"></a>  Y0 <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co">#initial infected (FIXED)</span></span>
<span id="cb50-1636"><a href="#cb50-1636"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">exp</span>(params0[<span class="dv">2</span>])</span>
<span id="cb50-1637"><a href="#cb50-1637"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ode</span>(</span>
<span id="cb50-1638"><a href="#cb50-1638"></a>    <span class="fu">c</span>(<span class="at">X =</span> X0, <span class="at">Y =</span> Y0),</span>
<span id="cb50-1639"><a href="#cb50-1639"></a>    <span class="at">times =</span> t,</span>
<span id="cb50-1640"><a href="#cb50-1640"></a>    closed.sir.model.g,</span>
<span id="cb50-1641"><a href="#cb50-1641"></a>    <span class="fu">c</span>(beta, gamma),</span>
<span id="cb50-1642"><a href="#cb50-1642"></a>    <span class="at">hmax =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">120</span></span>
<span id="cb50-1643"><a href="#cb50-1643"></a>  ))</span>
<span id="cb50-1644"><a href="#cb50-1644"></a>  <span class="fu">sum</span>((out<span class="sc">$</span>Y <span class="sc">-</span> cases)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#sum of squared errors that is returned to the optim function</span></span>
<span id="cb50-1645"><a href="#cb50-1645"></a>}</span>
<span id="cb50-1646"><a href="#cb50-1646"></a><span class="in">```</span></span>
<span id="cb50-1647"><a href="#cb50-1647"></a></span>
<span id="cb50-1648"><a href="#cb50-1648"></a>Now let's pass these models through <span class="in">`optim`</span> and fit the models:</span>
<span id="cb50-1649"><a href="#cb50-1649"></a></span>
<span id="cb50-1652"><a href="#cb50-1652"></a><span class="in">```{r}</span></span>
<span id="cb50-1653"><a href="#cb50-1653"></a><span class="co">#| code-fold: true</span></span>
<span id="cb50-1654"><a href="#cb50-1654"></a><span class="co">#| echo: false</span></span>
<span id="cb50-1655"><a href="#cb50-1655"></a><span class="co">#| eval: false</span></span>
<span id="cb50-1656"><a href="#cb50-1656"></a><span class="co"># Fixing X0</span></span>
<span id="cb50-1657"><a href="#cb50-1657"></a>params0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.2</span>, <span class="dv">1</span>, <span class="fu">log</span>(<span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span>)) <span class="co">#initial guess of beta, Y0, and gamma</span></span>
<span id="cb50-1658"><a href="#cb50-1658"></a>fit1.x0 <span class="ot">&lt;-</span> <span class="fu">optim</span>(params0, sse.sir.x0, <span class="at">data =</span> niamey, <span class="at">site =</span> <span class="dv">1</span>, <span class="at">hessian =</span> <span class="cn">TRUE</span>) <span class="co">#fit</span></span>
<span id="cb50-1659"><a href="#cb50-1659"></a><span class="fu">exp</span>(fit1.x0<span class="sc">$</span>par) <span class="co">#back-transform parameters</span></span>
<span id="cb50-1660"><a href="#cb50-1660"></a></span>
<span id="cb50-1661"><a href="#cb50-1661"></a><span class="co">#Fixing Y0</span></span>
<span id="cb50-1662"><a href="#cb50-1662"></a>params0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.2</span>, <span class="dv">3</span>, <span class="fu">log</span>(<span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span>)) <span class="co">#initial guess of beta, X0, and gamma</span></span>
<span id="cb50-1663"><a href="#cb50-1663"></a>fit1.y0 <span class="ot">&lt;-</span> <span class="fu">optim</span>(params0, sse.sir.y0, <span class="at">data =</span> niamey, <span class="at">site =</span> <span class="dv">1</span>, <span class="at">hessian =</span> <span class="cn">TRUE</span>) <span class="co">#fit</span></span>
<span id="cb50-1664"><a href="#cb50-1664"></a><span class="fu">exp</span>(fit1.y0<span class="sc">$</span>par) <span class="co">#back-transform parameters</span></span>
<span id="cb50-1665"><a href="#cb50-1665"></a></span>
<span id="cb50-1666"><a href="#cb50-1666"></a><span class="co">#Fixing X0 and Y0</span></span>
<span id="cb50-1667"><a href="#cb50-1667"></a>params0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.2</span>, <span class="fu">log</span>(<span class="dv">14</span> <span class="sc">/</span> <span class="dv">365</span>)) <span class="co">#initial guess of beta and gamma</span></span>
<span id="cb50-1668"><a href="#cb50-1668"></a>fit1.x0y0 <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb50-1669"><a href="#cb50-1669"></a>  params0,</span>
<span id="cb50-1670"><a href="#cb50-1670"></a>  sse.sir.x0y0,</span>
<span id="cb50-1671"><a href="#cb50-1671"></a>  <span class="at">data =</span> niamey,</span>
<span id="cb50-1672"><a href="#cb50-1672"></a>  <span class="at">site =</span> <span class="dv">1</span>,</span>
<span id="cb50-1673"><a href="#cb50-1673"></a>  <span class="at">hessian =</span> <span class="cn">TRUE</span></span>
<span id="cb50-1674"><a href="#cb50-1674"></a>) <span class="co">#fit</span></span>
<span id="cb50-1675"><a href="#cb50-1675"></a><span class="fu">exp</span>(fit1.x0y0<span class="sc">$</span>par) <span class="co">#back-transform parameters</span></span>
<span id="cb50-1676"><a href="#cb50-1676"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/arnold-c/SISMID-Module-02_2025/edit/main/r-session-03.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer><script src="site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>